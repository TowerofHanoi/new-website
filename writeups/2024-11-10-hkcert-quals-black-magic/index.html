<!DOCTYPE html><html lang="en" data-astro-cid-dxom2xcl> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon-dark.svg" media="(prefers-color-scheme: light)"><link rel="icon" type="image/svg+xml" href="/favicon.svg" media="(prefers-color-scheme: dark)"><meta name="generator" content="Astro v4.16.18"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://localhost:3000/writeups/2024-11-10-hkcert-quals-black-magic/"><!-- Primary Meta Tags --><title>HKCERT Quals 2024 - Black-magic</title><meta name="title" content="HKCERT Quals 2024 - Black-magic"><meta name="description" content="Writeup of Black-magic challenge from HKCERT Quals 2024"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://localhost:3000/writeups/2024-11-10-hkcert-quals-black-magic/"><meta property="og:title" content="HKCERT Quals 2024 - Black-magic"><meta property="og:description" content="Writeup of Black-magic challenge from HKCERT Quals 2024"><meta property="og:image" content="https://localhost:3000/writeups/2024-11-10-hkcert-quals-black-magic/preview.webp"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://localhost:3000/writeups/2024-11-10-hkcert-quals-black-magic/"><meta property="twitter:title" content="HKCERT Quals 2024 - Black-magic"><meta property="twitter:description" content="Writeup of Black-magic challenge from HKCERT Quals 2024"><meta property="twitter:image" content="https://localhost:3000/preview.webp"><style>:root{--accent: #fea819;--accent-dark: #ac7010;--accent-dark-010: #ac70100a}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:#171717 no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:#aaa;font-size:20px;line-height:1.25}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:1em 0 .5rem;color:#fff;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:0 .3em;background-color:#1f1f1f;border-radius:.2em;font-size:.8em}pre{padding:1em;border-radius:.2em}pre>code{all:unset;font-size:.8em}blockquote{border-left:4px solid var(--accent);padding:.01em 0 .01em 1em;margin:0;background-color:var(--accent-dark-010)}hr{border:none;border-top:1px solid #e9e9e9}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}table{border-collapse:collapse;text-align:center}tr{border:1px solid #e9e9e9}th,td{padding:.5em;text-align:center}th{background-color:#1f1f1f;color:#fff}td{background-color:#1b1b1b}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#1f1f1f;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
@media (prefers-color-scheme: dark){.markdown-alert{--color-border-default: #30363d;--color-accent-fg: #58a6ff;--color-accent-emphasis: #1f6feb;--color-danger-fg: #f85149;--color-danger-emphasis: #da3633;--color-attention-fg: #d29922;--color-attention-emphasis: #9e6a03;--color-done-fg: #a371f7;--color-done-emphasis: #8957e5;--color-success-fg: #3fb950;--color-success-emphasis: #238636}}@media (prefers-color-scheme: light){.markdown-alert{--color-border-default: #d0d7de;--color-accent-fg: #0969da;--color-accent-emphasis: #0969da;--color-danger-fg: #d1242f;--color-danger-emphasis: #cf222e;--color-attention-fg: #9a6700;--color-attention-emphasis: #9a6700;--color-done-fg: #8250df;--color-done-emphasis: #8250df;--color-success-fg: #1a7f37;--color-success-emphasis: #1f883d}}.markdown-alert{border-left:.25em solid var(--borderColor-default, var(--color-border-default));color:inherit;margin-bottom:16px;padding:.5rem 1em}.markdown-alert>:last-child{margin-bottom:0!important}.markdown-alert .markdown-alert-title{align-items:center;display:flex;font-size:14px;font-weight:500;line-height:1}.markdown-alert .markdown-alert-title svg.octicon{margin-right:8px!important;margin-right:var(--base-size-8,8px)!important;fill:currentColor}.markdown-alert.markdown-alert-note{border-left-color:var(--borderColor-accent-emphasis,var(--color-accent-emphasis))}.markdown-alert.markdown-alert-note .markdown-alert-title{color:var(--color-accent-fg);color:var(--fgColor-accent,var(--color-accent-fg))}.markdown-alert.markdown-alert-tip{border-left-color:var(--borderColor-success-emphasis,var(--color-success-emphasis))}.markdown-alert.markdown-alert-tip .markdown-alert-title{color:var(--color-success-fg);color:var(--fgColor-success,var(--color-success-fg))}.markdown-alert.markdown-alert-important{border-left-color:var(--borderColor-done-emphasis,var(--color-done-emphasis))}.markdown-alert.markdown-alert-important .markdown-alert-title{color:var(--color-done-fg);color:var(--fgColor-done,var(--color-done-fg))}.markdown-alert.markdown-alert-warning{border-left-color:var(--borderColor-attention-emphasis,var(--color-attention-emphasis))}.markdown-alert.markdown-alert-warning .markdown-alert-title{color:var(--color-attention-fg);color:var(--fgColor-attention,var(--color-attention-fg))}.markdown-alert.markdown-alert-caution{border-left-color:var(--borderColor-danger-emphasis,var(--color-danger-emphasis))}.markdown-alert.markdown-alert-caution .markdown-alert-title{color:var(--color-danger-fg);color:var(--fgColor-danger,var(--color-danger-fg))}main[data-astro-cid-dxom2xcl]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-dxom2xcl]{width:100%}.hero-image[data-astro-cid-dxom2xcl] img[data-astro-cid-dxom2xcl]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-dxom2xcl]{width:75%;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-dxom2xcl]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-dxom2xcl] h1[data-astro-cid-dxom2xcl]{margin:0 0 .5em}.date[data-astro-cid-dxom2xcl]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-dxom2xcl]{font-style:italic}
</style></head> <body data-astro-cid-dxom2xcl> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <a href="/" style="padding: 1rem 0 0 0;" data-astro-cid-3ef6ksr2> <img src="/new_tower_logo.png" alt="Tower of Hanoi Logo" width="50rem" height="50rem" style="border-radius: 0;" data-astro-cid-3ef6ksr2> </a> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blogposts </a>  <a href="/writeups" class="active" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Writeups </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-dxom2xcl> <article data-astro-cid-dxom2xcl> <div class="hero-image" data-astro-cid-dxom2xcl> <img width="720" height="360" src="/writeup_images/hkcert-2024.png" alt="" data-astro-cid-dxom2xcl> </div> <div class="prose" data-astro-cid-dxom2xcl> <div class="title" data-astro-cid-dxom2xcl> <div class="date" data-astro-cid-dxom2xcl> <time datetime="2024-11-10T17:00:00.000Z"> Nov 10, 2024 </time>  </div> <h1 data-astro-cid-dxom2xcl>HKCERT Quals 2024 - Black-magic</h1> <h3 data-astro-cid-dxom2xcl> by Gabriele Digregorio (Io_no), Roberto Alessandro Bertolini (MrIndeciso), and Riccardo Lamarca (Ric)</h3> <hr data-astro-cid-dxom2xcl> </div>  <p><img src="/writeup_files/black-magic/snake-chicken.png" alt="pollo"></p>
<blockquote>
<p>It seems university students often plays Black Magic. It should be the first time tuning (meaning: guessing, telepath, shamanism, mind-reading) for many people.
Many language contains some black magic within. To those python expert: do you really know Python deep within? Time to tune what Python is thinking!</p>
</blockquote>
<h1 id="overview">Overview</h1>
<p>The zip file attached to the challenge contained the following files:</p>
<ul>
<li>A <code>docker-compose.yml</code> of an Alpine image with a specific <code>Python 3.12.5</code> version. The image was hardcoded with a specific hash, likely to ensure repeatable results.</li>
<li>A <code>src</code> folder containing an <code>a.pyc</code> file and a <code>run.sh</code> file that simply executes the <code>a.pyc</code> file using Python.</li>
<li>A <code>README.md</code> file explaining how to run the challenge. It also notes that the challenge behavior might differ on Python versions other than the one specified in the attached Docker.</li>
</ul>
<h3 id="pyc-what">pyc… what?</h3>
<p>If you have some understanding of how the CPython implementation of the Python programming language works, you probably already know what a <code>.pyc</code> file is and can skip this section. For those unfamiliar, here is a brief explanation that will be helpful to understand the rest of the writeup.</p>
<p>To begin, let’s refer to the Python glossary:</p>
<blockquote>
<p>Python is an interpreted language, as opposed to a compiled one, though the distinction can be blurry because of the presence of the bytecode compiler. […]</p>
</blockquote>
<p>As mentioned, Python does indeed support some form of bytecode compilation. To clarify, it’s not the Python language itself that is inherently interpreted or compiled; these characteristics depend on the specific Python implementation. Python, as a language, specifies a set of fundamental elements, such as syntax. These specifications can be implemented in various ways. The most common implementation is CPython, which is so prevalent that it is often synonymous with Python itself.</p>
<p>According to Wikipedia,</p>
<blockquote>
<p>CPython can be defined as both an interpreter and a compiler, as it compiles Python code into bytecode before interpreting it.</p>
</blockquote>
<p>Again, CPython can indeed compile Python code into bytecode.</p>
<p>So, what exactly is a <code>.pyc</code> file? It is a file containing Python bytecode, which has been compiled from Python source code by CPython for optimization reasons.</p>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://docs.python.org/3/glossary.html#term-interpreted">Python Glossary: Interpreted</a></li>
<li><a href="https://docs.python.org/3/glossary.html#term-bytecode">Python Glossary: Bytecode</a></li>
<li><a href="https://stackoverflow.com/questions/2998215/if-python-is-interpreted-what-are-pyc-files">Stack Overflow: If Python is interpreted, what are .pyc files?</a></li>
<li><a href="https://en.wikipedia.org/wiki/Python_(programming_language)#Implementations">Wikipedia: Python (programming language) - Implementations</a></li>
<li><a href="https://en.wikipedia.org/wiki/CPython">Wikipedia: CPython</a></li>
</ul>
</div>
<h1 id="the-static-basic-approach">The (Static) Basic Approach</h1>
<p>When working with Python <code>.pyc</code> files, the initial step is often to decompile (or at least disassemble) the bytecode into something more comprehensible to humans. Here, we encounter the first challenge: Python bytecode is not designed for user manipulation, but rather for interpretation by the CPython interpreter itself. This makes Python bytecode highly volatile and subject to changes across different Python (CPython) versions. Consequently, a decompiler or disassembler that works for one specific version of CPython bytecode might not function with another version.</p>
<p>For this challenge, we used common tools designed for handling <code>.pyc</code> files. Specifically, we tried using <code>pycdc</code>, one of the most popular and up-to-date Python disassemblers and decompilers.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#80A665">➜</span><span style="color:#C98A7D">  build</span><span style="color:#C98A7D"> git:</span><span style="color:#666666">(</span><span style="color:#80A665">master</span><span style="color:#666666">)</span><span style="color:#C98A7D"> ✗</span><span style="color:#C98A7D"> ./pycdc</span><span style="color:#C98A7D"> a.pyc</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#758575DD"># Source Generated with Decompyle++</span></span>
<span class="line"><span style="color:#758575DD"># File: a.pyc (Python 3.12)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">Unsupported</span><span style="color:#C98A7D"> opcode:</span><span style="color:#C98A7D"> GET_LEN</span><span style="color:#DBD7CAEE"> (59)</span></span>
<span class="line"><span style="color:#758575DD"># WARNING: Decompyle incomplete</span></span>
<span class="line"><span style="color:#80A665">➜</span><span style="color:#C98A7D">  build</span><span style="color:#C98A7D"> git:</span><span style="color:#666666">(</span><span style="color:#80A665">master</span><span style="color:#666666">)</span><span style="color:#C98A7D"> ✗</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"></span></code></pre>
<p>Unfortunately, the Python version used in the challenge was not fully supported by <code>pycdc</code>, and no decompiling was possible. However, disassembly was still an option. Although not ideal, disassembling is better than having no insight at all. We proceeded to disassemble the <code>a.pyc</code> file using <code>pycdas</code> and encountered a very strange outcome:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#80A665">➜</span><span style="color:#C98A7D">  build</span><span style="color:#C98A7D"> git:</span><span style="color:#666666">(</span><span style="color:#80A665">master</span><span style="color:#666666">)</span><span style="color:#C98A7D"> ✗</span><span style="color:#C98A7D"> ./pycdas</span><span style="color:#C98A7D"> a.pyc</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#80A665">a.pyc</span><span style="color:#DBD7CAEE"> (Python </span><span style="color:#4C9A91">3.12</span><span style="color:#DBD7CAEE">)</span></span>
<span class="line"><span style="color:#666666">[</span><span style="color:#DBD7CAEE">Code</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#80A665">    File</span><span style="color:#C98A7D"> Name:</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#80A665">    Object</span><span style="color:#C98A7D"> Name:</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#80A665">    Qualified</span><span style="color:#C98A7D"> Name:</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#80A665">    Arg</span><span style="color:#C98A7D"> Count:</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#80A665">    Pos</span><span style="color:#C98A7D"> Only</span><span style="color:#C98A7D"> Arg</span><span style="color:#C98A7D"> Count:</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#80A665">    KW</span><span style="color:#C98A7D"> Only</span><span style="color:#C98A7D"> Arg</span><span style="color:#C98A7D"> Count:</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#80A665">    Stack</span><span style="color:#C98A7D"> Size:</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#80A665">    Flags:</span><span style="color:#4C9A91"> 0x00000000</span></span>
<span class="line"><span style="color:#666666">    [</span><span style="color:#DBD7CAEE">Names</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#666666">    [</span><span style="color:#DBD7CAEE">Locals+Names</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#666666">    [</span><span style="color:#DBD7CAEE">Constants</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#666666">    [</span><span style="color:#DBD7CAEE">Disassembly</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#80A665">        0</span><span style="color:#C98A7D">       LOAD_LOCALS</span><span style="color:#DBD7CAEE">                     </span></span>
<span class="line"><span style="color:#80A665">        2</span><span style="color:#C98A7D">       FORMAT_VALUE</span><span style="color:#4C9A91">                    1</span><span style="color:#DBD7CAEE"> (FVC_STR)</span></span>
<span class="line"><span style="color:#80A665">        4</span><span style="color:#C98A7D">       BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#80A665">        6</span><span style="color:#C98A7D">       GET_LEN</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#80A665">        8</span><span style="color:#C98A7D">       SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#666666">        [</span><span style="color:#DBD7CAEE">...</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#80A665">        10036</span><span style="color:#C98A7D">   LOAD_DEREF</span><span style="color:#4C9A91">                      7</span><span style="color:#CB7676"> &#x3C;</span><span style="color:#C98A7D">INVALI</span><span style="color:#DBD7CAEE">D</span><span style="color:#CB7676">></span></span>
<span class="line"><span style="color:#80A665">        10038</span><span style="color:#C98A7D">   SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#80A665">        10040</span><span style="color:#C98A7D">   BUILD_STRING</span><span style="color:#4C9A91">                    2</span></span>
<span class="line"><span style="color:#80A665">        10042</span><span style="color:#C98A7D">   STORE_DEREF</span><span style="color:#4C9A91">                     7</span><span style="color:#CB7676"> &#x3C;</span><span style="color:#C98A7D">INVALI</span><span style="color:#DBD7CAEE">D</span><span style="color:#CB7676">></span></span>
<span class="line"><span style="color:#80A665">        10044</span><span style="color:#C98A7D">   LOAD_DEREF</span><span style="color:#4C9A91">                      7</span><span style="color:#CB7676"> &#x3C;</span><span style="color:#C98A7D">INVALI</span><span style="color:#DBD7CAEE">D</span><span style="color:#CB7676">></span></span>
<span class="line"><span style="color:#80A665">        10046</span><span style="color:#C98A7D">   CALL_INTRINSIC_1</span><span style="color:#4C9A91">                1</span><span style="color:#DBD7CAEE"> (INTRINSIC_PRINT)</span></span>
<span class="line"><span style="color:#80A665">        10048</span><span style="color:#C98A7D">   POP_TOP</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#80A665">        10050</span><span style="color:#C98A7D">   RETURN_VALUE</span><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"></span></code></pre>
<p><a href="https://github.com/zrax/pycdc"><code>pycdas</code></a> reported no errors during disassembly, but the result looked strange: there were no names, constants, or locals, which is strange for a typical <code>.pyc</code> file, and most opcodes resulted invalid. We deduced that the bytecode was either hand-crafted or manipulated in such a way to break even disassembly.</p>
<p><img src="/writeup_files/black-magic/gru_meme.png" alt="pippo"></p>
<p>Thus, since the static approach could result in a tedious process, we resorted to the old technique of “dynamic analysis”.</p>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://github.com/zrax/pycdc">https://github.com/zrax/pycdc</a></li>
</ul>
</div>
<h1 id="tldr">TL;DR</h1>
<ul>
<li>The <code>CACHE</code> opcode instruction in Python can lead to undefined behavior, if executed. This caused the challenge to work as expected only inside the provided Docker.</li>
<li>We used <code>libdebug</code> to trace the execution of bytecode instructions.</li>
<li>The challenge built every string character-by-character using the <code>locals dictionary</code>, including the flag.</li>
<li>Each character of the flag was compared with a corresponding character from the imput provided by the user. If the comparison failed, the CPython interpreter crashed due to illegal jumps within the bytecode.</li>
<li>We successfully solved the challenge by attaching to the interpreter during execution, forcing each character comparison to succeed, and dumping the flag characters.</li>
</ul>
<p>If you want to read a more detailed version of our solution and explore additional alternative solutions, keep reading.</p>
<h1 id="the-dynamic-basic-approach">The (Dynamic) Basic Approach</h1>
<p>We attempted to run the <code>a.pyc</code> file to see if we could infer anything about the nature of the Python script. Unfortunately, the Python binary did not produce any output; it only requested an input. After receiving the input, it crashed. To be more precise, it was not the Python bytecode itself that crashed, but the CPython interpreter, which raised a segmentation fault. This is obviously not a common scenario, indicating that the bytecode must be executing some highly unusual and weird operations. This behavior was consistent across both the Docker environment and our native systems (Ubuntu Linux 22.04 with both Python 3.12.5 and 3.12.7, Arch Linux with Python 3.12.7, and Fedora Linux with Python 3.12.7).</p>
<p><img src="/writeup_files/black-magic/idea-meme.png" alt="image"></p>
<p>We then proceeded to analyze the point of failure using GDB. We attempted debugging on our local systems using <code>pwndbg</code>, and also by attaching <code>pwndbg</code> to the Docker process running the Python interpreter. On all systems, the segmentation fault was due to illegal memory access during the dereferencing of a pointer; however, each system seemed to segfault at different points and during different operations.</p>
<p><img src="/writeup_files/black-magic/gru_meme_2.png" alt="image"></p>
<p>Given the variations in Python versions and compilation processes on the different systems, and considering the challenge author’s advice about differing behaviors on versions other than the one in the Docker, we inferred with reasonable certainty that the segfault was somehow intended and related to the flag-checking process. The exact cause was still unclear at this stage.</p>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://github.com/pwndbg/pwndbg">https://github.com/pwndbg/pwndbg</a></li>
</ul>
</div>
<h1 id="the-dynamic--static-libdebug-approach">The (Dynamic + Static) libdebug Approach</h1>
<p>It became evident that we were dealing with a complex and unusual behaviour, making it crucial to precisely monitor and analyze the Python bytecode as it executed. To do so, we needed a reliable method to dump and track the runtime execution of the bytecode, specifically to observe exactly when and where the <code>.pyc</code> file was causing the Python interpreter to segfault.</p>
<p>Having worked on a similar problem in the past, we already had a <code>libdebug</code> script that does exactly that: it automatically sets some breakpoints in strategic locations inside the interpreter to dump the opcodes executed at runtime.</p>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://github.com/libdebug/libdebug">https://github.com/libdebug/libdebug</a></li>
<li><a href="https://docs.libdebug.org">https://docs.libdebug.org</a></li>
<li><a href="https://github.com/libdebug/libdebug/tree/0.7.0/examples/python_bytecode_debugging">https://github.com/libdebug/libdebug/tree/0.7.0/examples/python_bytecode_debugging</a></li>
</ul>
</div>
<p>For our analysis, we slightly modified the code to better suit our debugging needs. Here’s a high-level overview of our strategy.</p>
<h3 id="setup">Setup</h3>
<p>In order to facilitate a more in-depth analysis of the Python bytecode, we installed the development version of Python on our Arch system. This installation included all necessary symbols and ensured that the <code>libpython</code> library was dynamically linked rather than statically included within the Python binary. This configuration simplifies the process of setting breakpoints automatically and enhances the debugging capabilities. Alternatively, we could manually compile the CPython interpreter with specific flags to achieve a similar setup (e.g., <code>--enable-shared</code>).</p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p>Compiling the CPython interpreter with the flag <code>--with-pydebug</code> will instead lead to an assertion error due to the way the challenge was built. The assertion error is the following one.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#80A665">python3.12:</span><span style="color:#C98A7D"> Python/generated_cases.c.h:1632:_PyEval_EvalFrameDefault:Assertion</span><span style="color:#80A665"> `STACK_LEVEL</span><span style="color:#666666">()</span><span style="color:#CB7676"> &#x3C;</span><span style="color:#DBD7CAEE">= </span><span style="color:#80A665">STACK_SIZE</span><span style="color:#666666">()</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D"> failed.</span></span>
<span class="line"><span style="color:#C98A7D">[1]    79438 IOT instruction (core dumped)  python3.12 a.pyc</span></span>
<span class="line"></span></code></pre>
</div>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://devguide.python.org">https://devguide.python.org</a></li>
<li><a href="https://github.com/docker-library/python/issues/21">https://github.com/docker-library/python/issues/21</a></li>
</ul>
</div>
<h3 id="automatic-breakpoint-dump">Automatic Breakpoint Dump</h3>
<p>Conceptually, the execution of Python bytecode involves a classic main loop. This loop processes each bytecode instruction one at a time, identifying the type of instruction based on its opcode through an <code>if-else</code> or <code>match-case</code> structure, parses the instruction arguments, and then executes the corresponding operation.</p>
<p>However, due to performance and optimization reasons, the actual implementation in CPython is more complex. Within the CPython source code, notably in <code>generated_cases.c.h</code>, the dispatching mechanism isn’t confined to a single code point but is defined using macros. This distinction is crucial for our purposes.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#758575DD">// Code from python/cpython/Python/generated_cases.c.h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">// Omitted code</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">TARGET</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">BINARY_OP</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // Omitted code</span></span>
<span class="line"><span style="color:#BD976A">    stack_pointer</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> res</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">    next_instr </span><span style="color:#CB7676">+=</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#80A665">    DISPATCH</span><span style="color:#666666">();</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">TARGET</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">SWAP</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // Omitted code</span></span>
<span class="line"><span style="color:#BD976A">    stack_pointer</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> bottom</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#BD976A">    stack_pointer</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#666666">(</span><span style="color:#4C9A91">2</span><span style="color:#CB7676"> +</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">oparg</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">2</span><span style="color:#666666">))]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> top</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#80A665">    DISPATCH</span><span style="color:#666666">();</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"><span style="color:#80A665">TARGET</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">GET_LEN</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // Omitted code</span></span>
<span class="line"><span style="color:#80A665">    STACK_GROW</span><span style="color:#666666">(</span><span style="color:#4C9A91">1</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#BD976A">    stack_pointer</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> len_o</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#80A665">    DISPATCH</span><span style="color:#666666">();</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">TARGET</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">MATCH_CLASS</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // Omitted code</span></span>
<span class="line"><span style="color:#80A665">    STACK_SHRINK</span><span style="color:#666666">(</span><span style="color:#4C9A91">2</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#BD976A">    stack_pointer</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> attrs</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#80A665">    DISPATCH</span><span style="color:#666666">();</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">// Omitted code</span></span>
<span class="line"></span></code></pre>
<p>As illustrated, after each instruction is executed, the <code>DISPATCHER()</code> is executed as well. However, this isn’t a function call but a macro expansion, defined as:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#758575DD">// Code from python/cpython/Modules/_sre/sre_lib.h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">if</span><span style="color:#80A665"> USE_COMPUTED_GOTOS</span></span>
<span class="line"><span style="color:#666666">    #</span><span style="color:#4D9375">define</span><span style="color:#80A665"> TARGET</span><span style="color:#666666">(</span><span style="color:#BD976A">OP</span><span style="color:#666666">)</span><span style="color:#DBD7CAEE"> TARGET_ ## OP</span></span>
<span class="line"><span style="color:#666666">    #</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DISPATCH</span><span style="color:#C99076">                       \</span></span>
<span class="line"><span style="color:#4D9375">        do</span><span style="color:#666666"> {</span><span style="color:#C99076">                               \</span></span>
<span class="line"><span style="color:#DBD7CAEE">            MAYBE_CHECK_SIGNALS</span><span style="color:#666666">;</span><span style="color:#C99076">           \</span></span>
<span class="line"><span style="color:#4D9375">            goto</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">sre_targets</span><span style="color:#666666">[</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">pattern</span><span style="color:#CB7676">++</span><span style="color:#666666">];</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#666666">        }</span><span style="color:#4D9375"> while</span><span style="color:#666666"> (</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">else</span></span>
<span class="line"><span style="color:#666666">    #</span><span style="color:#4D9375">define</span><span style="color:#80A665"> TARGET</span><span style="color:#666666">(</span><span style="color:#BD976A">OP</span><span style="color:#666666">)</span><span style="color:#DBD7CAEE"> case OP</span></span>
<span class="line"><span style="color:#666666">    #</span><span style="color:#4D9375">define</span><span style="color:#80A665"> DISPATCH</span><span style="color:#4D9375"> goto</span><span style="color:#DBD7CAEE"> dispatch</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">endif</span></span>
<span class="line"></span></code></pre>
<p>Without going into further details, it could potentially expand into a jump to a computed address due to <code>computed_goto</code>, similar to a jump table mechanism.</p>
<p>Here is a representative snippet of assembly code that might be generated from the macro expansion:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span> ...</span></span>
<span class="line"><span> mov    r15, rax</span></span>
<span class="line"><span> mov    r14, qword ptr [rbp - 0x128]</span></span>
<span class="line"><span> mov    rax, qword ptr [rbx + rax*8]</span></span>
<span class="line"><span> jmp    rax</span></span>
<span class="line"><span></span></span></code></pre>
<p>In this assembly code, <code>rax</code> initially contains the opcode and subsequently the address to which the jump will occur, while <code>r15</code> stores the opcode value for use after the jump. This mechanism is critical for executing the logic corresponding to the parsed opcode. Note that this description is specific to Python 3.12.7 on Arch Linux; different Python compilations may use different registers or slightly varied assembly operations.</p>
<p>Given this complexity, our approach involved searching the <code>libpython</code> shared library for all occurrences of the macro expansion. We used <code>elftools</code> to open the libpython library and defined specific signatures with <code>capstone</code> to match the described macro expansions.</p>
<p>The following code snippet outlines our method:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> capstone </span><span style="color:#4D9375">import</span><span style="color:#C99076"> CS_ARCH_X86</span><span style="color:#666666">,</span><span style="color:#C99076"> CS_MODE_64</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> Cs</span></span>
<span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> elftools</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">elffile </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> ELFFile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Find the offsets of the DISPATCHER macro expansion in the libpython shared library</span></span>
<span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> find_patterns_in_section</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">section</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> md</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C98A7D77">    """</span><span style="color:#C98A7D">Find patterns in the given section. We want to find every DISPATCHER inlined in the libpython shared library.</span><span style="color:#C98A7D77">"""</span></span>
<span class="line"><span style="color:#DBD7CAEE">    jmp_rax_offsets </span><span style="color:#666666">=</span><span style="color:#666666"> []</span></span>
<span class="line"><span style="color:#DBD7CAEE">    prev_instructions </span><span style="color:#666666">=</span><span style="color:#666666"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> md</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">disasm</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">section</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">data</span><span style="color:#666666">(),</span><span style="color:#DBD7CAEE"> section</span><span style="color:#666666">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">sh_addr</span><span style="color:#C98A7D77">"</span><span style="color:#666666">]):</span></span>
<span class="line"><span style="color:#DBD7CAEE">        prev_instructions</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">((</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">mnemonic</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">op_str</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">prev_instructions</span><span style="color:#666666">)</span><span style="color:#CB7676"> ></span><span style="color:#4C9A91"> 2</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">            prev_instructions</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">prev_instructions</span><span style="color:#666666">)</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 2</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">            if</span><span style="color:#666666"> (</span></span>
<span class="line"><span style="color:#DBD7CAEE">                prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rdi + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rbx + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rdx + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rcx + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [r8 + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [r9 + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rsi + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">            )</span><span style="color:#CB7676"> and</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">jmp</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax</span><span style="color:#C98A7D77">"</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">                jmp_rax_offsets</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">            elif</span><span style="color:#666666"> (</span></span>
<span class="line"><span style="color:#DBD7CAEE">                prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rdi + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rbx + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rdx + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rcx + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [r8 + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [r9 + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#CB7676">                or</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">mov</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax, qword ptr [rsi + rax*8]</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">            )</span><span style="color:#CB7676"> and</span><span style="color:#DBD7CAEE"> prev_instructions</span><span style="color:#666666">[</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">jmp</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rax</span><span style="color:#C98A7D77">"</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">                jmp_rax_offsets</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> jmp_rax_offsets</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Open the libpython shared library and find the offsets of interest</span></span>
<span class="line"><span style="color:#4D9375">with</span><span style="color:#B8A965"> open</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/usr/lib/libpython3.12.so.1.0</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rb</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">    elf </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> ELFFile</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">f</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    md </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> Cs</span><span style="color:#666666">(</span><span style="color:#C99076">CS_ARCH_X86</span><span style="color:#666666">,</span><span style="color:#C99076"> CS_MODE_64</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    # Collect all offsets from executable sections</span></span>
<span class="line"><span style="color:#DBD7CAEE">    all_offsets </span><span style="color:#666666">=</span><span style="color:#666666"> []</span></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> section </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> elf</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">iter_sections</span><span style="color:#666666">():</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> section</span><span style="color:#666666">[</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">sh_flags</span><span style="color:#C98A7D77">"</span><span style="color:#666666">]</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">4</span><span style="color:#666666">:</span><span style="color:#758575DD">  # SHF_EXECINSTR</span></span>
<span class="line"><span style="color:#DBD7CAEE">            offsets </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> find_patterns_in_section</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">section</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> md</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">            all_offsets</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">extend</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">offsets</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://github.com/python/cpython">https://github.com/python/cpython</a></li>
<li><a href="https://github.com/eliben/pyelftools">https://github.com/eliben/pyelftools</a></li>
<li><a href="https://github.com/capstone-engine/capstone">https://github.com/capstone-engine/capstone</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html">https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html</a></li>
</ul>
</div>
<h3 id="tracing-with-libdebug-callbacks">Tracing with libdebug Callbacks</h3>
<p>Having identified all the code points where the macro expansion can be executed, we proceeded to use libdebug to programmatically debug the Python interpreter and trace the bytecode. Our approach involved setting a breakpoint at each identified location and installing a callback to each of these breakpoints. In libdebug, a callback is a Python function triggered every time a specific event is hit and that can interact with the process.</p>
<p>For our purposes, the callback function was designed to read the value of <code>r15</code>—which held the opcode value—and then map this opcode to its corresponding mnemonic instruction name. The mnemonic names for the opcodes were extracted from the <code>opcode_ids.h</code> file located in the <code>python/cpython/Include/</code> directory of the CPython source code. We decided not to use the <code>opcode</code> and <code>dis</code> modules provided by Python, as they seemed incomplete and lacked definitions for some opcodes we encountered during our analysis. Specifically, in Python 3.12.5, the so-called <code>specialized opcodes</code> were not associated with their numerical values in the <code>opcode</code> module. Due to the low-level tracing we were using, we encountered various specialized opcodes during this process requiring a more complete opcode mapping. This limitation also affects the <code>dis</code> module, which internally relies on <code>opcode</code>, thus it cannot address this gap. It was only with Python 3.13 that a private attribute, <code>opcode._specialized_opmap</code>, was introduced in the <code>opcode</code> module, which includes these specialized opcodes.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> libdebug </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> debugger </span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> dumper</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> _</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C98A7D77">    """</span><span style="color:#C98A7D">Callback function to dump the executed python opcode.</span><span style="color:#C98A7D77">"""</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#CB7676">        f</span><span style="color:#C98A7D">"Executed opcode: </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">regs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">r15</span><span style="color:#CB7676">:#x</span><span style="color:#C99076">}</span><span style="color:#C98A7D"> - </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">opcode_to_mnemonic</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">get</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">regs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">r15</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">UNKNOWN</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#C99076">}</span><span style="color:#C98A7D">"</span></span>
<span class="line"><span style="color:#666666">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">d </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> debugger</span><span style="color:#666666">([</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">python3.12</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./src/a.pyc</span><span style="color:#C98A7D77">"</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">r </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">run</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> addr </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> all_offsets</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">    d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">breakpoint</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">addr</span><span style="color:#666666">,</span><span style="color:#BD976A"> file</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">libpython3</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> callback</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">dumper</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Start the execution</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Send the flag attempt</span></span>
<span class="line"><span style="color:#DBD7CAEE">r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">hkcert24{provola}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Wait for the process to terminate</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">wait</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Crosscheck the segfault</span></span>
<span class="line"><span style="color:#B8A965">print</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">exit_signal</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://docs.libdebug.org/latest/stopping_events/breakpoints">https://docs.libdebug.org/latest/stopping_events/breakpoints</a></li>
<li><a href="https://peps.python.org/pep-0659/">https://peps.python.org/pep-0659/</a></li>
</ul>
</div>
<h3 id="isolating-the-challenges-opcodes">Isolating the Challenge’s Opcodes</h3>
<p>Another challenge we faced was that the Python interpreter adds additional instructions before and after those associated with the Python code we aimed to execute. Our goal was to isolate only the instructions contained within the<code>.pyc</code> file.</p>
<p>To achieve this, we delved back into the CPython source code, specifically targeting the <code>run_pyc_file</code> function within the <code>python/cpython/Python/pythonrun.c</code> file. This function takes a file descriptor as input and initiates the execution of the bytecode by calling <code>run_eval_code_obj</code>, which handles the extracted Python structures and eventually executes the bytecode. Therefore, any opcode executed before this function is called cannot be associated with the <code>.pyc</code> file provided in the challenge. Moreover, since the interpreter experienced a segmentation fault during the execution of the <code>.pyc</code> bytecode, we could also confirm that the last instruction dumped by our script was indeed part of the <code>.pyc</code> file.</p>
<p>Below is the updated script to isolate the <code>.pyc</code> executed opcodes:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">d </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> debugger</span><span style="color:#666666">([</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">python3.12</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./src/a.pyc</span><span style="color:#C98A7D77">"</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">r </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">run</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># We want to dump only the executed python opcodes from the .pyc file</span></span>
<span class="line"><span style="color:#758575DD"># Let put a breakpoint on the run_pyc_file function as a guard</span></span>
<span class="line"><span style="color:#DBD7CAEE">run_pyc_file </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">breakpoint</span><span style="color:#666666">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">CB761</span><span style="color:#666666">,</span><span style="color:#BD976A"> file</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">libpython3</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> hardware</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Start the execution</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Send the flag attempt</span></span>
<span class="line"><span style="color:#DBD7CAEE">r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">hkcert24{provola}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> run_pyc_file</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hit_on</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#758575DD">    # The python .pyc script has started, we can now set the breakpoints to dump the executed opcodes</span></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> addr </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> all_offsets</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">        d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">breakpoint</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">addr</span><span style="color:#666666">,</span><span style="color:#BD976A"> file</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">libpython3</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> callback</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">dumper</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#758575DD">    # We can now disable the guard breakpoint</span></span>
<span class="line"><span style="color:#DBD7CAEE">    run_pyc_file</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">disable</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Continue</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Wait for the process to terminate</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">wait</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Crosscheck the segfault</span></span>
<span class="line"><span style="color:#B8A965">print</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">exit_signal</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<h3 id="cutting-even-more-instructions">Cutting Even More Instructions</h3>
<p>Analyzing the bytecode already proved to be quite challenging due to its complexity. To make this task more manageable, we divided the bytecode into smaller parts. Our primary goal was to isolate the portion of the bytecode that manipulated the input we provided. Our approach to achieve this was straightforward: we executed the dumper again without providing any input—by commenting out the line <code>r.sendline(b"hkcert24{provola}")</code>. This allowed the <code>.pyc</code> execution to stall while waiting for input, ensuring that the dumped instructions up to that point did not involve any input manipulation. Any instructions following this would potentially manipulate the input.</p>
<p>To further refine our analysis, we focused also on ignoring internal bytecode operations that handle the reading from stdin, processing the results, and building the Python string (or bytestring) object in memory. Our method involved continuously searching the memory for the input string before the execution of each bytecode instruction. To do so, we used the libdebug method <code>d.memory.find()</code> to search through memory. To enhance the efficiency of this operation, we activated the <code>fast_memory</code> flag within our debugger initialization. This was accomplished by configuring our debugger instance as follows: <code>d = debugger(["python3.12", "./src/a.pyc"], fast_memory=True)</code>.</p>
<p>Additionally, we shifted from libdebug asynchronous breakpoints to synchronous breakpoints. This change involved removing the callbacks during breakpoint installation. While with asynchronous breakpoints, each time the breakpoint is hit the callback is executed internally in libdebug and, at the end, the process continues, with synchronous breakpoints, after being hit, the debugger will not continue the process automatically, executing our commands from the main script instead. By employing synchronous breakpoints, we were able to directly control the execution flow and more effectively understand the exact bytecode operations interacting with the input.</p>
<p>This strategy allowed us to eliminate all bytecode operations performed before the entire input string was found in memory. Surprisingly, this approach helped us discard most of the bytecode instructions, as very few were executed after the complete string was built and located in memory.</p>
<p>Due to the small number of instructions remaining, we decided to pass to manual analysis using an interactive debugger, like GDB. We manually traced the CPython code executed from the point where the full input string was found in memory up to the occurrence of the segmentation fault. To facilitate this transition seamlessly, we took advantage of a helpful feature in libdebug that allows us to detach the process from libdebug and reattach it to GDB, continuing the debugging session in GDB while preserving the breakpoints.</p>
<p>The resulting script is as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">d </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> debugger</span><span style="color:#666666">([</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">python3.12</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">./src/a.pyc</span><span style="color:#C98A7D77">"</span><span style="color:#666666">],</span><span style="color:#BD976A"> fast_memory</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">r </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">run</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># We want to dump only the executed python opcodes from the .pyc file</span></span>
<span class="line"><span style="color:#758575DD"># Let put a breakpoint on the run_pyc_file function as a guard</span></span>
<span class="line"><span style="color:#DBD7CAEE">run_pyc_file </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">breakpoint</span><span style="color:#666666">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">CB761</span><span style="color:#666666">,</span><span style="color:#BD976A"> file</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">libpython3</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> hardware</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Start the execution</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Send the flag attempt</span></span>
<span class="line"><span style="color:#758575DD"># (if we don't send the flag, the .pyc will hang and we can undestand the point in the pyc where the input is asked)</span></span>
<span class="line"><span style="color:#DBD7CAEE">r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">hkcert24{provola}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">if</span><span style="color:#DBD7CAEE"> run_pyc_file</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hit_on</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#758575DD">    # The python .pyc script has started, we can now set the breakpoints to dump the executed opcodes</span></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> addr </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> all_offsets</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">        d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">breakpoint</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">addr</span><span style="color:#666666">,</span><span style="color:#BD976A"> file</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">libpython3</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span><span style="color:#758575DD">  # sync breakpoints</span></span>
<span class="line"><span style="color:#758575DD">    # We can now disable the guard breakpoint</span></span>
<span class="line"><span style="color:#DBD7CAEE">    run_pyc_file</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">disable</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Continue</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">counter </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#4D9375">while</span><span style="color:#B8A965"> any</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">bp</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hit_on</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">)</span><span style="color:#4D9375"> for</span><span style="color:#DBD7CAEE"> bp </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">breakpoints</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">values</span><span style="color:#666666">()):</span></span>
<span class="line"><span style="color:#758575DD">    # print(f"Executed opcode: {d.regs.r15:#x} - {opcode_to_mnemonic.get(d.regs.r15, 'UNKNOWN')}")</span></span>
<span class="line"><span style="color:#DBD7CAEE">    counter </span><span style="color:#666666">+=</span><span style="color:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#758575DD">    # We identified 223 as the point where the input is asked</span></span>
<span class="line"><span style="color:#758575DD">    # Now we want to pass to GDB when the input is found in memory</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> counter </span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 223</span><span style="color:#CB7676"> and</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">found </span><span style="color:#666666">:=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">memory</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">find</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">hkcert24</span><span style="color:#C99076">{provola}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)):</span></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Found input in memory at </span><span style="color:#C99076">{</span><span style="color:#666666">[</span><span style="color:#B8A965">hex</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">findus</span><span style="color:#666666">)</span><span style="color:#4D9375"> for</span><span style="color:#DBD7CAEE"> findus </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> found</span><span style="color:#666666">]</span><span style="color:#C99076">}</span><span style="color:#C98A7D">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">        break</span></span>
<span class="line"><span style="color:#DBD7CAEE">    d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">    d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">wait</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">gdb</span><span style="color:#666666">()</span></span>
<span class="line"></span></code></pre>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://docs.libdebug.org/latest/stopping_events/debugging_flow">https://docs.libdebug.org/latest/stopping_events/debugging_flow</a></li>
<li><a href="https://docs.libdebug.org/latest/basics/detach_and_gdb">https://docs.libdebug.org/latest/basics/detach_and_gdb</a></li>
</ul>
</div>
<h3 id="searching-for-the-segfault-origin">Searching for the Segfault Origin</h3>
<p>With only a few Python instructions left to analyze, we aimed to understand the role of our input in triggering the segfault in the CPython interpreter. After meticulous step-by-step tracing in GDB, using <code>si</code> and <code>ni</code>, we traced the operations performed on the input leading to a… boring Python internal decode operation.</p>
<p><img src="/writeup_files/black-magic/never-ask-meme.png" alt="image"></p>
<p>Initially, it seemed we had reached a dead end. However, there was still hope. The very last executed Python instruction before crash was a <code>CACHE</code> instruction.</p>
<p>Let’s analyze the execution flow of the <code>CACHE</code> instruction by examining the CPython source code. In <code>generated_cases.c.h</code>, the <code>CACHE</code> case is defined as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#758575DD">// Code from python/cpython/Python/generated_cases.c.h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">TARGET</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CACHE</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#666666">    #</span><span style="color:#4D9375">line</span><span style="color:#4C9A91"> 3482</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Python/bytecodes.c</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#80A665">    assert</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#CB7676"> &#x26;&#x26;</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Executing a cache.</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    Py_UNREACHABLE</span><span style="color:#666666">();</span></span>
<span class="line"><span style="color:#666666">    #</span><span style="color:#4D9375">line</span><span style="color:#4C9A91"> 4801</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Python/generated_cases.c.h</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>The <code>Py_UNREACHABLE()</code> macro is instead defined in <code>pymacro.h</code> as follow:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#758575DD">// Code from python/cpython/Include/pymacro.h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">if</span><span style="color:#4D9375"> defined</span><span style="color:#666666">(</span><span style="color:#80A665">RANDALL_WAS_HERE</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">  define</span><span style="color:#80A665"> Py_UNREACHABLE</span><span style="color:#666666">()</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#80A665">    Py_FatalError</span><span style="color:#666666">(</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">If you're seeing this, the code is in what I thought was</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">an unreachable state.</span><span style="color:#C99076">\n\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">I could give you advice for what to do, but honestly, why</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">should you trust me?  I clearly screwed this up.  I'm writing</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">a message that should never appear, yet I know it will</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">probably appear someday.</span><span style="color:#C99076">\n\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">On a deep level, I know I'm not up to this task.</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">I'm so sorry.</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">https://xkcd.com/2200</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">elif</span><span style="color:#4D9375"> defined</span><span style="color:#666666">(</span><span style="color:#80A665">Py_DEBUG</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">  define</span><span style="color:#80A665"> Py_UNREACHABLE</span><span style="color:#666666">()</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#80A665">    Py_FatalError</span><span style="color:#666666">(</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">We've reached an unreachable state. Anything is possible.</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">The limits were in our heads all along. Follow your dreams.</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#C98A7D77">        "</span><span style="color:#C98A7D">https://xkcd.com/2200</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">elif</span><span style="color:#4D9375"> defined</span><span style="color:#666666">(</span><span style="color:#80A665">__GNUC__</span><span style="color:#666666">)</span><span style="color:#CB7676"> &#x26;&#x26;</span><span style="color:#666666"> (</span><span style="color:#80A665">__GNUC__</span><span style="color:#CB7676"> ></span><span style="color:#4C9A91"> 4</span><span style="color:#CB7676"> ||</span><span style="color:#666666"> (</span><span style="color:#80A665">__GNUC__</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 4</span><span style="color:#CB7676"> &#x26;&#x26;</span><span style="color:#80A665"> __GNUC_MINOR__</span><span style="color:#CB7676"> >=</span><span style="color:#4C9A91"> 5</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">  define</span><span style="color:#80A665"> Py_UNREACHABLE</span><span style="color:#666666">()</span><span style="color:#80A665"> __builtin_unreachable</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">elif</span><span style="color:#4D9375"> defined</span><span style="color:#666666">(</span><span style="color:#80A665">__clang__</span><span style="color:#666666">)</span><span style="color:#CB7676"> ||</span><span style="color:#4D9375"> defined</span><span style="color:#666666">(</span><span style="color:#80A665">__INTEL_COMPILER</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">  define</span><span style="color:#80A665"> Py_UNREACHABLE</span><span style="color:#666666">()</span><span style="color:#80A665"> __builtin_unreachable</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">elif</span><span style="color:#4D9375"> defined</span><span style="color:#666666">(</span><span style="color:#80A665">_MSC_VER</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">  define</span><span style="color:#80A665"> Py_UNREACHABLE</span><span style="color:#666666">()</span><span style="color:#80A665"> __assume</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">else</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">  define</span><span style="color:#80A665"> Py_UNREACHABLE</span><span style="color:#666666">()</span><span style="color:#C99076"> \</span></span>
<span class="line"><span style="color:#80A665">    Py_FatalError</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Unreachable C code path reached</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">endif</span></span>
<span class="line"></span></code></pre>
<p>As you can see, in most of the interesting cases, <code>Py_UNREACHABLE()</code> is expanded as <code>__builtin_unreachable()</code>. <code>__builtin_unreachable()</code> is a compiler directive that marks certain code paths as never intended to be executed, informing the compiler that control should not reach this part of the code. This directive leads to various optimizations, such as the reorganization, removal, or merging of code blocks under the assumption that these paths are indeed unreachable. One of the more interesting implications is that if execution does unexpectedly reach <code>__builtin_unreachable()</code>, the resulting behavior is undefined. In practice, the compiler may insert arbitrary instructions or data segments after this point, which can lead to unexpected crashes or other strange behaviors.</p>
<p><img src="/writeup_files/black-magic/achievement-meme.png" alt="image"></p>
<p>Thus, when the <code>CACHE</code> instruction was executed, it led to a portion of the CPython interpreter being run that is not directly involved with the <code>.pyc</code> execution. This also explains why the segmentation fault, though consistent across Python versions, manifests differently depending on the Linux distro and Python version, due to variations in the compilation process.</p>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://clang.llvm.org/docs/LanguageExtensions.html#builtin-unreachable">https://clang.llvm.org/docs/LanguageExtensions.html#builtin-unreachable</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html#index-_005f_005fbuiltin_005funreachable">https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html#index-_005f_005fbuiltin_005funreachable</a></li>
<li><a href="https://docs.python.org/3/library/dis.html#opcode-CACHE">https://docs.python.org/3/library/dis.html#opcode-CACHE</a></li>
</ul>
</div>
<h3 id="tracking-the-undefined-behavior-inside-docker">Tracking the Undefined Behavior Inside Docker</h3>
<p>The next step was to run the <code>.pyc</code> file within the provided Docker environment and determine which operations were executed following the <code>CACHE</code> opcode. We attached to the process running inside the Docker and followed it up to the point where the <code>CACHE</code> instruction was executed. This investigation revealed a notable behavior: when the Python interpreter inside the Docker executes a <code>CACHE</code> instruction, the jump performed as part of the usual macro expansion mechanism leads directly to the parsing of the next instruction, executing an assembly code which resembles another macro expansion. Essentially, in the Docker, the execution of the <code>CACHE</code> instruction works similar to a no-operation, allowing the <code>.pyc</code> file’s execution to continue.</p>
<figure>
    <img src="/writeup_files/black-magic/pwndbg-screen.png" alt="pwndbg screen" style="width: 100%;">
    <figcaption>r13 contains the opcode, which is a CACHE. When this instruction is dispatched, it leads to another dispatcher immediately after.</figcaption>
</figure>
<p>This allowed us to continue the dynamic analysis of the <code>.pyc</code> execution from that point on. In particular, the code retrieved the first character from our input and compared it to a Python string object it builds containing only the single character <code>h</code>, matching the initial character of the expected flag format. If this character check failed, the execution path reached a branch that led to a segmentation fault. This fault was triggered by illegal jumps within the executed bytecode. We were now closer than ever.</p>
<h1 id="solution">Solution</h1>
<p>To finally solve the challenge, we used libdebug once again. Our script began by attaching to the Python process running inside the Docker environment. We set breakpoints strategically placed just before the call to the <code>PyObject_RichCompare</code> function responsible for comparing one character of our input with the Python string object containing the flag character.</p>
<p>At this execution point, according to the usual <code>SYSTEMV</code> calling convention, <code>rsi</code> held a pointer to the python object related to our input, and <code>rdi</code> contained a pointer to the Python string object containing one flag character. Our first task was to dump the flag character from the Python object at <code>rdi</code>. Specifically, at offset 0x28, the actual string character was located, with other fields holding the reference counter and various Python attributes.</p>
<p>To capture the entire flag in a single execution, we manipulated the pointers to ensure the comparison would pass. By setting <code>rsi</code> equal to <code>rdi</code>, both pointers referred to the same object, thereby guaranteeing the character comparison would succeed. This manipulation allowed the code to proceed seamlessly to the next character comparison.</p>
<p>The script was as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> libdebug </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> debugger</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">flag </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># This function force the check to be true and dump the flag</span></span>
<span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> force_and_dump</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> bp</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#CB7676">    global</span><span style="color:#DBD7CAEE"> flag</span></span>
<span class="line"><span style="color:#758575DD">    # Access to the Python object's content</span></span>
<span class="line"><span style="color:#DBD7CAEE">    flag </span><span style="color:#666666">+=</span><span style="color:#B8A965"> bytes</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">mem</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">regs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">rdi </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">28</span><span style="color:#666666">])</span></span>
<span class="line"><span style="color:#758575DD">    # Force the check to be true</span></span>
<span class="line"><span style="color:#DBD7CAEE">    t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">regs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">rdi </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">regs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">rsi</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Not elegant but it works</span></span>
<span class="line"><span style="color:#DBD7CAEE">pid </span><span style="color:#666666">=</span><span style="color:#B8A965"> input</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Enter PID: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">d </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> debugger</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">attach</span><span style="color:#666666">(</span><span style="color:#B8A965">int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">pid</span><span style="color:#666666">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Break on the PyObject_RichCompare call</span></span>
<span class="line"><span style="color:#DBD7CAEE">bp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">bp</span><span style="color:#666666">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">11f0f9</span><span style="color:#666666">,</span><span style="color:#BD976A"> file</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">libpython</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> callback</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">force_and_dump</span><span style="color:#666666">,</span><span style="color:#BD976A"> hardware</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Wait the end of the execution</span></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">wait</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">kill</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965">print</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<h1 id="appendix-a-challenges-execution-flow">Appendix A: Challenge’s Execution Flow</h1>
<p>While our solution focused on identifying the point where character-by-character comparisons occur, understanding the complete execution flow of the challenge remains interesting. Here’s a detailed analysis of the bytecode extracted with <code>pycdas</code>.</p>
<h3 id="asking-for-the-user-input">Asking for the User Input</h3>
<p>The first executed instruction is <code>LOAD_LOCALS</code>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">0</span><span style="color:#C99076">       LOAD_LOCALS</span></span>
<span class="line"></span></code></pre>
<p>which:</p>
<blockquote>
<p>Pushes a reference to the locals dictionary onto the stack. […]</p>
</blockquote>
<p>The locals dictionary may vary based on the execution environment, necessitating analysis within the Docker environment. Here, it appears as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">locals_dict </span><span style="color:#666666">=</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__name__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">__main__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__doc__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__package__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__loader__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> SourcelessFileLoader</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">/app/src/a.pyc</span><span style="color:#C98A7D77">'</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__spec__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__annotations__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#666666"> {},</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__builtins__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> builtins</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__file__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">/app/src/a.pyc</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__cached__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<p>The next operation formats literal strings:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">2</span><span style="color:#C99076">       FORMAT_VALUE</span><span style="color:#4C9A91">                    1</span><span style="color:#666666"> (</span><span style="color:#C99076">FVC_STR</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>The <code>FVC_STR</code> flag indicates a call to <code>str()</code> before formatting the value passed on the stack. Moreover, no<code>fmt_spec</code> are specified. Hence, this intruction takes the locals dictionary, formats it as a string, and pushes it back onto the stack.</p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<p>The subsequent instructions involve constructing an empty tuple and measuring its length:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">4</span><span style="color:#C99076">       BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#4C9A91">6</span><span style="color:#C99076">       GET_LEN</span></span>
<span class="line"></span></code></pre>
<p>These steps result in a <code>0</code> (the length) being pushed onto the stack above the empty tuple.</p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>0</td>
    </tr>
    <tr>
        <td>()</td>
    </tr>
    <tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<p>The following operation is a <code>SWAP</code>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">8</span><span style="color:#C99076">       SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"></span></code></pre>
<p>that is defined as:</p>
<blockquote>
<p>Swap the top of the stack with the i-th element:
STACK[-i], STACK[-1] = STACK[-1], STACK[-i]</p>
</blockquote>
<p>The value of <code>i</code> is specified as an argument. In the bytecode, the argument is equal to <code>2</code>, so it swaps the top of the stack with the second element below it.</p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>()</td>
    </tr>
    <tr>
        <td>0</td>
    </tr>
    <tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<p>Then, the bytecode pops the top item from the stack, removing the empty tuple.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">10</span><span style="color:#C99076">      POP_TOP</span></span>
<span class="line"></span></code></pre>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>0</td>
    </tr>
    <tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<p>Next, the bytecode performs mathematical operations to manipulate the stack’s top value:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">12</span><span style="color:#C99076">      UNARY_INVERT</span><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"><span style="color:#4C9A91">14</span><span style="color:#C99076">      UNARY_NEGATIVE</span></span>
<span class="line"></span></code></pre>
<p>After these, <code>~0</code> evaluates to <code>-1</code>, and the negative of <code>-1</code> is <code>1</code>, leaving <code>1</code> at the stack’s top.</p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>1</td>
    </tr>
    <tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<p>This pattern of building a tuple, swapping, popping, etc. is repeated:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">16</span><span style="color:#C99076">      BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#4C9A91">18</span><span style="color:#C99076">      GET_LEN</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">20</span><span style="color:#C99076">      SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">22</span><span style="color:#C99076">      POP_TOP</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">24</span><span style="color:#C99076">      UNARY_INVERT</span><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"><span style="color:#4C9A91">26</span><span style="color:#C99076">      UNARY_NEGATIVE</span></span>
<span class="line"></span></code></pre>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>1</td>
    </tr>
    <tr>
        <td>1</td>
    </tr>
    <tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">28</span><span style="color:#C99076">      BINARY_OP</span><span style="color:#4C9A91">                       3</span><span style="color:#666666"> (</span><span style="color:#CB7676">&#x3C;&#x3C;</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>At this point, the bytecode applies a logical shift using the two last values on top of the stack, which are the previously computed values. Hence, it shifts <code>1</code> by <code>1</code> making <code>2</code>. The result is pushed onto the stack.</p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>2</td>
    </tr>
    <tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">32</span><span style="color:#C99076">      BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#4C9A91">34</span><span style="color:#C99076">      GET_LEN</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">36</span><span style="color:#C99076">      SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">38</span><span style="color:#C99076">      POP_TOP</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">40</span><span style="color:#C99076">      UNARY_INVERT</span><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"><span style="color:#4C9A91">42</span><span style="color:#C99076">      UNARY_NEGATIVE</span><span style="color:#DBD7CAEE">                  </span></span>
<span class="line"><span style="color:#4C9A91">44</span><span style="color:#C99076">      BINARY_OP</span><span style="color:#4C9A91">                       3</span><span style="color:#666666"> (</span><span style="color:#CB7676">&#x3C;&#x3C;</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4C9A91">48</span><span style="color:#C99076">      BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#4C9A91">50</span><span style="color:#C99076">      GET_LEN</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">52</span><span style="color:#C99076">      SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">54</span><span style="color:#C99076">      POP_TOP</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">56</span><span style="color:#C99076">      UNARY_INVERT</span><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"><span style="color:#4C9A91">58</span><span style="color:#C99076">      UNARY_NEGATIVE</span><span style="color:#DBD7CAEE">                  </span></span>
<span class="line"><span style="color:#4C9A91">60</span><span style="color:#C99076">      BINARY_OP</span><span style="color:#4C9A91">                       3</span><span style="color:#666666"> (</span><span style="color:#CB7676">&#x3C;&#x3C;</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4C9A91">64</span><span style="color:#C99076">      BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#4C9A91">66</span><span style="color:#C99076">      GET_LEN</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">68</span><span style="color:#C99076">      SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">70</span><span style="color:#C99076">      POP_TOP</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">72</span><span style="color:#C99076">      UNARY_INVERT</span><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"><span style="color:#4C9A91">74</span><span style="color:#C99076">      UNARY_NEGATIVE</span><span style="color:#DBD7CAEE">                  </span></span>
<span class="line"><span style="color:#4C9A91">76</span><span style="color:#C99076">      BINARY_OP</span><span style="color:#4C9A91">                       0</span><span style="color:#666666"> (</span><span style="color:#CB7676">+</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4C9A91">80</span><span style="color:#C99076">      BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#4C9A91">82</span><span style="color:#C99076">      GET_LEN</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">84</span><span style="color:#C99076">      SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">86</span><span style="color:#C99076">      POP_TOP</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">88</span><span style="color:#C99076">      UNARY_INVERT</span><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"><span style="color:#4C9A91">90</span><span style="color:#C99076">      UNARY_NEGATIVE</span><span style="color:#DBD7CAEE">                  </span></span>
<span class="line"><span style="color:#4C9A91">92</span><span style="color:#C99076">      BINARY_OP</span><span style="color:#DBD7CAEE">    </span></span>
<span class="line"></span></code></pre>
<p>The pattern continues, accumulating the results of logical shifts and additions until producing a value of <code>18</code>.</p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p><strong>Python Stack</strong></p>
<table style="width:15%">
    <tbody><tr>
        <td>18</td>
    </tr>
    <tr>
        <td>str_locals_dict</td>
    </tr>
    <tr>
        <td>...</td>
    </tr>
</tbody></table>
</div>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">96</span><span style="color:#C99076">      BINARY_SUBSCR</span></span>
<span class="line"></span></code></pre>
<p>This operation is implemented as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">key </span><span style="color:#666666">=</span><span style="color:#C99076"> STACK</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">container </span><span style="color:#666666">=</span><span style="color:#C99076"> STACK</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#C99076">STACK</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">container</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">key</span><span style="color:#666666">])</span></span>
<span class="line"></span></code></pre>
<p>The top of the stack contains <code>18</code>, while the second-to-last element is the string value obtained from the locals dictionary. Hence, the bytecode accesses the 18th character of the string created from the locals variable. In this case, an <code>i</code>.</p>
<p>Then a store is perfomed on this value.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">100</span><span style="color:#C99076">     STORE_DEREF</span><span style="color:#4C9A91">                     7</span></span>
<span class="line"></span></code></pre>
<p>The <code>STORE_DEREF</code> instruction is defined as:</p>
<blockquote>
<p>Stores STACK.pop() into the cell contained in slot i of the “fast locals” storage.</p>
</blockquote>
<p>The bytecode continues with very similar operations, accessing different indexes of the locals dictionary and merging the obtained characters. Simply put, it builds a string using characters from the locals dictionary. After a series of these operations, the code successfully creates the string <code>input</code>.</p>
<p>Subsequently, it executes:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">562</span><span style="color:#C99076">     LOAD_DEREF</span><span style="color:#4C9A91">                      9</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#4C9A91">564</span><span style="color:#C99076">     LOAD_DEREF</span><span style="color:#4C9A91">                      7</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#4C9A91">566</span><span style="color:#C99076">     BINARY_SUBSCR</span></span>
<span class="line"><span style="color:#4C9A91">570</span><span style="color:#C99076">     PUSH_NULL</span></span>
<span class="line"><span style="color:#4C9A91">572</span><span style="color:#C99076">     SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">574</span><span style="color:#C99076">     CALL</span><span style="color:#4C9A91">                            0</span></span>
<span class="line"></span></code></pre>
<p>Hence, using the string built previously, the bytecode executes a call to the input function, thereby prompting the user for input.</p>
<h3 id="checking-the-flag">Checking the Flag</h3>
<p>Immediately after the call, the result of the <code>input</code> function call is stored in the <code>fast locals storage</code>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">584</span><span style="color:#C99076">     STORE_DEREF</span><span style="color:#4C9A91">                     10</span></span>
<span class="line"></span></code></pre>
<p>The bytecode then employs the same technique previously used to extract a character from the locals dictionary. We’ll omit the full bytecode and step-by-step explanation since it is identical to the one already performed.</p>
<p>We jump directly to the end of that segment of code:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">782</span><span style="color:#C99076">     STORE_DEREF</span><span style="color:#4C9A91">                     7</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#4C9A91">784</span><span style="color:#C99076">     LOAD_DEREF</span><span style="color:#4C9A91">                      7</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"></span></code></pre>
<p>This stores the obtained character and then loads it again, placing a reference to that value on top of the stack. In this case, the extracted character is an <code>h</code>, which is the first character of the flag format.</p>
<p>Then, the code continues as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">786</span><span style="color:#C99076">     BUILD_TUPLE</span><span style="color:#4C9A91">                     0</span></span>
<span class="line"><span style="color:#4C9A91">788</span><span style="color:#C99076">     GET_LEN</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">790</span><span style="color:#C99076">     SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">792</span><span style="color:#C99076">     POP_TOP</span><span style="color:#DBD7CAEE">                         </span></span>
<span class="line"><span style="color:#4C9A91">794</span><span style="color:#C99076">     LOAD_DEREF</span><span style="color:#4C9A91">                      10</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#4C9A91">796</span><span style="color:#C99076">     SWAP</span><span style="color:#4C9A91">                            2</span></span>
<span class="line"><span style="color:#4C9A91">798</span><span style="color:#C99076">     BINARY_SUBSCR</span><span style="color:#DBD7CAEE">                   </span></span>
<span class="line"></span></code></pre>
<p>This sequence is also familiar. It uses the same technique as before to compute a numerical value, then loads the previously stored user input from the <code>fast locals storage</code>, and uses the numerical value as an index. In this first case, as you might expect, it accesses the very first character of the input (index <code>0</code>).</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4C9A91">802</span><span style="color:#C99076">     COMPARE_OP</span><span style="color:#4C9A91">                      40</span><span style="color:#666666"> (</span><span style="color:#CB7676">==</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4C9A91">806</span><span style="color:#C99076">     POP_JUMP_IF_TRUE</span><span style="color:#4C9A91">                2</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">to </span><span style="color:#4C9A91">812</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4C9A91">808</span><span style="color:#C99076">     JUMP_BACKWARD</span><span style="color:#4C9A91">                   65535</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">to </span><span style="color:#CB7676">-</span><span style="color:#4C9A91">130258</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>A comparison operation then compares the two objects on top of the stack, which are string objects containing the first character of the user input and the letter <code>h</code>. If the comparison of these two objects is true—meaning the flag checking for the first character is correct—the code continues to execute a similar logic that checks the second character. Otherwise, a jump backward with a huge immediate value is performed. Since this immediate does not correspond to a valid memory location, the CPython interpreter will segfault. This explains why the segfault also occurs in the Docker environment.</p>
<p>If the entire flag is matched, at the very end, the bytecode employs the same technique to build the string <code>you passed</code>, and then it prints this string using the <code>CALL_INTRINSIC_1</code> opcode with the argument <code>INTRINSIC_PRINT</code>.</p>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://docs.python.org/3/library/dis.html">https://docs.python.org/3/library/dis.html</a></li>
</ul>
</div>
<h1 id="appendix-b-alternative-solutions">Appendix B: Alternative Solutions</h1>
<h3 id="side-channel">Side-channel</h3>
<p>This is actually the initial approach we took for this challenge. The <code>Tower of Hanoi</code> CTF team has a storied history in reverse engineering challenges involving guesswork and the use of side channels. Our initial idea was straightforward: use the dumper we previously explained to track the number of Python instructions executed. We hypothesized that for each correctly input character of the flag, this number would increase.</p>
<p><img src="/writeup_files/black-magic/stonks-worried-meme.png" alt="image"></p>
<p>We tested this method across all our systems, but it didn’t yield the expected results. We suspected that the failure was due the wrong environment where we were executing the side channel, although we did not know the specific reason yet. Consequently, we attempted to implement the same strategy within the Docker environment. However, we encountered obstacles trying to install libdebug there, primarily due to compilation errors with the C bindings it uses internally. Given these issues, we decided to adopt a more systematic approach, as detailed in this write-up.</p>
<p>Since the intersection between those of us writing this write-up and the maintainers of libdebug is not empty, as of this writing, libdebug has been made partially compatible with Alpine (just enough). This enhancement means we can now easily run our side-channel method and get the flag directly within the Docker environment.</p>
<p><img src="/writeup_files/black-magic/patching-libdebug.png" alt="image"></p>
<div class="markdown-alert markdown-alert-note" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>NOTE</p>
<p>When redirecting stdin to easily send the flag attempt from the script as the <code>.pyc</code> requests it, the internal execution flow of the call to the Python built-in function <code>input</code> changes compared to when the terminal is used. Generally, this is not a problem since it is managed internally by Python. However, in the specific case of this challenge, the <code>fast locals storage</code> (ab)used during bytecode execution will change according to the <code>input</code> execution flow, causing CPython to crash if the input is not provided by the console as expected. Therefore, we forced the accessed element of the <code>fast locals storage</code> to be the expected one during the side-channel attack. This was accomplished using a callback in libdebug.</p>
</div>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> libdebug </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> debugger</span></span>
<span class="line"><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Define the debugger once</span></span>
<span class="line"><span style="color:#DBD7CAEE">d </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> debugger</span><span style="color:#666666">([</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">python</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">a.pyc</span><span style="color:#C98A7D77">"</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">flag </span><span style="color:#666666">=</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> count_and_fix_locals</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">t</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> bp</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C98A7D77">    """</span><span style="color:#C98A7D">This callback serves two purposes:</span></span>
<span class="line"><span style="color:#C98A7D">    </span></span>
<span class="line"><span style="color:#C98A7D">    1. Count the number of times the breakpoint is hit</span></span>
<span class="line"><span style="color:#C98A7D">    2. Fix the fast locals storage to the expected value</span></span>
<span class="line"><span style="color:#C98A7D77">    """</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> bp</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hit_count </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 29</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#758575DD">        # At this point we should fix the fast locals storage</span></span>
<span class="line"><span style="color:#DBD7CAEE">        t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">regs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">rax </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> t</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">regs</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">r12 </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">2460</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">def</span><span style="color:#80A665"> run_and_get_hit_count</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ch</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#758575DD">    # Start the process</span></span>
<span class="line"><span style="color:#DBD7CAEE">    r </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">run</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">        </span></span>
<span class="line"><span style="color:#758575DD">    # Install the breakpoint on a strategic point during the STORE_DEREF opcode execution</span></span>
<span class="line"><span style="color:#758575DD">    # We both count the number of times the breakpoint is hit and fix the fast locals storage</span></span>
<span class="line"><span style="color:#DBD7CAEE">    bp </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">breakpoint</span><span style="color:#666666">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">11cca2</span><span style="color:#666666">,</span><span style="color:#BD976A"> file</span><span style="color:#666666">=</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">libpython</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> hardware</span><span style="color:#666666">=</span><span style="color:#4D9375">True</span><span style="color:#666666">,</span><span style="color:#BD976A"> callback</span><span style="color:#666666">=</span><span style="color:#DBD7CAEE">count_and_fix_locals</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">        </span></span>
<span class="line"><span style="color:#758575DD">    # Continue the process</span></span>
<span class="line"><span style="color:#DBD7CAEE">    d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">cont</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">    </span></span>
<span class="line"><span style="color:#758575DD">    # Send the flag attempt to the process</span></span>
<span class="line"><span style="color:#DBD7CAEE">    flag_attempt </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> flag </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> ch</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">    r</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag_attempt</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">            </span></span>
<span class="line"><span style="color:#758575DD">    # Wait for the end of the process</span></span>
<span class="line"><span style="color:#DBD7CAEE">    d</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">wait</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">        </span></span>
<span class="line"><span style="color:#758575DD">    # Return the hit count</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> bp</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hit_count</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Initialize the hit count using a wrong flag</span></span>
<span class="line"><span style="color:#DBD7CAEE">max_count </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> run_and_get_hit_count</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> ""</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">while</span><span style="color:#4D9375"> True</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">    found </span><span style="color:#666666">=</span><span style="color:#4D9375"> False</span></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> ch </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> string</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ascii_letters </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> string</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">digits </span><span style="color:#CB7676">+</span><span style="color:#C98A7D77"> "</span><span style="color:#C99076">{_}</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">        hit_count </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> run_and_get_hit_count</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">d</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> ch</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">                </span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> hit_count </span><span style="color:#CB7676">></span><span style="color:#DBD7CAEE"> max_count</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#758575DD">            # We have a new maximum hit count</span></span>
<span class="line"><span style="color:#758575DD">            # The character is part of the flag</span></span>
<span class="line"><span style="color:#DBD7CAEE">            found </span><span style="color:#666666">=</span><span style="color:#4D9375"> True</span></span>
<span class="line"><span style="color:#DBD7CAEE">            max_count </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> hit_count</span></span>
<span class="line"><span style="color:#DBD7CAEE">            flag </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> ch</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#B8A965">            print</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#666666">())</span></span>
<span class="line"><span style="color:#4D9375">            break</span></span>
<span class="line"><span style="color:#DBD7CAEE">    </span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#CB7676"> not</span><span style="color:#DBD7CAEE"> found</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#758575DD">        # We have reached the end of the flag</span></span>
<span class="line"><span style="color:#4D9375">        break</span></span>
<span class="line"></span></code></pre>
<h3 id="custom-python-interpreter">Custom Python Interpreter</h3>
<p>Even though the logic might appear complex, as you may have noticed, the bytecode repeatedly executes the same Python instructions for the entire flag checking process. This suggests how it is feasible to develop a custom interpreter that parses the opcodes and arguments from the <code>.pyc</code> file and simulates its execution.</p>
<p>The key factor to consider here is the necessity to initialize the locals dictionary in exactly the same way as it is in the Docker environment to achieve consistent results. For the implementation of our emulator logic, we relied on the Python documentation. This resource not only describes the meaning of the most common opcodes but often also provides snippets of code that correspond to the high-level operations performed by each instruction.</p>
<p>The final result of our emulator is as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> builtins</span></span>
<span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> importlib</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">machinery </span><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> SourcelessFileLoader</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">env_dict </span><span style="color:#666666">=</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__name__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">__main__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__doc__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__package__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__loader__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> SourcelessFileLoader</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">/app/src/a.pyc</span><span style="color:#C98A7D77">'</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__spec__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__annotations__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#666666"> {},</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__builtins__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> builtins</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__file__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">/app/src/a.pyc</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">    '</span><span style="color:#C98A7D">__cached__</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#4D9375"> None</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C99076">OP_MAP</span><span style="color:#666666"> =</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">57</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">LOAD_LOCALS</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">9b</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">FORMAT_VALUE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">66</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">BUILD_TUPLE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">1e</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">GET_LEN</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">63</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">SWAP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">1</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">POP_TOP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">f</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">UNARY_INVERT</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">b</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">UNARY_NEGATIVE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7a</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">BINARY_OP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">0</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">CACHE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">19</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">BINARY_SUBSCR</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">8a</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">STORE_DEREF</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">89</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">LOAD_DEREF</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">9d</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">BUILD_STRING</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">c</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">UNARY_NOT</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">2</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">PUSH_NULL</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">ab</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">CALL</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">6b</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">COMPARE_OP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">73</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">POP_JUMP_IF_TRUE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">ad</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">CALL_INTRINSIC_1</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">53</span><span style="color:#666666">:</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">RETURN_VALUE</span><span style="color:#C98A7D77">"</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">class</span><span style="color:#5DA994"> State</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#CB7676">    def</span><span style="color:#B8A965"> __init__</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">self</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> code</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> locals</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack </span><span style="color:#666666">=</span><span style="color:#666666"> []</span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">varnames </span><span style="color:#666666">=</span><span style="color:#666666"> [</span><span style="color:#4C9A91">0</span><span style="color:#666666">]</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91">64</span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">varnames</span><span style="color:#666666">[</span><span style="color:#4C9A91">9</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#666666"> {</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">input</span><span style="color:#C98A7D77">'</span><span style="color:#666666">:</span><span style="color:#B8A965">input</span><span style="color:#666666">}</span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> code</span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">locals </span><span style="color:#666666">=</span><span style="color:#B8A965"> locals</span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">flag </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">    def</span><span style="color:#80A665"> execute_next_instruction</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">self</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">        ret </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#DBD7CAEE">        opcode </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> code</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">        operand </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> code</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">        match</span><span style="color:#C99076"> OP_MAP</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">opcode</span><span style="color:#666666">]:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">LOAD_LOCALS</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">locals</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">FORMAT_VALUE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#B8A965">str</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">BUILD_TUPLE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                count </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> operand</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">                if</span><span style="color:#DBD7CAEE"> count </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    value </span><span style="color:#666666">=</span><span style="color:#666666"> ()</span></span>
<span class="line"><span style="color:#4D9375">                else</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    value </span><span style="color:#666666">=</span><span style="color:#B8A965"> tuple</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">:])</span></span>
<span class="line"><span style="color:#C99076">                    self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[:</span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE">count</span><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">value</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">GET_LEN</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#B8A965">len</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">SWAP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                i </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> operand</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">],</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">],</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">POP_TOP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">UNARY_INVERT</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#CB7676"> ~</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">UNARY_NEGATIVE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#CB7676"> -</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">BINARY_OP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                rhs </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">                lhs </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">                match</span><span style="color:#DBD7CAEE"> operand</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">                    case</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                        res </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> lhs </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> rhs</span></span>
<span class="line"><span style="color:#4D9375">                    case</span><span style="color:#4C9A91"> 3</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                        res </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> lhs </span><span style="color:#CB7676">&#x3C;&#x3C;</span><span style="color:#DBD7CAEE"> rhs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">                    case</span><span style="color:#DBD7CAEE"> _</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">                        print</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"No operation implemented for operand </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">operand</span><span style="color:#C99076">}</span><span style="color:#C98A7D">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">                        ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">res</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">BINARY_SUBSCR</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                key </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">                container </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">                try</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                    self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">container</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">key</span><span style="color:#666666">])</span></span>
<span class="line"><span style="color:#4D9375">                except</span><span style="color:#B8A965"> IndexError</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">                    raise</span><span style="color:#B8A965"> RuntimeError</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Access out of bounds during BINARY_SUBSCR. Did you enter a long enough input?</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">CACHE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#758575DD">                # Do nothing to simulate the Docker behavior</span></span>
<span class="line"><span style="color:#4D9375">                pass</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">STORE_DEREF</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">varnames</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">operand</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">LOAD_DEREF</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">varnames</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">operand</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">BUILD_STRING</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#C98A7D77">""</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">join</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE">operand</span><span style="color:#666666">:]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">UNARY_NOT</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#CB7676"> not</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">PUSH_NULL</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#4D9375">None</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">CALL</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                func </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> func</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#758575DD">                #self.stack[-1] = "hkcert24{provola}"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">COMPARE_OP</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#758575DD">                # Emulate the correct behavior for the comparison</span></span>
<span class="line"><span style="color:#C99076">                self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">append</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#CB7676"> ==</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">2</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">                # Force the comparison to be true and save the flag character</span></span>
<span class="line"><span style="color:#758575DD">                # self.flag += self.stack[-2]</span></span>
<span class="line"><span style="color:#758575DD">                # self.stack.append(True)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">POP_JUMP_IF_TRUE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                cond </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#4D9375">                if</span><span style="color:#DBD7CAEE"> cond</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#C99076">                    self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip </span><span style="color:#666666">+=</span><span style="color:#4C9A91"> 2</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> operand</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">CALL_INTRINSIC_1</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">                match</span><span style="color:#DBD7CAEE"> operand</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">                    case</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">                        print</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">                        # Simulate a 0 return value</span></span>
<span class="line"><span style="color:#C99076">                        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    </span></span>
<span class="line"><span style="color:#4D9375">                    case</span><span style="color:#DBD7CAEE"> _</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">                        print</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"CALL_INTRINSIC_1 with operand </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">operand</span><span style="color:#C99076">}</span><span style="color:#C98A7D"> not implemented"</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">RETURN_VALUE</span><span style="color:#C98A7D77">"</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">                ret </span><span style="color:#666666">=</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">pop</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">            </span></span>
<span class="line"><span style="color:#4D9375">            case</span><span style="color:#DBD7CAEE"> _</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">                print</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"Opcode </span><span style="color:#C99076">{</span><span style="color:#B8A965">hex</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">opcode</span><span style="color:#666666">)</span><span style="color:#C99076">}</span><span style="color:#C98A7D"> not implemented"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">                ret </span><span style="color:#666666">=</span><span style="color:#CB7676"> -</span><span style="color:#4C9A91">1</span></span>
<span class="line"><span style="color:#DBD7CAEE">        </span></span>
<span class="line"><span style="color:#C99076">        self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip </span><span style="color:#666666">+=</span><span style="color:#4C9A91"> 2</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> ret</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">    def</span><span style="color:#B8A965"> print</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">self</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">]</span><span style="color:#CB7676"> in</span><span style="color:#C99076"> OP_MAP</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">            print</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"ip: </span><span style="color:#C99076">{self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip</span><span style="color:#C99076">}</span><span style="color:#C98A7D">, next instruction: </span><span style="color:#C99076">{OP_MAP</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">]]</span><span style="color:#C99076">}</span><span style="color:#C99076"> {self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">]</span><span style="color:#C99076">}</span><span style="color:#C98A7D">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">        else</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#B8A965">            print</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">"ip: </span><span style="color:#C99076">{self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip</span><span style="color:#C99076">}</span><span style="color:#C98A7D">, next instruction: </span><span style="color:#C99076">{</span><span style="color:#B8A965">hex</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip</span><span style="color:#666666">])</span><span style="color:#C99076">}</span><span style="color:#C99076"> {self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">[</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">ip </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">]</span><span style="color:#C99076">}</span><span style="color:#C98A7D">"</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">varnames: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">varnames</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">flag = </span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C99076"> self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">        for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#666666">(</span><span style="color:#B8A965">len</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">)):</span></span>
<span class="line"><span style="color:#4D9375">                if</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">code</span><span style="color:#C98A7D77">"</span><span style="color:#CB7676"> in</span><span style="color:#B8A965"> str</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">]):</span></span>
<span class="line"><span style="color:#B8A965">                    print</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">LOCALS</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">                else</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#B8A965">                    print</span><span style="color:#666666">(</span><span style="color:#C99076">self</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">stack</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    </span></span>
<span class="line"><span style="color:#758575DD"># Load the code from the pyc file</span></span>
<span class="line"><span style="color:#4D9375">with</span><span style="color:#B8A965"> open</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">./src/a.pyc</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">rb</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">    code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">read</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Remove the header</span></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> code</span><span style="color:#666666">[</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">2a</span><span style="color:#666666">:]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Initialize the emulator</span></span>
<span class="line"><span style="color:#DBD7CAEE">state </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> State</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> env_dict</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">ret </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#4D9375">while</span><span style="color:#DBD7CAEE"> ret </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#758575DD">    # Print the current state of the emulation. Comment this line to clean the output</span></span>
<span class="line"><span style="color:#DBD7CAEE">    state</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">print</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    # Execute the next instruction</span></span>
<span class="line"><span style="color:#DBD7CAEE">    ret </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> state</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">execute_next_instruction</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    # Print the flag</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">state</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<div class="markdown-alert markdown-alert-tip" dir="auto">
<p class="markdown-alert-title" dir="auto"><svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>TIP</p>
<p><strong>Suggested Readings and Sources</strong></p>
<ul>
<li><a href="https://docs.python.org/3/library/dis.html">https://docs.python.org/3/library/dis.html</a></li>
</ul>
</div>
<h1 id="appendix-c-cache-in-the-time-of-python-313">Appendix C: CACHE in the time of Python 3.13</h1>
<p>It’s important to note that the behavior encountered during the challenge resolution would definitely have been different if the authors had chosen to use Python 3.13. Specifically, when analyzing the <code>CACHE</code> opcode implementation in the Python mainline at the time of writing, notable differences can be observed.</p>
<p>The implementation is as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#80A665">TARGET</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CACHE</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">    frame</span><span style="color:#666666">-></span><span style="color:#BD976A">instr_ptr</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> next_instr</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">    next_instr </span><span style="color:#CB7676">+=</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#80A665">    INSTRUCTION_STATS</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CACHE</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    assert</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#CB7676"> &#x26;&#x26;</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">Executing a cache.</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    Py_FatalError</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Executing a cache.</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    DISPATCH</span><span style="color:#666666">();</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>As shown, the macro <code>Py_UNREACHABLE()</code> has been replaced with <code>Py_FatalError()</code>, which logs the error, and the macro <code>DISPATCH()</code> has been added at the end. This adjustment makes the execution much more reliable and predictable in cases where, unexpectedly, the interpreter executes a <code>CACHE</code> opcode.</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 Tower of Hanoi. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Haoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>