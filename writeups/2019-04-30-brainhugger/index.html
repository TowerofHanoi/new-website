<!DOCTYPE html><html lang="en" data-astro-cid-dxom2xcl> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.18"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://localhost:3000/writeups/2019-04-30-brainhugger/"><!-- Primary Meta Tags --><title>RuCTF 2019 - Brainhugger</title><meta name="title" content="RuCTF 2019 - Brainhugger"><meta name="description" content="How to completely ignore half of a challenge and still win."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://localhost:3000/writeups/2019-04-30-brainhugger/"><meta property="og:title" content="RuCTF 2019 - Brainhugger"><meta property="og:description" content="How to completely ignore half of a challenge and still win."><meta property="og:image" content="https://localhost:3000/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://localhost:3000/writeups/2019-04-30-brainhugger/"><meta property="twitter:title" content="RuCTF 2019 - Brainhugger"><meta property="twitter:description" content="How to completely ignore half of a challenge and still win."><meta property="twitter:image" content="https://localhost:3000/blog-placeholder-1.jpg"><style>:root{--accent: #fea819;--accent-dark: #ac7010;--accent-dark-010: #ac70100a}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:#171717 no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:#aaa;font-size:20px;line-height:1.25}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:1em 0 .5rem;color:#fff;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:0 .3em;background-color:#1f1f1f;border-radius:.2em;font-size:.8em}pre{padding:1em;border-radius:.2em}pre>code{all:unset;font-size:.8em}blockquote{border-left:4px solid var(--accent);padding:.01em 0 .01em 1em;margin:0;background-color:var(--accent-dark-010)}hr{border:none;border-top:1px solid #e9e9e9}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#1f1f1f;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
main[data-astro-cid-dxom2xcl]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-dxom2xcl]{width:100%}.hero-image[data-astro-cid-dxom2xcl] img[data-astro-cid-dxom2xcl]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-dxom2xcl]{width:75%;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-dxom2xcl]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-dxom2xcl] h1[data-astro-cid-dxom2xcl]{margin:0 0 .5em}.date[data-astro-cid-dxom2xcl]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-dxom2xcl]{font-style:italic}
</style></head> <body data-astro-cid-dxom2xcl> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <a href="/" style="padding: 1rem 0 0 0;" data-astro-cid-3ef6ksr2> <img src="/new_tower_logo.png" alt="Tower of Hanoi Logo" width="50rem" height="50rem" style="border-radius: 0;" data-astro-cid-3ef6ksr2> </a> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blogposts </a>  <a href="/writeups" class="active" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Writeups </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-dxom2xcl> <article data-astro-cid-dxom2xcl> <div class="hero-image" data-astro-cid-dxom2xcl> <img width="720" height="360" src="/writeup_images/ru2019.png" alt="" data-astro-cid-dxom2xcl> </div> <div class="prose" data-astro-cid-dxom2xcl> <div class="title" data-astro-cid-dxom2xcl> <div class="date" data-astro-cid-dxom2xcl> <time datetime="2019-04-29T22:00:00.000Z"> Apr 30, 2019 </time>  </div> <h1 data-astro-cid-dxom2xcl>RuCTF 2019 - Brainhugger</h1> <h3 data-astro-cid-dxom2xcl> by Pietro Ferretti</h3> <hr data-astro-cid-dxom2xcl> </div>  <h1 id="brainhugger-ructf-2019">Brainhugger (RuCTF 2019)</h1>
<p>The <code>brainhugger</code> challenge at RuCTF 2019 was a simple REST API written in Go, which allowed users to register and run code written in Brainfuck.</p>
<p>Exploiting this challenge was crucial for our victory at RuCTF 2019, as most of the points we made were on this challenge.</p>
<p>The application offered four backend endpoints:</p>
<ul>
<li><code>/register</code>: register a user with a password (a flag), receive a <code>secret</code> cookie used for authentication and a progressive counter (uid)</li>
<li><code>/login</code>: use the password to get your auth cookie</li>
<li><code>/runTask</code>: run brainfuck code, identified with a token (a flag)</li>
<li><code>/taskInfo</code>: get the result of the brainfuck task corresponding to a token</li>
</ul>
<h2 id="weaponized-solution">Weaponized solution</h2>
<h3 id="stealing-cookies">Stealing cookies</h3>
<p>The <code>secret</code> cookie is generated directly from the password provided at registration (the password is the flag) by encrypting it with a custom CBC-mode block cipher. Since the plaintext contains the flag, we’d like to recover the cookie if possible.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#BD976A">	plainSecret</span><span style="color:#666666"> :=</span><span style="color:#BD976A"> fmt</span><span style="color:#666666">.</span><span style="color:#80A665">Sprintf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%v</span><span style="color:#C98A7D">|</span><span style="color:#C99076">%v</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#BD976A"> usersCount</span><span style="color:#666666">,</span><span style="color:#BD976A"> password</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#BD976A">	encryptedSecret</span><span style="color:#666666">,</span><span style="color:#BD976A"> err</span><span style="color:#666666"> :=</span><span style="color:#BD976A"> cbc</span><span style="color:#666666">.</span><span style="color:#80A665">Encrypt</span><span style="color:#666666">(</span><span style="color:#BD976A">key</span><span style="color:#666666">,</span><span style="color:#666666"> []</span><span style="color:#CB7676">byte</span><span style="color:#666666">(</span><span style="color:#BD976A">plainSecret</span><span style="color:#666666">))</span></span>
<span class="line"></span></code></pre>
<p>After registration a user may login with their uid and password, and if the password matches the one saved in storage the application will set the same <code>secret</code> cookie generated during registration.</p>
<p>The vulnerability lies in the login logic: the application behaves peculiarly if the cookies are already set when making a request to the endpoint. If the cookies are present in the request, the application will, in order:</p>
<ol>
<li>Check if the cookies are a valid <code>secret</code> and <code>uid</code> pair, i.e. they are valid credentials for an existing user;</li>
<li>If the cookies are ok, reset the <code>secret</code> cookie to the one corresponding to the uid passed in the response <em>body</em>, whichever it is.</li>
</ol>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#4D9375">func</span><span style="color:#80A665"> handleLoginUser</span><span style="color:#666666">(</span><span style="color:#BD976A">w</span><span style="color:#5DA994"> http</span><span style="color:#666666">.</span><span style="color:#5DA994">ResponseWriter</span><span style="color:#666666">,</span><span style="color:#BD976A"> r</span><span style="color:#CB7676"> *</span><span style="color:#5DA994">http</span><span style="color:#666666">.</span><span style="color:#5DA994">Request</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">	data</span><span style="color:#666666">,</span><span style="color:#BD976A"> err</span><span style="color:#666666"> :=</span><span style="color:#BD976A"> ioutil</span><span style="color:#666666">.</span><span style="color:#80A665">ReadAll</span><span style="color:#666666">(</span><span style="color:#BD976A">r</span><span style="color:#666666">.</span><span style="color:#BD976A">Body</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">	if</span><span style="color:#BD976A"> err</span><span style="color:#CB7676"> !=</span><span style="color:#CB7676"> nil</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">		w</span><span style="color:#666666">.</span><span style="color:#80A665">WriteHeader</span><span style="color:#666666">(</span><span style="color:#4C9A91">400</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">		return</span></span>
<span class="line"><span style="color:#666666">	}</span></span>
<span class="line"><span style="color:#4D9375">	var</span><span style="color:#BD976A"> loginUser</span><span style="color:#5DA994"> LoginUser</span></span>
<span class="line"><span style="color:#BD976A">	err</span><span style="color:#666666"> =</span><span style="color:#BD976A"> json</span><span style="color:#666666">.</span><span style="color:#80A665">Unmarshal</span><span style="color:#666666">(</span><span style="color:#BD976A">data</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#BD976A">loginUser</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">	[</span><span style="color:#CB7676">...</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#4D9375">	if</span><span style="color:#80A665"> len</span><span style="color:#666666">(</span><span style="color:#BD976A">r</span><span style="color:#666666">.</span><span style="color:#80A665">Cookies</span><span style="color:#666666">())</span><span style="color:#CB7676"> !=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">		ok</span><span style="color:#666666">,</span><span style="color:#BD976A"> _</span><span style="color:#666666">,</span><span style="color:#BD976A"> err</span><span style="color:#666666"> :=</span><span style="color:#BD976A"> usersManager</span><span style="color:#666666">.</span><span style="color:#80A665">ValidateCookies</span><span style="color:#666666">(</span><span style="color:#BD976A">r</span><span style="color:#666666">.</span><span style="color:#80A665">Cookies</span><span style="color:#666666">())</span><span style="color:#758575DD">  // only checks if the cookies are valid</span></span>
<span class="line"><span style="color:#4D9375">		if</span><span style="color:#BD976A"> err</span><span style="color:#CB7676"> !=</span><span style="color:#CB7676"> nil</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">			w</span><span style="color:#666666">.</span><span style="color:#80A665">WriteHeader</span><span style="color:#666666">(</span><span style="color:#4C9A91">400</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">			return</span></span>
<span class="line"><span style="color:#666666">		}</span></span>
<span class="line"><span style="color:#4D9375">		if</span><span style="color:#BD976A"> ok</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">			secret</span><span style="color:#666666">,</span><span style="color:#BD976A"> err</span><span style="color:#666666"> :=</span><span style="color:#BD976A"> usersManager</span><span style="color:#666666">.</span><span style="color:#80A665">GetForCookie</span><span style="color:#666666">(</span><span style="color:#BD976A">loginUser</span><span style="color:#666666">.</span><span style="color:#BD976A">UserId</span><span style="color:#666666">)</span><span style="color:#758575DD">  // returns the cookie for the uid in the request body</span></span>
<span class="line"><span style="color:#4D9375">			if</span><span style="color:#BD976A"> err</span><span style="color:#CB7676"> !=</span><span style="color:#CB7676"> nil</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">				w</span><span style="color:#666666">.</span><span style="color:#80A665">WriteHeader</span><span style="color:#666666">(</span><span style="color:#4C9A91">400</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">				return</span></span>
<span class="line"><span style="color:#666666">			}</span></span>
<span class="line"><span style="color:#BD976A">			http</span><span style="color:#666666">.</span><span style="color:#80A665">SetCookie</span><span style="color:#666666">(</span><span style="color:#BD976A">w</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#5DA994">http</span><span style="color:#666666">.</span><span style="color:#5DA994">Cookie</span><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#BD976A">				Name</span><span style="color:#666666">:</span><span style="color:#C98A7D77">  "</span><span style="color:#C98A7D">secret</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#BD976A">				Value</span><span style="color:#666666">:</span><span style="color:#BD976A"> secret</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#666666">			})</span></span>
<span class="line"><span style="color:#BD976A">			http</span><span style="color:#666666">.</span><span style="color:#80A665">SetCookie</span><span style="color:#666666">(</span><span style="color:#BD976A">w</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#5DA994">http</span><span style="color:#666666">.</span><span style="color:#5DA994">Cookie</span><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#BD976A">				Name</span><span style="color:#666666">:</span><span style="color:#C98A7D77">  "</span><span style="color:#C98A7D">uid</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#BD976A">				Value</span><span style="color:#666666">:</span><span style="color:#BD976A"> fmt</span><span style="color:#666666">.</span><span style="color:#80A665">Sprint</span><span style="color:#666666">(</span><span style="color:#BD976A">loginUser</span><span style="color:#666666">.</span><span style="color:#BD976A">UserId</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#666666">			})</span></span>
<span class="line"><span style="color:#4D9375">			return</span></span>
<span class="line"><span style="color:#666666">		}</span></span>
<span class="line"><span style="color:#666666">	}</span></span>
<span class="line"></span></code></pre>
<p>By making a request to the login endpoint using the cookies of a user we registered and using a different uid in the request body, we can recover the <code>secret</code> cookie for any user we want.</p>
<p>The patch:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>--- backend/main.go	(date 1556446794000)</span></span>
<span class="line"><span>+++ backend/main.go	(date 1556446794000)</span></span>
<span class="line"><span>@@ -168,7 +168,12 @@</span></span>
<span class="line"><span> 			return</span></span>
<span class="line"><span> 		}</span></span>
<span class="line"><span> 		if ok {</span></span>
<span class="line"><span>-			secret, err := usersManager.GetForCookie(loginUser.UserId)</span></span>
<span class="line"><span>+			userId, _, err := usersManager.GetFromCookie(r.Cookies())</span></span>
<span class="line"><span>+			if err != nil {</span></span>
<span class="line"><span>+				w.WriteHeader(400)</span></span>
<span class="line"><span>+				return</span></span>
<span class="line"><span>+			}</span></span>
<span class="line"><span>+			secret, err := usersManager.GetForCookie(userId)</span></span>
<span class="line"><span> 			if err != nil {</span></span>
<span class="line"><span> 				w.WriteHeader(400)</span></span>
<span class="line"><span> 				return</span></span>
<span class="line"><span></span></span></code></pre>
<h3 id="decrypting-the-cookie-using-predictable-keys">Decrypting the cookie using predictable keys</h3>
<p><strong>Note:</strong> despite its simplicity, this vulnerability seems to be unintended by the challenge creators. The <a href="https://github.com/HackerDom/ructf-2019/blob/master/sploits/brainhugger/writeup.md">official writeup</a> does not mention it, and focuses instead on the padding oracle attack.</p>
<p>The cookie was generated using a custom algorithm. Even without delving into the shifting, xoring and shuffling, the straightest approach is to check if the encryption key is fixed or somewhat predictable.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#BD976A">	userId</span><span style="color:#666666">,</span><span style="color:#BD976A"> cookie</span><span style="color:#666666">,</span><span style="color:#BD976A"> err</span><span style="color:#666666"> :=</span><span style="color:#BD976A"> usersManager</span><span style="color:#666666">.</span><span style="color:#80A665">AddUser</span><span style="color:#666666">(</span><span style="color:#BD976A">newUser</span><span style="color:#666666">.</span><span style="color:#BD976A">Password</span><span style="color:#666666">,</span><span style="color:#BD976A"> cbc</span><span style="color:#666666">.</span><span style="color:#80A665">GenerateKey</span><span style="color:#666666">())</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#4D9375">func</span><span style="color:#80A665"> GenerateKey</span><span style="color:#666666">()</span><span style="color:#666666"> []</span><span style="color:#CB7676">byte</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">	key</span><span style="color:#666666"> :=</span><span style="color:#80A665"> make</span><span style="color:#666666">([]</span><span style="color:#CB7676">byte</span><span style="color:#666666">,</span><span style="color:#BD976A"> KeySize</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">	for</span><span style="color:#BD976A"> i</span><span style="color:#666666"> :=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span><span style="color:#BD976A"> i</span><span style="color:#CB7676"> &#x3C;</span><span style="color:#BD976A"> KeySize</span><span style="color:#666666">;</span><span style="color:#BD976A"> i</span><span style="color:#CB7676">++</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">		key</span><span style="color:#666666">[</span><span style="color:#BD976A">i</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#CB7676"> byte</span><span style="color:#666666">(</span><span style="color:#BD976A">i</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">	}</span></span>
<span class="line"><span style="color:#BD976A">	rand</span><span style="color:#666666">.</span><span style="color:#80A665">Shuffle</span><span style="color:#666666">(</span><span style="color:#BD976A">KeySize</span><span style="color:#666666">,</span><span style="color:#4D9375"> func</span><span style="color:#666666">(</span><span style="color:#BD976A">i</span><span style="color:#666666">,</span><span style="color:#BD976A"> j</span><span style="color:#CB7676"> int</span><span style="color:#666666">)</span><span style="color:#666666"> {</span><span style="color:#BD976A"> key</span><span style="color:#666666">[</span><span style="color:#BD976A">i</span><span style="color:#666666">],</span><span style="color:#BD976A"> key</span><span style="color:#666666">[</span><span style="color:#BD976A">j</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#BD976A"> key</span><span style="color:#666666">[</span><span style="color:#BD976A">j</span><span style="color:#666666">],</span><span style="color:#BD976A"> key</span><span style="color:#666666">[</span><span style="color:#BD976A">i</span><span style="color:#666666">]</span><span style="color:#666666"> })</span></span>
<span class="line"><span style="color:#4D9375">	return</span><span style="color:#BD976A"> key</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>A quick check immediately shows an issue: the <code>GenerateKey</code> function calls <code>rand.Shuffle</code>, but the seed for the PRNG is never initialized in the whole application. This means that the keys generated for every instance of the program, for every team, will be the same! We can easily list them by repeatedly calling <code>GenerateKey</code>.</p>
<p>To make it even easier, the only call to the <code>rand</code> package in the whole application is at registration. Since each user is identified by a progressive uid, we immediately know the key that was used at registration (provided that the application was not restarted), i.e. the key for the user with uid <code>100</code> is the result of the 100th call to the <code>GenerateKey</code> function.</p>
<p>This vulnerability is very easy to patch, we just need to add a call to <code>rand.Seed</code>.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>--- backend/main.go	(date 1556446794000)</span></span>
<span class="line"><span>+++ backend/main.go	(date 1556446794000)</span></span>
<span class="line"><span>@@ -9,6 +9,8 @@</span></span>
<span class="line"><span> 	"log"</span></span>
<span class="line"><span> 	"net/http"</span></span>
<span class="line"><span> 	"strconv"</span></span>
<span class="line"><span>+	"math/rand"</span></span>
<span class="line"><span>+	"time"</span></span>
<span class="line"><span> )</span></span>
<span class="line"><span> </span></span>
<span class="line"><span> var taskManager TasksManager</span></span>
<span class="line"><span>@@ -208,6 +215,7 @@</span></span>
<span class="line"><span> 	if err != nil {</span></span>
<span class="line"><span> 		panic("can not parse config: " + err.Error())</span></span>
<span class="line"><span> 	}</span></span>
<span class="line"><span>+	rand.Seed(time.Now().UTC().UnixNano())</span></span>
<span class="line"><span> 	if err := taskManager.Init(config.TasksDir, config.BrainHugExecutorPath, config.MaxItemsCount); err != nil {</span></span>
<span class="line"><span> 		panic(err)</span></span>
<span class="line"><span> 	}</span></span>
<span class="line"><span></span></span></code></pre>
<h3 id="writing-the-exploit">Writing the exploit</h3>
<p>By combining the previous two vulnerabilities, we can recover flags from the application in two easy steps:</p>
<ol>
<li>Get the cookie for a user registered by the checksystem;</li>
<li>Decrypt the cookie using the keys that we know will be generated by the PRNG.</li>
</ol>
<p>Our exploit was written in Python, but since we already have an implementation of the decryption for the application’s custom algorithm written in Go, we reused the application code to write a simple executable to decrypt the cookies.</p>
<p>You can find the Python exploit <a href="/writeup_files/brainhugger/exploit.py">here</a> and the decryption program <a href="/writeup_files/brainhugger/dec.go">here</a>.</p>
<p>Since the flag was exfiltrated as ciphertext and decrypted locally using only two clean requests, the attack was likely hard to detect, and impossible to replicate. This was a big factor in the success of the exploit, which still worked on many teams even up to the end.</p>
<h2 id="other-weaknesses">Other weaknesses</h2>
<p>There are more weaknesses and vulnerabilities that we found but we didn’t think were worth the effort of weaponizing, since patching them were quite easy and the previous exploit was working really well.</p>
<h3 id="padding-oracle-on-the-login-endpoint">Padding oracle on the login endpoint</h3>
<p>The flags were encrypted in CBC mode, the encryption was malleable (we could edit the plaintext by flipping bits in the ciphertext) and there was no integrity checking.
From our experience with AES, we knew that given these conditions a padding oracle attack was a good candidate for a vulnerability.</p>
<p>Long story short: as long as an exposed application can tell any user whether the plaintext is padded correctly after decryption of a ciphertext given by the attacker, an attacker can use the little information that was revealed about the plaintext to recover the whole plaintext with multiple requests.</p>
<p>And this was the case. On the login endpoint, as long as we passed well-formed requests and cookies, the application would return 400 if any error happened during decryption, and 403 if the plaintext didn’t match the password (i.e. the plaintext is padded correctly).</p>
<p>Exploiting this vulnerability required the same cookie stealing vulnerability as the previous exploit, so we decided it wasn’t worth the effort of adapting the attack for the custom encryption algorithm (we would only need it for teams that patched the seed but not the cookie stealing vuln, unlikely).</p>
<p>Since we had already patched the cookie exfiltration vulnerability, patching the padding oracle was not necessary. Anyway, better be safe than sorry. We patched it by making the app return the same result in all cases of failure.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>--- backend/main.go	(date 1556446794000)</span></span>
<span class="line"><span>+++ backend/main.go	(date 1556446794000)</span></span>
<span class="line"><span>@@ -197,7 +204,7 @@</span></span>
<span class="line"><span> 			Value: fmt.Sprint(loginUser.UserId),</span></span>
<span class="line"><span> 		})</span></span>
<span class="line"><span> 	} else {</span></span>
<span class="line"><span>-		w.WriteHeader(403)</span></span>
<span class="line"><span>+		w.WriteHeader(400)</span></span>
<span class="line"><span> 		return</span></span>
<span class="line"><span> 	}</span></span>
<span class="line"><span> 	w.WriteHeader(200)</span></span>
<span class="line"><span></span></span></code></pre>
<h3 id="the-brainfuck-interpreter">The brainfuck interpreter</h3>
<p>I’ll be honest: we never actually tried to understand how the interpreter worked and which bugs it had.</p>
<p>The fact that it was vulnerable was obvious since the executable was compiled without a stack canary:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>all:</span></span>
<span class="line"><span>	if test -f bhexecutor.notc; then gcc -g -O0 -fno-stack-protector -x c bhexecutor.notc -o bhexecutor; fi</span></span>
<span class="line"><span></span></span></code></pre>
<p>We opened it once to check it out, and one of the weaknesses was spelled out clear as day: if a specific parameter wasn’t passed as argument, the binary restarted itself with ASLR disabled.</p>
<p>We added the argument to the call to the binary and we called it a day.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>--- backend/bhexecutor/bhexecutor.go	(date 1556438428000)</span></span>
<span class="line"><span>+++ backend/bhexecutor/bhexecutor.go	(date 1556438428000)</span></span>
<span class="line"><span>@@ -15,7 +14,7 @@</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span> </span></span>
<span class="line"><span> func (bhExecutor *BhExecutor) RunBhCode(code string, input []byte, maxOperations uint) ([]byte, error) {</span></span>
<span class="line"><span>-	cmd := exec.Command(bhExecutor.BinPath, code)</span></span>
<span class="line"><span>+	cmd := exec.Command(bhExecutor.BinPath, "hhfg", code)</span></span>
<span class="line"><span> 	stdout := &#x26;bytes.Buffer{}</span></span>
<span class="line"><span> 	stdin := &#x26;bytes.Buffer{}</span></span>
<span class="line"><span> 	stderr := &#x26;bytes.Buffer{}</span></span>
<span class="line"><span></span></span></code></pre>
<h3 id="exfiltration-from-static">Exfiltration from /static</h3>
<p>We never actually patched the vulnerable brainfuck interpreter (apart from the ASLR check), so a handful of exploits passed through.</p>
<p>The firewall handled the reverse shells, but a specific exploit exfiltrated the flags in a different way. First it would read the flags from the files on the sistem, then save the contents to a chosen file. The magic was that the file was saved to the frontend’s /static/ folder, the contents of which were by default returned for any request to the /static endpoint on the frontend.</p>
<p>Luckily the config file included a really convenient “StaticDir” option to change the directory used to serve static files. Since there is no way to know which directory the application was actually using, any files that would be created with the exploit would be inaccessible.</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Tower of Hanoi. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Haoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>